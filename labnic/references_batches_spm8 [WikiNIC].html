<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr" lang="en"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>
    references:batches_spm8    [WikiNIC]
  </title>

  <meta name="generator" content="DokuWiki">
<meta name="robots" content="index,follow">
<meta name="date" content="2012-05-04T16:42:53+0200">
<meta name="keywords" content="references,batches_spm8">
<link rel="search" type="application/opensearchdescription+xml" href="http://labnic.unige.ch/wiki/lib/exe/opensearch.php" title="WikiNIC">
<link rel="start" href="http://labnic.unige.ch/wiki/">
<link rel="contents" href="http://labnic.unige.ch/wiki/doku.php?id=references:batches_spm8&amp;do=index" title="Sitemap">
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="http://labnic.unige.ch/wiki/feed.php">
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://labnic.unige.ch/wiki/feed.php?mode=list&amp;ns=references">
<link rel="edit" title="Edit this page" href="http://labnic.unige.ch/wiki/doku.php?id=references:batches_spm8&amp;do=edit">
<link rel="alternate" type="text/html" title="Plain HTML" href="http://labnic.unige.ch/wiki/doku.php?do=export_xhtml&amp;id=references:batches_spm8">
<link rel="alternate" type="text/plain" title="Wiki Markup" href="http://labnic.unige.ch/wiki/doku.php?do=export_raw&amp;id=references:batches_spm8">
<link rel="canonical" href="http://labnic.unige.ch/wiki/doku.php?id=references:batches_spm8">
<link rel="stylesheet" media="screen" type="text/css" href="references_batches_spm8%20%5BWikiNIC%5D_fichiers/css.css">
<link rel="stylesheet" media="all" type="text/css" href="references_batches_spm8%20%5BWikiNIC%5D_fichiers/css_003.css">
<link rel="stylesheet" media="print" type="text/css" href="references_batches_spm8%20%5BWikiNIC%5D_fichiers/css_002.css">
<script type="text/javascript"><!--//--><![CDATA[//><!--
var NS='references';var SIG=' --- //[[karim.ndiaye@cisa.unige.ch|Karim N\'Diaye]] 2013/03/26 01:37//';var JSINFO = {"id":"references:batches_spm8","namespace":"references"};
//--><!]]></script>
<script type="text/javascript" charset="utf-8" src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/js.js"></script><style type="text/css" media="screen"><!--/*--><![CDATA[/*><!--*/ .folded.hidden { display: none; } .folder .indicator { **display: block;** visibility: visible; } /*]]>*/--></style>

  <link rel="shortcut icon" href="http://labnic.unige.ch/wiki/lib/tpl/default/images/favicon.ico">

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="http://labnic.unige.ch/wiki/doku.php?id=references:batches_spm8&amp;do=backlink" title="Backlinks">references:batches_spm8</a>]]
      </div>
      <div class="logo">
        <a href="http://labnic.unige.ch/wiki/doku.php" name="dokuwiki__top" id="dokuwiki__top" accesskey="h" title="[H]">WikiNIC</a>      </div>

      <div class="clearer"></div>
    </div>

    
    <div class="bar" id="bar__top">
      <div class="bar-left" id="bar__topleft">
        <form class="button btn_edit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit this page" class="button" accesskey="e" title="Edit this page [E]" type="submit"></div></form>        <form class="button btn_revs" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="revisions" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Old revisions" class="button" accesskey="o" title="Old revisions [O]" type="submit"></div></form>      </div>

      <div class="bar-right" id="bar__topright">
        <form class="button btn_recent" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="recent" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Recent changes" class="button" accesskey="r" title="Recent changes [R]" type="submit"></div></form>        <form action="/wiki/doku.php" accept-charset="utf-8" class="search" id="dw__search" method="get"><div class="no"><input name="do" value="search" type="hidden"><input id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" type="text"><input value="Search" class="button" title="Search" type="submit"><div style="display: none;" id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>&nbsp;
      </div>

      <div class="clearer"></div>
    </div>

    
        <div class="breadcrumbs">
      <span class="bchead">You are here: </span><a href="http://labnic.unige.ch/wiki/doku.php?id=start" title="start">start</a> » <a href="http://labnic.unige.ch/wiki/doku.php?id=references:start" title="references:start">references</a> » <a href="http://labnic.unige.ch/wiki/doku.php?id=references:batches_spm8" title="references:batches_spm8">batches_spm8</a>    </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <!-- TOC START -->
<div class="toc">
<div style="cursor: pointer;" class="tocheader toctoggle" id="toc__header"><span class="toc_close" style="cursor: pointer;" id="toc__toggle"><span>−</span></span>Table of Contents</div>
<div id="toc__inside">

<ul class="toc">
<li class="clear">

<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="#import_your_data" class="toc">Import your data</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#convert_nifti_to_old_analyze_format" class="toc">Convert NIFTI to old Analyze format</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#preprocessing" class="toc">Preprocessing</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#first_level_analysis" class="toc">First Level Analysis</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#first_level_contrasts" class="toc">First Level Contrasts</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#second_level_analysis" class="toc">Second Level Analysis</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#note_on_sphericity_correction_in_spm_2nd_level_analyses" class="toc">Note on sphericity correction in SPM 2nd level analyses</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#plotting_spheres_instead_of_voxels" class="toc">Plotting spheres instead of voxels</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#beta_extraction" class="toc">Beta Extraction</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#code_snippets" class="toc">Code Snippets</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#image_calculator" class="toc">Image Calculator</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#moving_data_or_spmmat" class="toc">Moving Data or SPM.mat</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#read_eprime_text_files" class="toc">Read Eprime text files</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#several_spm_versions" class="toc">Several SPM Versions</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#matlab_figure_in_pdf" class="toc">Matlab figure in PDF</a></span></div></li></ul>
</li></ul>
</li></ul>
</div>
</div>
<!-- TOC END -->

<h2 class="sectionedit1"><a name="import_your_data" id="import_your_data">Import your data</a></h2>
<div class="level2">
<p><a title="reveal" class="folder " href="#folded_1"> use this function for converting your data and save it as swr_import_DICOM.m</a></p><div class="folded  hidden" id="folded_1">

<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=0" title="Download Snippet" class="mediafile mf_m">swr_import_DICOM.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> swr_import_DICOM<span class="br0">(</span>source_directory, target_directory<span class="br0">)</span>
<span class="co1">%</span>
<span class="co1">% This function attempts to find all DICOM files in the specified source</span>
<span class="co1">% directory and all its (sub-sub-...)-directiories, perform a conversion to</span>
<span class="co1">% NIfTI format using SPM5 functions, and place the NIfTI files in</span>
<span class="co1">% appropriately named folders which will be created in the specified target</span>
<span class="co1">% directory. If no directories are specified, the user will be prompted for</span>
<span class="co1">% directory names.</span>
<span class="co1">%</span>
<span class="co1">% If there are too many (i.e. thousands) DICOM files in one single</span>
<span class="co1">% directory (which is unlikely to be the case with DICOM compliant storage,</span>
<span class="co1">% except if you scan someone for hours without a break), this routine may</span>
<span class="co1">% cause MatLab to run out of memory and crash. I might think about fixing</span>
<span class="co1">% this in a later version if it turns out to be a problem in real life.</span>
<span class="co1">% </span>
<span class="co1">% Sebastian W Rieger - LabNIC, Geneva University - 2008-09-02</span>
<span class="co1">% </span>
&nbsp;
&nbsp;
<span class="co1">% If the function was called without input arguments, use a dialog box to</span>
<span class="co1">% ask the user for the directory names:</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 1
    source_directory = uigetdir<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>, <span class="sy0">...</span>
        <span class="co2">'Select directory to be searched for DICOM files:'</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 2
    target_directory = uigetdir<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>, <span class="sy0">...</span>
        <span class="co2">'Select target directory for NIfTI files:'</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Start stopwatch and initialise file counter:</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/tic.html"><span class="kw2">tic</span></a>;
DICOM_file_counter = <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'Starting swr_import_DICOM...'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% Remember the current working directory:</span>
previous_working_directory = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>;
&nbsp;
<span class="co1">% Create the target directory, if it does not already exist:</span>
<span class="kw1">if</span> ~isdir<span class="br0">(</span>target_directory<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'swr_import_DICOM: Creating target directory ('</span> <span class="sy0">...</span>
        <span class="me1">target_directory</span> <span class="co2">')...'</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span>target_directory<span class="br0">)</span>;
<span class="kw1">else</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'swr_import_DICOM: Target directory '</span> target_directory <span class="sy0">...</span>
        <span class="co2">' already exists.'</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'Existing files in target directory may be overwritten!'</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Change working directory to target directory:</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>target_directory<span class="br0">)</span>;
&nbsp;
<span class="co1">% Generate a list of all (sub-sub-...)directories of the source directory, </span>
<span class="co1">% which will be searched for DICOM files:</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'swr_import_DICOM: Looking for source directory ('</span> <span class="sy0">...</span>
    <span class="me1">source_directory</span> <span class="co2">')'</span><span class="br0">]</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'and its sub-directories...'</span><span class="br0">)</span>
source_dir_list = find_sub_directories<span class="br0">(</span>source_directory<span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>source_dir_list<span class="br0">)</span><span class="br0">)</span> <span class="co2">' directories found.'</span><span class="br0">]</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% Repeat for each directory in the list:</span>
<span class="kw1">for</span> dir_index = 1 : <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>source_dir_list<span class="br0">)</span>
&nbsp;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'swr_import_DICOM: Searching files in directory '</span> <span class="sy0">...</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>dir_index<span class="br0">)</span> <span class="co2">' / '</span> <span class="sy0">...</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>source_dir_list<span class="br0">)</span><span class="br0">)</span> <span class="co2">'...'</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% Create a list of all file names in the directory:</span>
    DICOM_file_names = list_full_files<span class="br0">(</span>source_dir_list<span class="br0">{</span>dir_index<span class="br0">}</span>, <span class="co2">'*.*'</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>DICOM_file_names, <span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">' file(s) found.'</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% Create list of DICOM file headers from list of file names:</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'swr_import_DICOM: Attempting to read DICOM headers...'</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% Turn off warnings but remember current warning status first:</span>
    previous_warning_status = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'off'</span>, <span class="co2">'all'</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% Attempt to read DICOM headers, using strvcat to convert the cell</span>
    <span class="co1">% array of file names into a matrix as needed by the SPM5 function</span>
    <span class="co1">% spm_dicom_headers:</span>
    DICOM_headers = spm_dicom_headers<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strvcat.html"><span class="kw2">strvcat</span></a><span class="br0">(</span>DICOM_file_names<span class="br0">)</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>DICOM_headers, <span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">' DICOM file(s) found.'</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
    DICOM_file_counter = DICOM_file_counter + <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>DICOM_headers, 2<span class="br0">)</span>;
&nbsp;
    <span class="co1">% Restore previous warning status:</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span>previous_warning_status<span class="br0">)</span>;
&nbsp;
    <span class="co1">% If DICOM files have been found:</span>
    <span class="kw1">if</span> ~isempty<span class="br0">(</span>DICOM_headers<span class="br0">)</span>
        <span class="co1">% Attempt DICOM-to-NIfTI conversion:</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'swr_import_DICOM: Attempting DICOM-to-NIfTI conversion...'</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
        spm_dicom_convert<span class="br0">(</span>DICOM_headers, <span class="co2">'all'</span>, <span class="co2">'patid'</span>, <span class="co2">'nii'</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'DICOM-to-NIfTI conversion complete.'</span><span class="br0">)</span>;    
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span> <span class="co1">% of for loop</span>
&nbsp;
<span class="co1">% Change back to the previous working directory:</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>previous_working_directory<span class="br0">)</span>;
&nbsp;
<span class="co1">% Say goodbye:</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'swr_import_DICOM: Finished. Processed '</span> <span class="sy0">...</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>DICOM_file_counter<span class="br0">)</span> <span class="co2">' DICOM file(s) in '</span>, <span class="sy0">...</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/round.html"><span class="kw2">round</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/toc.html"><span class="kw2">toc</span></a><span class="br0">)</span><span class="br0">)</span>, <span class="co2">' seconds.'</span><span class="br0">]</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">' '</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">end</span> <span class="co1">% of function swr_import_DICOM</span>
&nbsp;
<span class="kw1">function</span> directory_list = find_sub_directories<span class="br0">(</span>start_dir<span class="br0">)</span>
<span class="co1">% This function returns a cell array containing the names list of all</span>
<span class="co1">% directories, sub-directories, % sub-sub-directories, </span>
<span class="co1">% sub-sub-sub-directories, sub-sub-sub-sub-directories... (well you get the</span>
<span class="co1">% idea) found in the starting directory specified in the function call. The</span>
<span class="co1">% name of the start directory itself is also included in the list. If it</span>
<span class="co1">% fails (e. g. if the specified start directory does not exist), the</span>
<span class="co1">% function returns {}.</span>
<span class="co1">% </span>
<span class="co1">% Sebastian W Rieger - LabNIC, Geneva University - 2008-08-28</span>
<span class="co1">%</span>
&nbsp;
<span class="kw1">try</span>
    <span class="co1">% find directories using recursive genpath function:</span>
    directory_list = genpath<span class="br0">(</span>start_dir<span class="br0">)</span>;
&nbsp;
    <span class="co1">% convert resulting ';'-delimited string into a cell array:</span>
    directory_list = textscan<span class="br0">(</span>directory_list, <span class="co2">'%s'</span>, <span class="co2">'delimiter'</span>, <span class="co2">';'</span><span class="br0">)</span>;
    directory_list = directory_list<span class="br0">{</span>1<span class="br0">}</span>;
&nbsp;
<span class="co1">% in case of failure, return empty matrix:</span>
<span class="kw1">catch</span>
    directory_list = <span class="br0">{</span><span class="br0">}</span>;
<span class="kw1">end</span>
&nbsp;
<span class="kw1">end</span> <span class="co1">% of function find_sub_directories</span>
&nbsp;
&nbsp;
<span class="kw1">function</span> file_list = list_full_files<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span>
<span class="co1">%</span>
<span class="co1">% This function returns a list of files in a directory. It works the same</span>
<span class="co1">% way as list_files, except it returns file names including the full path</span>
<span class="co1">% string. For example, this is useful for reading DICOM file header</span>
<span class="co1">% information using the SPM5 function spm_DICOM_headers, which expects full</span>
<span class="co1">% paths as input.</span>
<span class="co1">%</span>
<span class="co1">% Optionally, the directory to be searched can be specified (default:</span>
<span class="co1">% current working directory), and results can be filtered (for example to</span>
<span class="co1">% include only certain file types). Any number of filter strings may be</span>
<span class="co1">% used, for example '*.DCM', '*.IMA' to find DICOM files with either</span>
<span class="co1">% extension. The function returns {} if the specified directory cannot be</span>
<span class="co1">% found.</span>
<span class="co1">% </span>
<span class="co1">% Examples:</span>
<span class="co1">%</span>
<span class="co1">% list_full_files finds all files in the current working directory.</span>
<span class="co1">%</span>
<span class="co1">% list_full_files(MyDirName) finds all files in the directory called</span>
<span class="co1">% MyDirName. </span>
<span class="co1">%</span>
<span class="co1">% list_full_files(MyDirName, '*.mat') finds all *.mat files in the</span>
<span class="co1">% directory called MyDirName. </span>
<span class="co1">%</span>
<span class="co1">% list_full_files(MyDirName, '*.dcm', '*.ima') finds all DICOM files in the</span>
<span class="co1">% directory called MyDirName.</span>
<span class="co1">%</span>
<span class="co1">% Sebastian W Rieger - LabNIC, Geneva University - 2008-08-28</span>
<span class="co1">%</span>
&nbsp;
<span class="co1">% Remember the old working directory:</span>
previous_working_directory = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>;
&nbsp;
<span class="co1">% Read name of directory to be searched from function input arguments, or</span>
<span class="co1">% set to default value if not specified:</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 1
    directory = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>;
<span class="kw1">else</span>
    directory = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span>1<span class="br0">}</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Read filter strings from function input arguments, or set to default</span>
<span class="co1">% value if not specified:</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 2
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/filter.html"><span class="kw2">filter</span></a> = <span class="br0">{</span><span class="co2">'*.*'</span><span class="br0">}</span>;
<span class="kw1">else</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/filter.html"><span class="kw2">filter</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">(</span>2 : <span class="kw1">end</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">% Create an empty list, to be filled with names of files found: </span>
file_list = <span class="br0">{</span><span class="br0">}</span>;
&nbsp;
<span class="co1">% Try to go to the specified directory, and abandon function execution</span>
<span class="co1">% if it does not exist:</span>
<span class="kw1">try</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>directory<span class="br0">)</span>;
<span class="kw1">catch</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Directory not found: '</span> directory<span class="br0">]</span><span class="br0">)</span>;
    <span class="kw1">return</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% For each filter string specified...</span>
<span class="kw1">for</span> filter_index = 1 : <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/filter.html"><span class="kw2">filter</span></a><span class="br0">)</span>
    <span class="co1">% ...find matching files:</span>
    directory_contents = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/filter.html"><span class="kw2">filter</span></a><span class="br0">{</span>filter_index<span class="br0">}</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/filter.html"><span class="kw2">filter</span></a><span class="br0">(</span>filter_index<span class="br0">)</span><span class="br0">)</span>;
    <span class="co1">% Go through the list of items found...</span>
    <span class="kw1">for</span> file_index = 1 : <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>directory_contents<span class="br0">)</span>
        <span class="co1">% ... and add them to the file list without including directory</span>
        <span class="co1">% names:</span>
        <span class="kw1">if</span> ~directory_contents<span class="br0">(</span>file_index<span class="br0">)</span>.<span class="me1">isdir</span>
            file_list = <span class="br0">[</span>file_list; <span class="sy0">...</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a> filesep directory_contents<span class="br0">(</span>file_index<span class="br0">)</span>.<span class="me1">name</span><span class="br0">]</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span> <span class="co1">% of for loop (list of items found in directory)</span>
<span class="kw1">end</span> <span class="co1">% of for loop (list of filter strings)</span>
&nbsp;
<span class="co1">% Change back to the old working directory:    </span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>previous_working_directory<span class="br0">)</span>;
&nbsp;
<span class="kw1">end</span> <span class="co1">% of function list_full_files</span></pre>
</dd></dl>
</div>
<p>
It will open a first window to catch the folder where the original data 
are and a second window to ask you where to save your converted data.
</p>

</div>
<div class="secedit editbutton_section editbutton_1"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Import your data] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="4-8123" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Import your data" type="submit"></div></form></div>
<h2 class="sectionedit2"><a name="convert_nifti_to_old_analyze_format" id="convert_nifti_to_old_analyze_format">Convert NIFTI to old Analyze format</a></h2>
<div class="level2">
<p><a title="reveal" class="folder " href="#folded_2"> As backward 
compatibility is not insured in SPM for image formats, this fonction is 
sometimes useful ; use this function for converting your NIFTI files 
(.nii or nifti .img/.hdr) to ANALYSE format (.img/.hdr) and save it as 
nifti2img.m ; Requires at least SPM5 to run</a></p><div class="folded  hidden" id="folded_2">

<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=1" title="Download Snippet" class="mediafile mf_m">nifti2img.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargout.html"><span class="kw2">varargout</span></a> = nifti2ana<span class="br0">(</span>P<span class="br0">)</span>
<span class="co1">% NIFTI2ANA converts images from nifti to analyze format readable in SPM2</span>
<span class="co1">%    V = NIFTI2ANA(P) converts files that are in SPM5's nifti format to the</span>
<span class="co1">%    analyze format that was readable by SPM2. This allows one to use files</span>
<span class="co1">%    processed in SPM5 to be analyzed in SPM2.</span>
<span class="co1">%</span>
<span class="co1">%    P are the filenames to be converted. If P is empty the user is</span>
<span class="co1">%    prompted to select the files.</span>
<span class="co1">%</span>
<span class="co1">%    V is a structure array of mapped volumes. This can be used to read the</span>
<span class="co1">%    new files or discarded.</span>
<span class="co1">%</span>
<span class="co1">%    SPM5 must be in the Matlab path.</span>
<span class="co1">%</span>
<span class="co1">%    The converted files are prepended with 'n2a_'</span>
<span class="co1">%</span>
<span class="co1">%    The program REQUIRES SPM5 image files (either .nii or .img) as input,</span>
<span class="co1">%    and outputs SPM2 compatible analyze-type files. This program is not</span>
<span class="co1">%    for converting SPM5 .nii to SPM5 .img files. To do that simply read</span>
<span class="co1">%    in the data, change the filename to have a .img extension, and write</span>
<span class="co1">%    out the new file. For example:</span>
<span class="co1">%       v          = spm_vol('my_file_name.nii');</span>
<span class="co1">%       img        = spm_read_vols(v);</span>
<span class="co1">%       vnew       = v;</span>
<span class="co1">%       vnew.fname = [vnew.fname(1:end-3), 'img'];</span>
<span class="co1">%       vnew       = spm_create_vol(vnew);</span>
<span class="co1">%       vnew       = spm_write_vol(vnew,img);</span>
<span class="co1">%</span>
<span class="co1">% Author: Darren Gitelman</span>
<span class="co1">% $Id: nifti2ana.m,v 1.3 2008-07-22 13:06:43-05 drg Exp drg $</span>
<span class="co1">% updated 2010-07-14 by drg.</span>
&nbsp;
<span class="co1">% Get image filenames if none are provided</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 1
    P = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'image'</span>,<span class="co2">'Select images to convert'</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">if</span> isempty<span class="br0">(</span>P<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'No files selected. Aborting conversion.'</span><span class="br0">)</span>
    <span class="kw1">return</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Map the volumes using SPM5 file handling tools</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Reading SPM5 NIFTI volume headers..'</span><span class="br0">)</span>;
Vin = spm_vol<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>P<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Done\n'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'There are %i files to be converted.\n'</span>,numel<span class="br0">(</span>Vin<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
Vout = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'fname'</span>  , <span class="co2">''</span>,<span class="sy0">...</span>
    <span class="co2">'dim'</span>    , <span class="br0">[</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">'mat'</span>    , <span class="br0">[</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">'pinfo'</span>  , <span class="br0">[</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">'descrip'</span>, <span class="co2">''</span>,<span class="sy0">...</span>
    <span class="co2">'n'</span>      , <span class="br0">[</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">'private'</span>, <span class="br0">[</span><span class="br0">]</span><span class="br0">)</span>;
V = Vout;
<span class="co1">% Convert the volume structures to be analyze compatible</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Creating SPM2-compatible headers..'</span><span class="br0">)</span>
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a> = 1:numel<span class="br0">(</span>Vin<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'%5i'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
    <span class="br0">[</span>tmppth tmpfn tmpext<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">fname</span><span class="br0">)</span>;
    dt    = Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">dt</span><span class="br0">(</span>1<span class="br0">)</span>;
    tmpfn = <span class="br0">[</span><span class="co2">'n2a_'</span>,tmpfn<span class="br0">]</span>;
    Vtmp.<span class="me1">fname</span>   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>tmppth,<span class="br0">[</span>tmpfn,tmpext<span class="br0">]</span><span class="br0">)</span>;
    Vtmp.<span class="me1">dim</span>     = <span class="br0">[</span>Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">dim</span> dt<span class="br0">]</span>;
    Vtmp.<span class="me1">mat</span>     = Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">mat</span>;
    <span class="kw1">if</span> spm_flip_analyze_images
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">' : Flipping image L/R\n'</span><span class="br0">)</span>
        Vtmp.<span class="me1">mat</span> = spm_matrix<span class="br0">(</span><span class="br0">[</span>0 0 0 0 0 0 -1 1 1 0 0 0<span class="br0">]</span><span class="br0">)</span>*Vtmp.<span class="me1">mat</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Creating SPM2-compatible headers..%5i'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>
    <span class="kw1">end</span>
    Vtmp.<span class="me1">pinfo</span>   = Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">pinfo</span>;
    Vtmp.<span class="me1">descrip</span> = <span class="br0">[</span><span class="co2">'nifti2analyze converted: '</span>,Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">descrip</span><span class="br0">]</span>;
&nbsp;
    dtype = Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>.<span class="me1">dat</span>.<span class="me1">dtype</span>;
&nbsp;
    <span class="co1">% must pass the dtype to figure out if endianness is swapped.</span>
    Vout<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>= my_spm2_create_vol<span class="br0">(</span>Vtmp,<span class="co2">'noopen'</span>,dtype<span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="co2">'\b'</span>,1,5<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Done\n'</span><span class="br0">)</span>
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'Writing SPM2-compatible image files..'</span><span class="br0">)</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a> = 1:numel<span class="br0">(</span>Vout<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'%5i'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
    y = spm_read_vols<span class="br0">(</span>Vin<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
    V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span> = my_spm2_write_vol<span class="br0">(</span>Vout<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>,y,dtype<span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="co2">'\b'</span>,1,5<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'All Done!\n'</span><span class="br0">)</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> == 1
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargout.html"><span class="kw2">varargout</span></a><span class="br0">{</span>1<span class="br0">}</span> = V;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%     THESE FUNCTIONS COME FROM THE SPM2 VERSION OF SPM_CREATE_VOL</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> V = my_spm2_create_vol<span class="br0">(</span>V,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span>
<span class="co1">% Create an image file.</span>
<span class="co1">% FORMAT Vo = spm_create_vol(Vi,['noopen'])</span>
<span class="co1">% Vi   - data structure containing image information.</span>
<span class="co1">%      - see spm_vol for a description.</span>
<span class="co1">% 'noopen' - optional flag to say "don't open/create the image file".</span>
<span class="co1">% Vo   - data structure after modification for writing.</span>
<span class="co1">% varargin can now have 2 arguments, 'noopen' and the dtype.</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">% @(#)spm_create_vol.m	2.14 John Ashburner 03/07/31</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:numel<span class="br0">(</span>V<span class="br0">)</span>
    <span class="kw1">if</span> nargin&gt;1,
        v = my_spm2_internal_create_vol<span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span>:<span class="br0">}</span><span class="br0">)</span>;
    <span class="kw1">else</span>
        v = my_spm2_internal_create_vol<span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
    f = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fieldnames.html"><span class="kw2">fieldnames</span></a><span class="br0">(</span>v<span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>f,<span class="nu0">1</span><span class="br0">)</span>,
        <span class="co1">%eval(['V(i).' f{j} ' = v.' f{j} ';']);</span>
        V = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/setfield.html"><span class="kw2">setfield</span></a><span class="br0">(</span>V,<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,f<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/getfield.html"><span class="kw2">getfield</span></a><span class="br0">(</span>v,f<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> V = my_spm2_internal_create_vol<span class="br0">(</span>V,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span>
<span class="kw1">if</span> ~isfield<span class="br0">(</span>V,<span class="co2">'n'</span><span class="br0">)</span> || isempty<span class="br0">(</span>V.<span class="me1">n</span><span class="br0">)</span>
    V.<span class="me1">n</span>  = <span class="nu0">1</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>V,<span class="co2">'descrip'</span><span class="br0">)</span> || isempty<span class="br0">(</span>V.<span class="me1">descrip</span><span class="br0">)</span>
    V.<span class="me1">descrip</span> = <span class="co2">'SPM2 compatible'</span>;
<span class="kw1">end</span>;
V.<span class="me1">private</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'hdr'</span>,<span class="br0">[</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% Orientation etc...</span>
M  = V.<span class="me1">mat</span>;
<span class="kw1">if</span> spm_flip_analyze_images, M = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span><span class="br0">[</span>-1 1 1 1<span class="br0">]</span><span class="br0">)</span>*M; <span class="kw1">end</span>;
vx = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>M<span class="br0">(</span>1:3,1:3<span class="br0">)</span>.^2<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/det.html"><span class="kw2">det</span></a><span class="br0">(</span>M<span class="br0">(</span>1:3,1:3<span class="br0">)</span><span class="br0">)</span>&lt;0, vx<span class="br0">(</span>1<span class="br0">)</span> = -vx<span class="br0">(</span>1<span class="br0">)</span>; <span class="kw1">end</span>;
origin = M\<span class="br0">[</span>0 0 0 1<span class="br0">]</span>';
origin = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/round.html"><span class="kw2">round</span></a><span class="br0">(</span>origin<span class="br0">(</span>1:3<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
<span class="br0">[</span>pth nam<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
fname         = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pth,<span class="br0">[</span>nam, <span class="co2">'.hdr'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">try</span>
    <span class="br0">[</span>hdr swapped<span class="br0">]</span> = my_spm2_spm_read_hdr<span class="br0">(</span>fname<span class="br0">)</span>;
<span class="kw1">catch</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Could not read "'</span> fname <span class="co2">'"'</span><span class="br0">]</span><span class="br0">)</span>;
    swapped = <span class="nu0">0</span>;
    hdr     = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>hdr<span class="br0">)</span> &amp;&amp; <span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>5<span class="br0">)</span>&gt;1 || V.<span class="me1">n</span>&gt;<span class="nu0">1</span><span class="br0">)</span>,
    <span class="co1">% cannot simply overwrite the header</span>
&nbsp;
    hdr.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>5<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>V.<span class="me1">n</span>,hdr.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>5<span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>V.<span class="me1">dim</span><span class="br0">(</span>1:3<span class="br0">)</span> ~= hdr.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>2:4<span class="br0">)</span><span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Incompatible image dimensions'</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
&nbsp;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>vx-hdr.<span class="me1">dime</span>.<span class="me1">pixdim</span><span class="br0">(</span>2:4<span class="br0">)</span><span class="br0">)</span>.^2<span class="br0">)</span>&gt;1e-6,
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Incompatible voxel sizes'</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
&nbsp;
    V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span> = spm_type<span class="br0">(</span>spm_type<span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">datatype</span><span class="br0">)</span><span class="br0">)</span>;
    mach     = <span class="co2">'native'</span>;
    <span class="kw1">if</span> swapped,
        V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span> = V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span>*<span class="nu0">256</span>;
        <span class="kw1">if</span> spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>,
            mach = <span class="co2">'ieee-le'</span>;
        <span class="kw1">else</span>
            mach = <span class="co2">'ieee-be'</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
&nbsp;
    <span class="kw1">if</span> isfinite<span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">funused1</span><span class="br0">)</span> &amp;&amp; hdr.<span class="me1">dime</span>.<span class="me1">funused1</span>
        scal  = hdr.<span class="me1">dime</span>.<span class="me1">funused1</span>;
        <span class="kw1">if</span> isfinite<span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">funused2</span><span class="br0">)</span>,
            dcoff = hdr.<span class="me1">dime</span>.<span class="me1">funused2</span>;
        <span class="kw1">else</span>
            dcoff = <span class="nu0">0</span>;
        <span class="kw1">end</span>;
    <span class="kw1">else</span>
        <span class="kw1">if</span> hdr.<span class="me1">dime</span>.<span class="me1">glmax</span>-hdr.<span class="me1">dime</span>.<span class="me1">glmin</span> &amp;&amp; hdr.<span class="me1">dime</span>.<span class="me1">cal_max</span>-hdr.<span class="me1">dime</span>.<span class="me1">cal_min</span>
            scal  = <span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">cal_max</span>-hdr.<span class="me1">dime</span>.<span class="me1">cal_min</span><span class="br0">)</span>/<span class="br0">(</span>hdr.<span class="me1">dime</span>.<span class="me1">glmax</span>-hdr.<span class="me1">dime</span>.<span class="me1">glmin</span><span class="br0">)</span>;
            dcoff = hdr.<span class="me1">dime</span>.<span class="me1">cal_min</span> - scal*hdr.<span class="me1">dime</span>.<span class="me1">glmin</span>;
        <span class="kw1">else</span>
            scal  = <span class="nu0">1</span>;
            dcoff = <span class="nu0">0</span>;
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Assuming a scalefactor of 1 for "'</span> V.<span class="me1">fname</span> <span class="co2">'".'</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
    V.<span class="me1">pinfo</span><span class="br0">(</span>1:2<span class="br0">)</span>    = <span class="br0">[</span>scal dcoff<span class="br0">]</span>';
    V.<span class="me1">private</span>.<span class="me1">hdr</span>   = hdr;
<span class="kw1">else</span>
&nbsp;
    V.<span class="me1">private</span>.<span class="me1">hdr</span> = my_spm2_create_defaults;
&nbsp;
    my_endianess = spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> == 3
        dtype = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span>2<span class="br0">}</span>;
    <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> ==2
        dtype = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span>1<span class="br0">}</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="kw1">if</span> my_endianess &amp;&amp; ~isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>dtype,<span class="co2">'BE'</span><span class="br0">)</span><span class="br0">)</span> || <span class="sy0">...</span>
            ~my_endianess &amp;&amp; isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>dtype,<span class="co2">'BE'</span><span class="br0">)</span><span class="br0">)</span>
        swapped = <span class="nu0">0</span>;
    <span class="kw1">else</span>
        swapped = <span class="nu0">1</span>;
    <span class="kw1">end</span>
    dt      = spm_type<span class="br0">(</span>spm_type<span class="br0">(</span>V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>dt == <span class="br0">[</span><span class="nu0">128</span>+<span class="nu0">2</span> <span class="nu0">128</span>+<span class="nu0">4</span> <span class="nu0">128</span>+<span class="nu0">8</span><span class="br0">]</span><span class="br0">)</span>,
        <span class="co1">% Convert to a form that Analyze will support</span>
        dt  = dt - <span class="nu0">128</span>;
    <span class="kw1">end</span>;
    V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span> = dt;
    mach     = <span class="co2">'native'</span>;
    <span class="kw1">if</span> swapped
        V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span> = V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span>*<span class="nu0">256</span>;
        <span class="kw1">if</span> spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>,
            mach = <span class="co2">'ieee-le'</span>;
        <span class="kw1">else</span>
            mach = <span class="co2">'ieee-be'</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">datatype</span>    = dt;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">bitpix</span>      = spm_type<span class="br0">(</span>dt,<span class="co2">'bits'</span><span class="br0">)</span>;
&nbsp;
    <span class="kw1">if</span> spm_type<span class="br0">(</span>dt,<span class="co2">'intt'</span><span class="br0">)</span>,
&nbsp;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>    = spm_type<span class="br0">(</span>dt,<span class="co2">'maxval'</span><span class="br0">)</span>;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>    = spm_type<span class="br0">(</span>dt,<span class="co2">'minval'</span><span class="br0">)</span>;
&nbsp;
        <span class="kw1">if</span> <span class="nu0">0</span>, <span class="co1">% Allow DC offset</span>
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_max</span>  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>*V.<span class="me1">pinfo</span><span class="br0">(</span>1,:<span class="br0">)</span> + V.<span class="me1">pinfo</span><span class="br0">(</span>2,:<span class="br0">)</span><span class="br0">)</span>;
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_min</span>  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>*V.<span class="me1">pinfo</span><span class="br0">(</span>1,:<span class="br0">)</span> + V.<span class="me1">pinfo</span><span class="br0">(</span>2,:<span class="br0">)</span><span class="br0">)</span>;
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span> = <span class="nu0">0</span>;
            scal                = <span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_max</span> - V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_min</span><span class="br0">)</span>/<span class="sy0">...</span>
                <span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>   - V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span><span class="br0">)</span>;
            dcoff               =  V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_min</span> - V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>*scal;
            V.<span class="me1">pinfo</span>             = <span class="br0">[</span>scal dcoff 0<span class="br0">]</span>';
        <span class="kw1">else</span> <span class="co1">% Don't allow DC offset</span>
            cal_max                     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>*V.<span class="me1">pinfo</span><span class="br0">(</span>1,:<span class="br0">)</span> + V.<span class="me1">pinfo</span><span class="br0">(</span>2,:<span class="br0">)</span><span class="br0">)</span>;
            cal_min                     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>*V.<span class="me1">pinfo</span><span class="br0">(</span>1,:<span class="br0">)</span> + V.<span class="me1">pinfo</span><span class="br0">(</span>2,:<span class="br0">)</span><span class="br0">)</span>;
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span> = cal_max/V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>;
            <span class="kw1">if</span> V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>,
                V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span>,<span class="sy0">...</span>
                    <span class="me1">cal_min</span>/V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span><span class="br0">)</span>;
            <span class="kw1">end</span>;
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_max</span>  = V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>*V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span>;
            V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_min</span>  = V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>*V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span>;
            V.<span class="me1">pinfo</span>             = <span class="br0">[</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span> 0 0<span class="br0">]</span>';
        <span class="kw1">end</span>;
    <span class="kw1">else</span>
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmax</span>    = <span class="nu0">1</span>;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">glmin</span>    = <span class="nu0">0</span>;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_max</span>  = <span class="nu0">1</span>;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">cal_min</span>  = <span class="nu0">0</span>;
        V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">funused1</span> = <span class="nu0">1</span>;
    <span class="kw1">end</span>;
&nbsp;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">pixdim</span><span class="br0">(</span>2:4<span class="br0">)</span> = vx;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>2:4<span class="br0">)</span>    = V.<span class="me1">dim</span><span class="br0">(</span>1:3<span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>5<span class="br0">)</span>      = V.<span class="me1">n</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">origin</span><span class="br0">(</span>1:3<span class="br0">)</span> = origin;
&nbsp;
    d                              = 1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>V.<span class="me1">descrip</span><span class="br0">)</span> 79<span class="br0">]</span><span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span>     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,80<span class="br0">)</span><span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span><span class="br0">(</span>d<span class="br0">)</span>  = V.<span class="me1">descrip</span><span class="br0">(</span>d<span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">hk</span>.<span class="me1">db_name</span>       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,18<span class="br0">)</span><span class="br0">)</span>;
    <span class="br0">[</span>pth, nam<span class="br0">]</span>                  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
    d                              = 1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>nam<span class="br0">)</span> 17<span class="br0">]</span><span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">hk</span>.<span class="me1">db_name</span><span class="br0">(</span>d<span class="br0">)</span>    = nam<span class="br0">(</span>d<span class="br0">)</span>;
<span class="kw1">end</span>;
&nbsp;
V.<span class="me1">pinfo</span><span class="br0">(</span>3<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/prod.html"><span class="kw2">prod</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">dim</span><span class="br0">(</span>2:4<span class="br0">)</span><span class="br0">)</span>*V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span>.<span class="me1">bitpix</span>/8*<span class="br0">(</span>V.<span class="me1">n</span>-1<span class="br0">)</span>;
&nbsp;
fid           = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'w'</span>,mach<span class="br0">)</span>;
<span class="kw1">if</span> <span class="br0">(</span>fid == -1<span class="br0">)</span>,
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error opening '</span> fname <span class="co2">'. Check that you have write permission.'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
&nbsp;
my_spm2_write_hk<span class="br0">(</span>fid,V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">hk</span><span class="br0">)</span>;
my_spm2_write_dime<span class="br0">(</span>fid,V.<span class="me1">private</span>.<span class="me1">hdr</span>.<span class="me1">dime</span><span class="br0">)</span>;
my_spm2_write_hist<span class="br0">(</span>fid,V.<span class="me1">private</span>.<span class="me1">hdr</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fid<span class="br0">)</span>;
&nbsp;
fname = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pth,<span class="br0">[</span>nam, <span class="co2">'.mat'</span><span class="br0">]</span><span class="br0">)</span>;
off   = -vx'.*origin;
mt    = <span class="br0">[</span>vx<span class="br0">(</span>1<span class="br0">)</span> 0 0 off<span class="br0">(</span>1<span class="br0">)</span> ; 0 vx<span class="br0">(</span>2<span class="br0">)</span> 0 off<span class="br0">(</span>2<span class="br0">)</span> ; 0 0 vx<span class="br0">(</span>3<span class="br0">)</span> off<span class="br0">(</span>3<span class="br0">)</span> ; 0 0 0 1<span class="br0">]</span>;
<span class="kw1">if</span> spm_flip_analyze_images, mt = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span><span class="br0">[</span>-1 1 1 1<span class="br0">]</span><span class="br0">)</span>*mt; <span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>V.<span class="me1">mat</span><span class="br0">(</span>:<span class="br0">)</span> - mt<span class="br0">(</span>:<span class="br0">)</span><span class="br0">)</span>.*<span class="br0">(</span>V.<span class="me1">mat</span><span class="br0">(</span>:<span class="br0">)</span> - mt<span class="br0">(</span>:<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span> &gt; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eps.html"><span class="kw2">eps</span></a>*<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eps.html"><span class="kw2">eps</span></a>*12 || <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>fname,<span class="co2">'file'</span><span class="br0">)</span>==2
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>fname,<span class="co2">'file'</span><span class="br0">)</span>==2,
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> mat
        str = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span>fname<span class="br0">)</span>;
        <span class="kw1">if</span> isfield<span class="br0">(</span>str,<span class="co2">'mat'</span><span class="br0">)</span>,
            mat = str.<span class="me1">mat</span>;
        <span class="kw1">elseif</span> isfield<span class="br0">(</span>str,<span class="co2">'M'</span><span class="br0">)</span>,
            mat = str.<span class="me1">M</span>;
            <span class="kw1">if</span> spm_flip_analyze_images,
                <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>mat,3<span class="br0">)</span>,
                    mat<span class="br0">(</span>:,:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span><span class="br0">[</span>-1 1 1 1<span class="br0">]</span><span class="br0">)</span>*mat<span class="br0">(</span>:,:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
                <span class="kw1">end</span>;
            <span class="kw1">end</span>;
        <span class="kw1">end</span>;
        mat<span class="br0">(</span>:,:,V.<span class="me1">n</span><span class="br0">)</span> = V.<span class="me1">mat</span>;
        mat          = my_spm2_fill_empty<span class="br0">(</span>mat,mt<span class="br0">)</span>;
        M = mat<span class="br0">(</span>:,:,1<span class="br0">)</span>;
        <span class="kw1">if</span> spm_flip_analyze_images
            M = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span><span class="br0">[</span>-1 1 1 1<span class="br0">]</span><span class="br0">)</span>*M;
        <span class="kw1">end</span>;
        <span class="kw1">try</span>
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span>fname,<span class="co2">'mat'</span>,<span class="co2">'M'</span>,<span class="co2">'-append'</span><span class="br0">)</span>;
        <span class="kw1">catch</span>    <span class="co1">% Mat-file was probably Matlab 4</span>
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span>fname,<span class="co2">'mat'</span>,<span class="co2">'M'</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">else</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> mat
        mat<span class="br0">(</span>:,:,V.<span class="me1">n</span><span class="br0">)</span> = V.<span class="me1">mat</span>;
        mat          = my_spm2_fill_empty<span class="br0">(</span>mat,mt<span class="br0">)</span>;
        M = mat<span class="br0">(</span>:,:,1<span class="br0">)</span>;
        <span class="kw1">if</span> spm_flip_analyze_images
            M = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span><span class="br0">[</span>-1 1 1 1<span class="br0">]</span><span class="br0">)</span>*M;
        <span class="kw1">end</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span>fname,<span class="co2">'mat'</span>,<span class="co2">'M'</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a>==1 || ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,<span class="co2">'noopen'</span><span class="br0">)</span>
    fname         = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pth,<span class="br0">[</span>nam, <span class="co2">'.img'</span><span class="br0">]</span><span class="br0">)</span>;
    V.<span class="me1">private</span>.<span class="me1">fid</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r+'</span>,mach<span class="br0">)</span>;
    <span class="kw1">if</span> <span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">fid</span> == -1<span class="br0">)</span>,
        V.<span class="me1">private</span>.<span class="me1">fid</span>     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'w'</span>,mach<span class="br0">)</span>;
        <span class="kw1">if</span> <span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">fid</span> == -1<span class="br0">)</span>,
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error opening '</span> fname <span class="co2">'. Check that you have write permission.'</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> Mo = my_spm2_fill_empty<span class="br0">(</span>Mo,Mfill<span class="br0">)</span>
todo = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Mo,3<span class="br0">)</span>
    <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>Mo<span class="br0">(</span>:,:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,
        todo = <span class="br0">[</span>todo <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>todo<span class="br0">)</span>
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>todo<span class="br0">)</span>,
        Mo<span class="br0">(</span>:,:,todo<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span> = Mfill;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> my_spm2_write_hk<span class="br0">(</span>fid,hk<span class="br0">)</span>
<span class="co1">% write (struct) header_key</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">sizeof_hdr</span>,	<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">data_type</span>,	<span class="co2">'char'</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">db_name</span>,		<span class="co2">'char'</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">extents</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">session_error</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">regular</span>,		<span class="co2">'char'</span> <span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,hk.<span class="me1">hkey_un0</span>,	<span class="co2">'char'</span> <span class="br0">)</span>~= 1,
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">'. Check your disk space.'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> my_spm2_write_dime<span class="br0">(</span>fid,dime<span class="br0">)</span>
<span class="co1">% write (struct) image_dimension</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">40</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">dim</span>,		<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">vox_units</span>,	<span class="co2">'uchar'</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">cal_units</span>,	<span class="co2">'uchar'</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">unused1</span>,	<span class="co2">'int16'</span> <span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">datatype</span>,	<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">bitpix</span>,		<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">dim_un0</span>,	<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">pixdim</span>,		<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">vox_offset</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">funused1</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">funused2</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">funused2</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">cal_max</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">cal_min</span>,	<span class="co2">'float'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">compressed</span>,	<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">verified</span>,	<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">glmax</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,dime.<span class="me1">glmin</span>,		<span class="co2">'int32'</span><span class="br0">)</span>~=1,
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">'. Check your disk space.'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> my_spm2_write_hist<span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a><span class="br0">)</span>
<span class="co1">% write (struct) data_history</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">148</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">aux_file</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/orient.html"><span class="kw2">orient</span></a>,		<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">origin</span>,		<span class="co2">'int16'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">generated</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">scannum</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">patient_id</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_date</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_time</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">hist_un0</span>,	<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">views</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">vols_added</span>,	<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">start_field</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">field_skip</span>,	<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omax</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omin</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smax</span>,		<span class="co2">'int32'</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smin</span>,	<span class="co2">'int32'</span><span class="br0">)</span>~=1,
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">'. Check your disk space.'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> hdr = my_spm2_create_defaults
hk.<span class="me1">sizeof_hdr</span>	= <span class="nu0">348</span>;
hk.<span class="me1">data_type</span>	= <span class="br0">[</span><span class="co2">'dsr      '</span> 0<span class="br0">]</span>;
hk.<span class="me1">db_name</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,18<span class="br0">)</span><span class="br0">)</span>;
hk.<span class="me1">extents</span>		= <span class="nu0">0</span>;
hk.<span class="me1">session_error</span>= <span class="nu0">0</span>;
hk.<span class="me1">regular</span>		= <span class="co2">'r'</span>;
hk.<span class="me1">hkey_un0</span>		= <span class="nu0">0</span>;
&nbsp;
dime.<span class="me1">dim</span>		= <span class="br0">[</span>4 0 0 0 1 0 0 0<span class="br0">]</span>;
dime.<span class="me1">vox_units</span>	= <span class="br0">[</span><span class="co2">'mm '</span> 0<span class="br0">]</span>;
dime.<span class="me1">cal_units</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,8<span class="br0">)</span><span class="br0">)</span>;
dime.<span class="me1">unused1</span>	= <span class="nu0">0</span>;
dime.<span class="me1">datatype</span>	= -<span class="nu0">1</span>;
dime.<span class="me1">bitpix</span>		= <span class="nu0">0</span>;
dime.<span class="me1">dim_un0</span>	= <span class="nu0">0</span>;
dime.<span class="me1">pixdim</span>		= <span class="br0">[</span>0 1 1 1 1 0 0 0<span class="br0">]</span>;
dime.<span class="me1">vox_offset</span>	= <span class="nu0">0</span>;
dime.<span class="me1">funused1</span>	= <span class="nu0">1</span>;
dime.<span class="me1">funused2</span>	= <span class="nu0">0</span>;
dime.<span class="me1">funused3</span>	= <span class="nu0">0</span>;
dime.<span class="me1">cal_max</span>	= <span class="nu0">1</span>;
dime.<span class="me1">cal_min</span>	= <span class="nu0">0</span>;
dime.<span class="me1">compressed</span>	= <span class="nu0">0</span>;
dime.<span class="me1">verified</span>	= <span class="nu0">0</span>;
dime.<span class="me1">glmax</span>		= <span class="nu0">1</span>;
dime.<span class="me1">glmin</span>		= <span class="nu0">0</span>;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,80<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span><span class="br0">(</span>1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><span class="co2">'SPM2 compatible'</span><span class="br0">)</span><span class="br0">)</span> = <span class="co2">'SPM2 compatible'</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">aux_file</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,24<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/orient.html"><span class="kw2">orient</span></a>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>0<span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">origin</span>		= <span class="br0">[</span>0 0 0  0 0<span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">generated</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,10<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">scannum</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,10<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">patient_id</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,10<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_date</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,10<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_time</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,10<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">hist_un0</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,3<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">generated</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">5</span><span class="br0">)</span>	= <span class="co2">'today'</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">views</span>		= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">vols_added</span>	= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">start_field</span>= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">field_skip</span>	= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omax</span>		= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omin</span>		= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smax</span>		= <span class="nu0">0</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smin</span>		= <span class="nu0">0</span>;
&nbsp;
hdr.<span class="me1">hk</span>   = hk;
hdr.<span class="me1">dime</span> = dime;
hdr.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%      THESE FUNCTIONS COME FROM THE SPM2 VERSION OF SPM_READ_HDR</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>hdr,otherendian<span class="br0">]</span> = my_spm2_spm_read_hdr<span class="br0">(</span>fname<span class="br0">)</span>
<span class="co1">% Read (SPM customised) Analyze header</span>
<span class="co1">% FORMAT [hdr,otherendian] = spm_read_hdr(fname)</span>
<span class="co1">% fname       - .hdr filename</span>
<span class="co1">% hdr         - structure containing Analyze header</span>
<span class="co1">% otherendian - byte swapping necessary flag</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">% @(#)spm_read_hdr.m	2.2 John Ashburner 03/07/17</span>
&nbsp;
fid         = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r'</span>,<span class="co2">'native'</span><span class="br0">)</span>;
otherendian = <span class="nu0">0</span>;
<span class="kw1">if</span> <span class="br0">(</span>fid &gt; 0<span class="br0">)</span>
    dime = my_spm2_read_dime<span class="br0">(</span>fid<span class="br0">)</span>;
    <span class="kw1">if</span> dime.<span class="me1">dim</span><span class="br0">(</span>1<span class="br0">)</span>&lt;0 || dime.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>&gt;<span class="nu0">15</span>  <span class="co1">% Appears to be other-endian</span>
        <span class="co1">% Re-open other-endian</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fid<span class="br0">)</span>;
        <span class="kw1">if</span> spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>, fid = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r'</span>,<span class="co2">'ieee-le'</span><span class="br0">)</span>;
        <span class="kw1">else</span>                      fid = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r'</span>,<span class="co2">'ieee-be'</span><span class="br0">)</span>; <span class="kw1">end</span>;
        otherendian = <span class="nu0">1</span>;
        dime = my_spm2_read_dime<span class="br0">(</span>fid<span class="br0">)</span>;
    <span class="kw1">end</span>;
    hk       = my_spm2_read_hk<span class="br0">(</span>fid<span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>     = my_spm2_read_hist<span class="br0">(</span>fid<span class="br0">)</span>;
    hdr.<span class="me1">hk</span>   = hk;
    hdr.<span class="me1">dime</span> = dime;
    hdr.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fid<span class="br0">)</span>;
<span class="kw1">else</span>
    hdr = <span class="br0">[</span><span class="br0">]</span>;
    otherendian = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a>;
    <span class="co1">%error(['Problem opening header file (' fopen(fid) ').']);</span>
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> hk = my_spm2_read_hk<span class="br0">(</span>fid<span class="br0">)</span>
<span class="co1">% read (struct) header_key</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
hk.<span class="me1">sizeof_hdr</span> 		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
hk.<span class="me1">data_type</span>  		= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
hk.<span class="me1">db_name</span>    		= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">18</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
hk.<span class="me1">extents</span>    		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
hk.<span class="me1">session_error</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
hk.<span class="me1">regular</span>			= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
hk.<span class="me1">hkey_un0</span>			= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<span class="kw1">if</span> isempty<span class="br0">(</span>hk.<span class="me1">hkey_un0</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Problem reading "hk" of header file ('</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">').'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> dime = my_spm2_read_dime<span class="br0">(</span>fid<span class="br0">)</span>
<span class="co1">% read (struct) image_dimension</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">40</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
dime.<span class="me1">dim</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">8</span>,<span class="co2">'int16'</span><span class="br0">)</span>';
dime.<span class="me1">vox_units</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">4</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
dime.<span class="me1">cal_units</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">8</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
dime.<span class="me1">unused1</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
dime.<span class="me1">datatype</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
dime.<span class="me1">bitpix</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
dime.<span class="me1">dim_un0</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int16'</span><span class="br0">)</span>;
dime.<span class="me1">pixdim</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">8</span>,<span class="co2">'float'</span><span class="br0">)</span>';
dime.<span class="me1">vox_offset</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">funused1</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">funused2</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">funused3</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">cal_max</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">cal_min</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'float'</span><span class="br0">)</span>;
dime.<span class="me1">compressed</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
dime.<span class="me1">verified</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
dime.<span class="me1">glmax</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
dime.<span class="me1">glmin</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>dime.<span class="me1">glmin</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Problem reading "dime" of header file ('</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">').'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a> = my_spm2_read_hist<span class="br0">(</span>fid<span class="br0">)</span>
<span class="co1">% read (struct) data_history</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">148</span>,<span class="co2">'bof'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">descrip</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">80</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">aux_file</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">24</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/orient.html"><span class="kw2">orient</span></a>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'uchar'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">origin</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">5</span>,<span class="co2">'int16'</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">generated</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">scannum</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">patient_id</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_date</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">exp_time</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">10</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">hist_un0</span>	= my_spm2_mysetstr<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">3</span>,<span class="co2">'uchar'</span><span class="br0">)</span><span class="br0">)</span>';
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">views</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">vols_added</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">start_field</span>= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">field_skip</span>	= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omax</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">omin</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smax</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smin</span>		= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid,<span class="nu0">1</span>,<span class="co2">'int32'</span><span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/hist.html"><span class="kw2">hist</span></a>.<span class="me1">smin</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Problem reading "hist" of header file ('</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fid<span class="br0">)</span> <span class="co2">').'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> out = my_spm2_mysetstr<span class="br0">(</span>in<span class="br0">)</span>
tmp = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>in == 0<span class="br0">)</span>;
tmp = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>tmp<span class="br0">)</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>in<span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
out = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><span class="br0">[</span>in<span class="br0">(</span>1:tmp<span class="br0">)</span>' <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>in<span class="br0">)</span>-<span class="br0">(</span>tmp<span class="br0">)</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>';
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%     THESE FUNCTIONS COME FROM THE SPM2 VERSION OF SPM_WRITE_VOL</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> V = my_spm2_write_vol<span class="br0">(</span>V,Y,dtype<span class="br0">)</span>
<span class="co1">% Write an image volume to disk, setting scales and offsets as appropriate</span>
<span class="co1">% FORMAT V = my_spm2_write_vol(V,Y)</span>
<span class="co1">% V (input)  - a structure containing image volume information (see spm_vol)</span>
<span class="co1">% Y          - a one, two or three dimensional matrix containing the image voxels</span>
<span class="co1">% V (output) - data structure after modification for writing.</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">% @(#)spm_write_vol.m	2.9 John Ashburner 03/02/26</span>
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ndims.html"><span class="kw2">ndims</span></a><span class="br0">(</span>Y<span class="br0">)</span>&gt;3, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Can only handle a maximum of 3 dimensions.'</span><span class="br0">)</span>, <span class="kw1">end</span>
&nbsp;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>V,<span class="co2">'pinfo'</span><span class="br0">)</span>, V.<span class="me1">pinfo</span> = <span class="br0">[</span>1,0,0<span class="br0">]</span>'; <span class="kw1">end</span>
&nbsp;
dim = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Y<span class="br0">)</span> 1 1 1<span class="br0">]</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a><span class="br0">(</span>dim<span class="br0">(</span>1:3<span class="br0">)</span> == V.<span class="me1">dim</span><span class="br0">(</span>1:3<span class="br0">)</span><span class="br0">)</span> || <span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>V.<span class="me1">pinfo</span>,2<span class="br0">)</span>~=1 &amp;&amp; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>V.<span class="me1">pinfo</span>,2<span class="br0">)</span>~=dim<span class="br0">(</span>3<span class="br0">)</span><span class="br0">)</span>,
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Incompatible dimensions.'</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">% Set scalefactors and offsets</span>
<span class="co1">%-----------------------------------------------------------------------</span>
dt = V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span>; <span class="kw1">if</span> dt&gt;256, dt = dt/<span class="nu0">256</span>; <span class="kw1">end</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>dt == <span class="br0">[</span><span class="nu0">128</span>+<span class="nu0">2</span> <span class="nu0">128</span>+<span class="nu0">4</span> <span class="nu0">128</span>+<span class="nu0">8</span><span class="br0">]</span><span class="br0">)</span>,
    <span class="co1">% Convert to a form that Analyze will support</span>
    dt = dt - <span class="nu0">128</span>;
<span class="kw1">end</span>;
s            = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>dt == <span class="br0">[</span>2 4 8 128+2 128+4 128+8<span class="br0">]</span><span class="br0">)</span>;
dmnmx        = <span class="br0">[</span>0 -2^15 -2^31 -2^7 0 0 ; 2^8-1 2^15-1 2^31-1 2^7-1 2^16 2^32<span class="br0">]</span>;
dmnmx        = dmnmx<span class="br0">(</span>:,s<span class="br0">)</span>;
V.<span class="me1">pinfo</span><span class="br0">(</span>1,:<span class="br0">)</span> = <span class="nu0">1</span>;
V.<span class="me1">pinfo</span><span class="br0">(</span>2,:<span class="br0">)</span> = <span class="nu0">0</span>;
mxs          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>dim<span class="br0">(</span>3<span class="br0">)</span>,1<span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a>;
mns          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>dim<span class="br0">(</span>3<span class="br0">)</span>,1<span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>s<span class="br0">)</span>,
    <span class="kw1">for</span> p=1:dim<span class="br0">(</span>3<span class="br0">)</span>,
        tmp    = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span>Y<span class="br0">(</span>:,:,p<span class="br0">)</span><span class="br0">)</span>;
        tmp    = tmp<span class="br0">(</span>isfinite<span class="br0">(</span>tmp<span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">if</span> ~isempty<span class="br0">(</span>tmp<span class="br0">)</span>,
            mxs<span class="br0">(</span>p<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>tmp<span class="br0">)</span>;
            mns<span class="br0">(</span>p<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>tmp<span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
&nbsp;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>V.<span class="me1">pinfo</span>,2<span class="br0">)</span> ~= 1
        <span class="kw1">for</span> p=1:dim<span class="br0">(</span>3<span class="br0">)</span>,
            mx = mxs<span class="br0">(</span>p<span class="br0">)</span>;
            mn = mns<span class="br0">(</span>p<span class="br0">)</span>;
            <span class="kw1">if</span> ~isfinite<span class="br0">(</span>mx<span class="br0">)</span>, mx = <span class="nu0">0</span>; <span class="kw1">end</span>;
            <span class="kw1">if</span> ~isfinite<span class="br0">(</span>mn<span class="br0">)</span>, mn = <span class="nu0">0</span>; <span class="kw1">end</span>;
            <span class="kw1">if</span> mx~=mn,
                V.<span class="me1">pinfo</span><span class="br0">(</span>1,p<span class="br0">)</span> = <span class="br0">(</span>mx-mn<span class="br0">)</span>/<span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>-dmnmx<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>;
                V.<span class="me1">pinfo</span><span class="br0">(</span>2,p<span class="br0">)</span> = <span class="sy0">...</span>
                    <span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>*mn-dmnmx<span class="br0">(</span>1<span class="br0">)</span>*mx<span class="br0">)</span>/<span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>-dmnmx<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">else</span>
                V.<span class="me1">pinfo</span><span class="br0">(</span>1,p<span class="br0">)</span> = <span class="nu0">0</span>;
                V.<span class="me1">pinfo</span><span class="br0">(</span>2,p<span class="br0">)</span> = mx;
            <span class="kw1">end</span>;
        <span class="kw1">end</span>;
    <span class="kw1">else</span>
        mx = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>mxs<span class="br0">(</span>isfinite<span class="br0">(</span>mxs<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
        mn = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>mns<span class="br0">(</span>isfinite<span class="br0">(</span>mns<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">if</span> isempty<span class="br0">(</span>mx<span class="br0">)</span>, mx = <span class="nu0">0</span>; <span class="kw1">end</span>;
        <span class="kw1">if</span> isempty<span class="br0">(</span>mn<span class="br0">)</span>, mn = <span class="nu0">0</span>; <span class="kw1">end</span>;
        <span class="kw1">if</span> mx~=mn
            V.<span class="me1">pinfo</span><span class="br0">(</span>1,1<span class="br0">)</span> = <span class="br0">(</span>mx-mn<span class="br0">)</span>/<span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>-dmnmx<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>;
            V.<span class="me1">pinfo</span><span class="br0">(</span>2,1<span class="br0">)</span> = <span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>*mn-dmnmx<span class="br0">(</span>1<span class="br0">)</span>*mx<span class="br0">)</span>/<span class="br0">(</span>dmnmx<span class="br0">(</span>2<span class="br0">)</span>-dmnmx<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">else</span>
            V.<span class="me1">pinfo</span><span class="br0">(</span>1,1<span class="br0">)</span> = <span class="nu0">0</span>;
            V.<span class="me1">pinfo</span><span class="br0">(</span>2,1<span class="br0">)</span> = mx;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="co1">%-Create and write image</span>
<span class="co1">%-----------------------------------------------------------------------</span>
V = my_spm2_create_vol<span class="br0">(</span>V,dtype<span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> p=1:V.<span class="me1">dim</span><span class="br0">(</span>3<span class="br0">)</span>,
    V = my_spm2_write_plane<span class="br0">(</span>V,Y<span class="br0">(</span>:,:,p<span class="br0">)</span>,p<span class="br0">)</span>;
<span class="kw1">end</span>;
V = my_spm2_close_vol<span class="br0">(</span>V<span class="br0">)</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%     THESE FUNCTIONS COME FROM THE SPM2 VERSION OF SPM_WRITE_PLANE</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> V = my_spm2_write_plane<span class="br0">(</span>V,A,p<span class="br0">)</span>
<span class="co1">% Write a transverse plane of image data.</span>
<span class="co1">% FORMAT V = my_spm2_write_plane(V,A,p)</span>
<span class="co1">% V   - data structure containing image information.</span>
<span class="co1">%       - see spm_vol for a description.</span>
<span class="co1">% A   - the two dimensional image to write.</span>
<span class="co1">% p   - the plane number (beginning from 1).</span>
<span class="co1">%</span>
<span class="co1">% VO  - (possibly) modified data structure containing image information.</span>
<span class="co1">%       It is possible that future versions of spm_write_plane may</span>
<span class="co1">%       modify scalefactors (for example).</span>
<span class="co1">%</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">% @(#)spm_write_plane.m	2.19 John Ashburner 03/07/16</span>
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>V.<span class="me1">dim</span><span class="br0">(</span>1:2<span class="br0">)</span> ~= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>A<span class="br0">)</span><span class="br0">)</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Incompatible image dimensions'</span><span class="br0">)</span>;      <span class="kw1">end</span>;
<span class="kw1">if</span> p&gt;V.<span class="me1">dim</span><span class="br0">(</span>3<span class="br0">)</span>,                 <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Plane number too high'</span><span class="br0">)</span>;              <span class="kw1">end</span>;
&nbsp;
<span class="co1">% Write Analyze image by default</span>
V = my_spm2_write_analyze_plane<span class="br0">(</span>V,A,p<span class="br0">)</span>;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
&nbsp;
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> V = my_spm2_write_analyze_plane<span class="br0">(</span>V,A,p<span class="br0">)</span>
&nbsp;
types   = <span class="br0">[</span>    2      4      8   16   64   130    132    136,   512   1024   2048 4096 16384 33280  33792  34816<span class="br0">]</span>;
maxval  = <span class="br0">[</span>2^8-1 2^15-1 2^31-1  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a> 2^7-1 2^16-1 2^32-1, 2^8-1 2^15-1 2^31-1  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a> 2^8-1 2^16-1 2^32-1<span class="br0">]</span>;
minval  = <span class="br0">[</span>    0  -2^15  -2^31 -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a> -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>  -2^7      0      0,     0  -2^15  -2^31 -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>  -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>  -2^7      0      0<span class="br0">]</span>;
intt    = <span class="br0">[</span>    1      1      1    0    0     1      1      1,     1      1      1    0     0     1      1      1<span class="br0">]</span>;
prec = str2mat<span class="br0">(</span><span class="co2">'uint8'</span>,<span class="co2">'int16'</span>,<span class="co2">'int32'</span>,<span class="co2">'float'</span>,<span class="co2">'double'</span>,<span class="co2">'int8'</span>,<span class="co2">'uint16'</span>,<span class="co2">'uint32'</span>,<span class="co2">'uint8'</span>,<span class="co2">'int16'</span>,<span class="co2">'int32'</span>,<span class="co2">'float'</span>,<span class="co2">'double'</span>,<span class="co2">'int8'</span>,<span class="co2">'uint16'</span>,<span class="co2">'uint32'</span><span class="br0">)</span>;
swapped = <span class="br0">[</span>    0      0      0    0    0     0      0      0,     1      1      1    1     1     1      1      1<span class="br0">]</span>;
bits    = <span class="br0">[</span>    8     16     32   32   64     8     16     32,     8     16     32   32    64     8     16     32<span class="br0">]</span>;
&nbsp;
dt      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>types==V.<span class="me1">dim</span><span class="br0">(</span>4<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>dt<span class="br0">)</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Unknown datatype'</span><span class="br0">)</span>; <span class="kw1">end</span>;
&nbsp;
A = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span>A<span class="br0">)</span>;
&nbsp;
<span class="co1">% Rescale to fit appropriate range</span>
<span class="kw1">if</span> intt<span class="br0">(</span>dt<span class="br0">)</span>,
    A<span class="br0">(</span>isnan<span class="br0">(</span>A<span class="br0">)</span><span class="br0">)</span> = <span class="nu0">0</span>;
    mxv         = maxval<span class="br0">(</span>dt<span class="br0">)</span>;
    mnv         = minval<span class="br0">(</span>dt<span class="br0">)</span>;
    A           = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/round.html"><span class="kw2">round</span></a><span class="br0">(</span>A*<span class="br0">(</span>1/V.<span class="me1">pinfo</span><span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span> - V.<span class="me1">pinfo</span><span class="br0">(</span>2<span class="br0">)</span><span class="br0">)</span>;
    A<span class="br0">(</span>A &gt; mxv<span class="br0">)</span>  = mxv;
    A<span class="br0">(</span>A &lt; mnv<span class="br0">)</span>  = mnv;
<span class="kw1">end</span>;
&nbsp;
<span class="br0">[</span>pth,nam<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
fname     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pth,<span class="br0">[</span>nam, <span class="co2">'.img'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>V,<span class="co2">'private'</span><span class="br0">)</span> || ~isfield<span class="br0">(</span>V.<span class="me1">private</span>,<span class="co2">'fid'</span><span class="br0">)</span> || isempty<span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span>
    mach = <span class="co2">'native'</span>;
    <span class="kw1">if</span> swapped<span class="br0">(</span>dt<span class="br0">)</span>
        <span class="kw1">if</span> spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>
            mach = <span class="co2">'ieee-le'</span>;
        <span class="kw1">else</span>
            mach = <span class="co2">'ieee-be'</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
    fid       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r+'</span>,mach<span class="br0">)</span>;
    <span class="kw1">if</span> fid == -1
        fid   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'w'</span>,mach<span class="br0">)</span>;
        <span class="kw1">if</span> fid == -1
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error opening '</span> fname <span class="co2">'. Check that you have write permission.'</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
<span class="kw1">else</span>
    <span class="kw1">if</span> isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span><span class="br0">)</span>,
        mach = <span class="co2">'native'</span>;
        <span class="kw1">if</span> swapped<span class="br0">(</span>dt<span class="br0">)</span>
            <span class="kw1">if</span> spm_platform<span class="br0">(</span><span class="co2">'bigend'</span><span class="br0">)</span>
                mach = <span class="co2">'ieee-le'</span>;
            <span class="kw1">else</span>
                mach = <span class="co2">'ieee-be'</span>;
            <span class="kw1">end</span>;
        <span class="kw1">end</span>;
        V.<span class="me1">private</span>.<span class="me1">fid</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>fname,<span class="co2">'r+'</span>,mach<span class="br0">)</span>;
        <span class="kw1">if</span> V.<span class="me1">private</span>.<span class="me1">fid</span> == -1
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error opening '</span> fname <span class="co2">'. Check that you have write permission.'</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
    <span class="kw1">end</span>;
    fid = V.<span class="me1">private</span>.<span class="me1">fid</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="co1">% Seek to the appropriate offset</span>
datasize = bits<span class="br0">(</span>dt<span class="br0">)</span>/<span class="nu0">8</span>;
off   = <span class="br0">(</span>p-1<span class="br0">)</span>*datasize*<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/prod.html"><span class="kw2">prod</span></a><span class="br0">(</span>V.<span class="me1">dim</span><span class="br0">(</span>1:2<span class="br0">)</span><span class="br0">)</span> + V.<span class="me1">pinfo</span><span class="br0">(</span>3,1<span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'bof'</span><span class="br0">)</span>; <span class="co1">% A bug in Matlab 6.5 means that a rewind is needed</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,off,<span class="co2">'bof'</span><span class="br0">)</span>==-<span class="nu0">1</span>,
    <span class="co1">% Need this because fseek in Matlab does not seek past the EOF</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'bof'</span><span class="br0">)</span>; <span class="co1">% A bug in Matlab 6.5 means that a rewind is needed</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'eof'</span><span class="br0">)</span>;
    curr_off = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ftell.html"><span class="kw2">ftell</span></a><span class="br0">(</span>fid<span class="br0">)</span>;
    blanks   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>off-curr_off,1<span class="br0">)</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,blanks,<span class="co2">'uchar'</span><span class="br0">)</span> ~= numel<span class="br0">(</span>blanks<span class="br0">)</span>
        my_spm2_write_error_message<span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span> V.<span class="me1">fname</span> <span class="co2">'.'</span><span class="br0">]</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,<span class="nu0">0</span>,<span class="co2">'bof'</span><span class="br0">)</span>; <span class="co1">% A bug in Matlab 6.5 means that a rewind is needed</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fseek.html"><span class="kw2">fseek</span></a><span class="br0">(</span>fid,off,<span class="co2">'bof'</span><span class="br0">)</span> == -1,
        my_spm2_write_error_message<span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span> V.<span class="me1">fname</span> <span class="co2">'.'</span><span class="br0">]</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fid,A,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>prec<span class="br0">(</span>dt,:<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span> ~= numel<span class="br0">(</span>A<span class="br0">)</span>
    my_spm2_write_error_message<span class="br0">(</span>V.<span class="me1">fname</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Error writing '</span> V.<span class="me1">fname</span> <span class="co2">'.'</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>;
&nbsp;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>V,<span class="co2">'private'</span><span class="br0">)</span> || ~isfield<span class="br0">(</span>V.<span class="me1">private</span>,<span class="co2">'fid'</span><span class="br0">)</span> || isempty<span class="br0">(</span>V.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fid<span class="br0">)</span>; <span class="kw1">end</span>;
&nbsp;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
&nbsp;
<span class="co1">%_______________________________________________________________________</span>
<span class="kw1">function</span> my_spm2_write_error_message<span class="br0">(</span>q<span class="br0">)</span>
str = <span class="br0">{</span><span class="sy0">...</span>
    <span class="co2">'Error writing:'</span>,<span class="sy0">...</span>
    <span class="co2">' '</span>,<span class="sy0">...</span>
    <span class="br0">[</span><span class="co2">'        '</span>,spm_str_manip<span class="br0">(</span>q,<span class="co2">'k40d'</span><span class="br0">)</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">' '</span>,<span class="sy0">...</span>
    <span class="co2">'Check disk space / disk quota.'</span><span class="br0">}</span>;
spm<span class="br0">(</span><span class="co2">'alert*'</span>,str,mfilename,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span>-1<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">return</span>;
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%     THIS FUNCTION COMES FROM THE SPM2 VERSION OF SPM_CLOSE_VOL</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> V = my_spm2_close_vol<span class="br0">(</span>V<span class="br0">)</span>
<span class="co1">% Close image volume</span>
<span class="co1">% See: spm_create_vol and spm_write_plane.</span>
<span class="co1">%_______________________________________________________________________</span>
<span class="co1">% @(#)spm_close_vol.m	2.4 John Ashburner 02/08/16</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:numel<span class="br0">(</span>V<span class="br0">)</span>,
    <span class="kw1">if</span> isfield<span class="br0">(</span>V,<span class="co2">'private'</span><span class="br0">)</span> &amp;&amp; isfield<span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>,<span class="co2">'fid'</span><span class="br0">)</span> &amp;&amp; ~isempty<span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span>,
        <span class="kw1">if</span> ~isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span><span class="br0">)</span>,
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>.<span class="me1">fid</span><span class="br0">)</span>;
        <span class="kw1">end</span>;
        V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>V<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">private</span>,<span class="co2">'fid'</span><span class="br0">)</span>;
    <span class="kw1">end</span>;
<span class="kw1">end</span>;</pre>
</dd></dl>
</div>
</div>
<div class="secedit editbutton_section editbutton_2"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Convert NIFTI to old Analyze format] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="8124-39806" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Convert NIFTI to old Analyze format" type="submit"></div></form></div>
<h2 class="sectionedit3"><a name="preprocessing" id="preprocessing">Preprocessing</a></h2>
<div class="level2">
<p><a title="reveal" class="folder " href="#folded_3"> SPM5: save this function as spm5_preprocessing_labnic.m</a></p><div class="folded  hidden" id="folded_3">

<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=2" title="Download Snippet" class="mediafile mf_m">spm5_preprocessing_labnic.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_preprocessing_spm5
<span class="co1">% preprocessing of the subjects you will define:</span>
<span class="co1">%  you must have a structure like</span>
<span class="co1">%  **...main_dir\populations\subjects\scans\sessions\f*img**</span>
<span class="co1">%</span>
<span class="co1">% if you have a structural image for the subject: **...main_dir\populations\subjects\scans\struct\s*img**</span>
<span class="co1">% if you have no structural image, do not create the dir 'struct' and the coregistration will not be processed</span>
<span class="co1">%</span>
<span class="co1">% It will create \af \waf and \swaf folders with the processed images</span>
<span class="co1">% Processing include realignment, coregistration, slice-timing, normalization, smoothing</span>
<span class="co1">%</span>
<span class="co1">% you must specify some details of your study in line 24 to 27 of the function</span>
<span class="co1">% if you have specific names or specific order for sessions, specify it at</span>
<span class="co1">% the end of this function</span>
&nbsp;
<span class="co1">% this function has been adapted by Yann Cojan (yann.cojan@unige.ch),</span>
<span class="co1">% Christoph Hoftsetter (christoph.hoftsetter@unige.ch)</span>
<span class="co1">% and Virginie Sterpenich (virginie.sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> TR Session_filter im_format path_spm5;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%% parameters to specify for each study</span>
TR = <span class="nu0">1.7</span>;
im_format = <span class="co2">'nii'</span>; <span class="co1">%or 'img';</span>
Session_filter=<span class="co2">'*ATTHYPNO*'</span>; <span class="co1">%name of the study in the directory of the sessions</span>
root_path = <span class="co2">'C:\experiments\FLANKER\'</span>; <span class="co1">% directory where are the populations, main directory</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="co1">%% definition of the path of spm5 for finding the EPI template for normalisation</span>
mypath = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/what.html"><span class="kw2">what</span></a><span class="br0">(</span><span class="co2">'spm8'</span><span class="br0">)</span>;
path_spm8 = mypath<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/path.html"><span class="kw2">path</span></a>;
&nbsp;
<span class="co1">%% Definition of the population and subjects to process</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> pop=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
&nbsp;
<span class="co1">%% Processing</span>
<span class="kw1">for</span> suj=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>
    suj_path = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>suj,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">'scans'</span> filesep<span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'working on '</span> suj_path<span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'------------------------'</span><span class="br0">)</span>;
    <span class="co1">%call different steps here</span>
  <span class="co1">%  realign(suj_path);</span>
    <span class="co1">%coregister(suj_path);</span>
   <span class="co1">% slice_timing(suj_path,'f');</span>
    normalise<span class="br0">(</span>suj_path,<span class="co2">'af'</span><span class="br0">)</span>;
    <span class="co1">%smooth(suj_path,'waf');</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% F U N C T I O N - S E C T I O N</span>
<span class="kw1">function</span> realign<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, realigns images in folder 'f' and rewrites their headers</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format;
im_style=<span class="co2">'f'</span>;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="co1">%loading the job</span>
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">data</span><span class="br0">{</span>iii<span class="br0">}</span> = <span class="sy0">...</span>
            <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">quality</span> = <span class="nu0">0.9</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">sep</span> = <span class="nu0">4</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span> = <span class="nu0">5</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">rtm</span> = <span class="nu0">1</span>; <span class="co1">% 1: register to mean (default); 0: register to first</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">interp</span> = <span class="nu0">2</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">weight</span> = <span class="br0">{</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span> = <span class="nu0">5</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">4</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">mask</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">realign</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/which.html"><span class="kw2">which</span></a> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'realign'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> coregister<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">%%%searches in path if struct exist</span>
<span class="co1">%coregister the s img with the mean img;</span>
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'struct'</span><span class="br0">)</span><span class="br0">)</span>;<span class="co1">%if the structural img exist</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">ref</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^mean.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">source</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^s.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">other</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>           = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">''</span><span class="br0">]</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">cost_fun</span>  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'nmi'</span><span class="br0">]</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">sep</span>       = <span class="br0">[</span><span class="nu0">4</span> <span class="nu0">2</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">tol</span>       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/reshape.html"><span class="kw2">reshape</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><span class="br0">[</span><span class="nu0">0.02</span>; <span class="nu0">0.02</span>; <span class="nu0">0.02</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.01</span>; <span class="nu0">0.01</span>; <span class="nu0">0.01</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>;<span class="br0">]</span><span class="br0">)</span>,<span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">12</span><span class="br0">]</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">coreg</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span>      = <span class="br0">[</span><span class="nu0">7</span> <span class="nu0">7</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'coreg'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> slice_timing<span class="br0">(</span>suj_path,im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, corrects for different slice times,</span>
<span class="co1">%%%writes new file prefixed by 'a' and moves them into a folder 'a...',</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> TR  Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
count =<span class="nu0">0</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span> &amp; ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="co2">'FACELO'</span>,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span>iii<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    <span class="co1">%find number of slices</span>
    V=spm_vol<span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span> = V.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span> = TR;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">ta</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>-jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>/jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">so</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>:-<span class="nu0">1</span>:<span class="nu0">1</span>; <span class="co1">%descending</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">refslice</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ceil.html"><span class="kw2">ceil</span></a><span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>/<span class="nu0">2</span><span class="br0">)</span>; <span class="co1">%middle slice as reference</span>
<span class="kw1">elseif</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span> &amp; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'FACELO'</span>,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
    <span class="co1">%loading the job</span>
    count = count +<span class="nu0">1</span>;
    <span class="kw1">for</span> iii=<span class="nu0">1</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span>iii<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    <span class="co1">%find number of slices</span>
    V=spm_vol<span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span> = V.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span> = TR;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">ta</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>-jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>/jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">so</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>:-<span class="nu0">1</span>:<span class="nu0">1</span>; <span class="co1">%descending</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">refslice</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ceil.html"><span class="kw2">ceil</span></a><span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>/<span class="nu0">2</span><span class="br0">)</span>; <span class="co1">%middle slice as reference</span>
&nbsp;
    count = count + <span class="nu0">1</span>;
    <span class="kw1">for</span> iii=<span class="nu0">2</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span>iii-<span class="nu0">1</span><span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">%find number of slices</span>
    V=spm_vol<span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span> = V.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span> = TR;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">ta</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>-jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">tr</span>/jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">so</span> = jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>:-<span class="nu0">1</span>:<span class="nu0">1</span>; <span class="co1">%descending</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span>count<span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">refslice</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ceil.html"><span class="kw2">ceil</span></a><span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">temporal</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">st</span>.<span class="me1">nslices</span>/<span class="nu0">2</span><span class="br0">)</span>; <span class="co1">%middle slice as reference</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'slicetiming'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>;
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'a'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> normalise<span class="br0">(</span>suj_path, im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, normalises images indicated by im_style,</span>
<span class="co1">%%%using parameters from first scan in sessions, writes new file prefixed by 'w'</span>
<span class="co1">%%%and moves them into a folder 'w...', which is located at the same level as 'f'</span>
&nbsp;
<span class="kw1">global</span> Session_filter im_format path_spm5;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="co1">%loading the job</span>
    <span class="co1">%source image is the mean image generated in the realignment step</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">source</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^meanf.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    <span class="co1">%initialisation of .resample</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span>=<span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,im_style<span class="br0">)</span>;
        this_session_images=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span>=<span class="br0">[</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span> <span class="br0">{</span>this_session_images<span class="br0">{</span><span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">}</span><span class="br0">}</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">wtsrc</span> = <span class="br0">{</span><span class="br0">}</span>;
    <span class="co1">%template path</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">template</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span> = <span class="br0">[</span>path_spm5 filesep <span class="co2">'templates'</span> filesep <span class="co2">'EPI.nii,1'</span><span class="br0">]</span>;
    <span class="co1">%other parameters</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">weight</span> = <span class="br0">{</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smosrc</span> = <span class="nu0">8</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smoref</span> = <span class="nu0">0</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">regtype</span> = <span class="co2">'mni'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">cutoff</span> = <span class="nu0">25</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">nits</span> = <span class="nu0">16</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">reg</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">preserve</span> = <span class="nu0">0</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">bb</span> = <span class="br0">[</span>-<span class="nu0">78</span> -<span class="nu0">112</span> -<span class="nu0">50</span>;<span class="nu0">78</span> <span class="nu0">76</span> <span class="nu0">85</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">vox</span> = <span class="br0">[</span><span class="nu0">3</span> <span class="nu0">3</span> <span class="nu0">3</span><span class="br0">]</span>; <span class="co1">%default [2 2 2]</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
&nbsp;
    D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>; <span class="co1">%if struct exist, it is also normalised bu in 1 1 1 vox size</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'struct'</span><span class="br0">)</span><span class="br0">)</span>;
        struct_img = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^s.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">subj</span>.<span class="me1">matname</span> = <span class="br0">{</span><span class="br0">[</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">source</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>im_format,jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">source</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>-<span class="nu0">2</span><span class="br0">)</span> <span class="co2">'_sn.mat'</span><span class="br0">]</span><span class="br0">}</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">subj</span>.<span class="me1">resample</span> = struct_img;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">roptions</span>.<span class="me1">bb</span> = <span class="br0">[</span>-<span class="nu0">78</span> -<span class="nu0">112</span> -<span class="nu0">50</span>;<span class="nu0">78</span> <span class="nu0">76</span> <span class="nu0">85</span><span class="br0">]</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">roptions</span>.<span class="me1">vox</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>; <span class="co1">%default [2 2 2]</span>
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">1</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">normalise</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">write</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'normalize'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
    move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'w'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> smooth<span class="br0">(</span>suj_path, im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, smooths images indicated by im_style,</span>
<span class="co1">%%%writes new files prefixed by 's' and moves them into a folder 's...', which</span>
<span class="co1">%%%is located at the same level as 'f'</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">smooth</span>.<span class="me1">data</span>=<span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,im_style<span class="br0">)</span>;
        this_session_images=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess filesep<span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">smooth</span>.<span class="me1">data</span>=<span class="br0">[</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">smooth</span>.<span class="me1">data</span> <span class="br0">{</span>this_session_images<span class="br0">{</span><span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">}</span><span class="br0">}</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">smooth</span>.<span class="me1">fwhm</span>                          = <span class="br0">[</span><span class="nu0">8</span> <span class="nu0">8</span> <span class="nu0">8</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spatial</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">smooth</span>.<span class="me1">dtype</span>                         = <span class="nu0">0</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'smooth'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
    move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'s'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%Auxiliary Functions%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> move_files<span class="br0">(</span>suj_path,source_style,dest_style<span class="br0">)</span>
<span class="co1">%%% moves files with source_style (e.g. swaf) from path (e.g. waf) to new</span>
<span class="co1">%%% destination defined by dest_style</span>
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>im_format,<span class="co2">'nii'</span><span class="br0">)</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>source_style,<span class="co2">'f'</span><span class="br0">)</span><span class="co1">%$$$$ f img are not in a specific dir</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">else</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>source_style,<span class="co2">'f'</span><span class="br0">)</span><span class="co1">%$$$$ f img are not in a specific dir</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.hdr'</span><span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">else</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.hdr'</span><span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> dirs = get_directories<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">% returns a cell array holding true directories located at path</span>
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
dirs=<span class="br0">{</span>D<span class="br0">(</span>~<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'.'</span><span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'..'</span><span class="br0">)</span>+~<span class="br0">[</span>D.<span class="me1">isdir</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">name</span><span class="br0">}</span>;
&nbsp;
<span class="co1">%------------------------------%</span>
<span class="co1">% if you have speficic names or a specific order for the sessions, specify it here</span>
<span class="co1">% if you have normal names, like EXP_run1, EXP_run2, etc, keep it commanded</span>
&nbsp;
<span class="co1">% dirs = {'morphing_titrage_run1',...</span>
<span class="co1">%         'morphing_titrage_run2',...</span>
<span class="co1">%         'morphing_test_run5',...</span>
<span class="co1">%         'morphing_faceloc_run11'};</span>
<span class="co1">%------------------------------%</span>
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
<strong><em>updated by YC on the 10th of October 2011</em></strong>
</p>
<p><a title="reveal" class="folder " href="#folded_4"> SPM8: Save this function as spm8_preprocessing_labnic.m to preprocess with spm8</a></p><div class="folded  hidden" id="folded_4">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=3" title="Download Snippet" class="mediafile mf_m">spm8_preprocessing_labnic.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = spm8_preprocessing_labnic
<span class="co1">% preprocessing of the subjects you will define:</span>
<span class="co1">%  you must have a structure like</span>
<span class="co1">%  **...main_dir\populations\subjects\scans\sessions\f*img**</span>
<span class="co1">%</span>
<span class="co1">% if you have a structural image for the subject: **...main_dir\populations\subjects\scans\struct\s*img**</span>
<span class="co1">% if you have no structural image, do not create the dir 'struct' and the coregistration will not be processed</span>
<span class="co1">%</span>
<span class="co1">% It will create \af \waf and \swaf folders with the processed images</span>
<span class="co1">% Processing include realignment, coregistration, slice-timing, normalization, smoothing</span>
<span class="co1">%</span>
<span class="co1">% you must specify some details of your study in line 24 to 27 of the function</span>
<span class="co1">% if you have specific names or specific order for sessions, specify it at</span>
<span class="co1">% the end of this function</span>
&nbsp;
<span class="co1">% this function has been adapted by Yann Cojan (yann.cojan@unige.ch),</span>
<span class="co1">% Christoph Hoftsetter (christoph.hoftsetter@unige.ch)</span>
<span class="co1">% and Virginie Sterpenich (virginie.sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> Session_filter im_format path_spm8 func_vox_size anat_vox_size smooth_filter normalization_im_style realign_scan;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%% General parameters to specify for each study</span>
im_format = <span class="co2">'nii'</span>; <span class="co1">%or 'img';</span>
Session_filter=<span class="co2">'*FLANKER1*'</span>; <span class="co1">%name of the study in the directory of the sessions</span>
root_path = <span class="co2">'G:\STRHYP\controls'</span>; <span class="co1">% directory where are the populations, main directory</span>
&nbsp;
<span class="co1">%% Specific parameters</span>
steps = <span class="br0">{</span><span class="co2">'realign'</span> <span class="co2">'coregister'</span> <span class="co2">'slice_timing'</span> <span class="co2">'normalization'</span> <span class="co2">'smoothing'</span><span class="br0">}</span>;
func_vox_size = <span class="br0">[</span><span class="nu0">3</span> <span class="nu0">3</span> <span class="nu0">3</span><span class="br0">]</span>;<span class="co1">% voxel size of functional images</span>
anat_vox_size = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;<span class="co1">% voxel size of anatomical image</span>
smooth_filter = <span class="nu0">8</span>;      <span class="co1">% width of the Gaussian smoothing kernel</span>
<span class="co1">% which scan is used for realignment?</span>
realign_scan = <span class="nu0">1</span>;<span class="co1">%1: register to mean (default); 0: register to first</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="co2">'slice_timing'</span>,steps<span class="br0">)</span><span class="br0">)</span>
    normalization_im_style = <span class="co2">'af'</span>;
<span class="kw1">else</span>
    normalization_im_style = <span class="co2">'f'</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% definition of the path of spm8 for finding the EPI template for normalisation</span>
mypath = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/what.html"><span class="kw2">what</span></a><span class="br0">(</span><span class="co2">'spm8'</span><span class="br0">)</span>;
path_spm8 = mypath.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/path.html"><span class="kw2">path</span></a>;
&nbsp;
<span class="co1">%% Definition of the population and subjects to process</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> pop=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> suj=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>
    suj_path = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>suj,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">'scans\'</span><span class="br0">]</span>;
    <span class="kw1">for</span> s = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>steps,<span class="nu0">2</span><span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>steps<span class="br0">{</span>s<span class="br0">}</span>,<span class="co2">'realign'</span><span class="br0">)</span> || <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>steps<span class="br0">{</span>s<span class="br0">}</span>,<span class="co2">'coregister'</span><span class="br0">)</span> || <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>steps<span class="br0">{</span>s<span class="br0">}</span>,<span class="co2">'slice_timing'</span><span class="br0">)</span>
            im_style = <span class="co2">'f'</span>;
        <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>steps<span class="br0">{</span>s<span class="br0">}</span>,<span class="co2">'normalization'</span><span class="br0">)</span>
            im_style = normalization_im_style;
        <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>steps<span class="br0">{</span>s<span class="br0">}</span>,<span class="co2">'smoothing'</span><span class="br0">)</span>
            im_style = <span class="br0">[</span><span class="co2">'w'</span> normalization_im_style<span class="br0">]</span>;
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span>steps<span class="br0">{</span>s<span class="br0">}</span> <span class="co2">'(suj_path,im_style)'</span><span class="br0">]</span><span class="br0">)</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% F U N C T I O N - S E C T I O N</span>
<span class="kw1">function</span> realign<span class="br0">(</span>suj_path,im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, realigns images in folder 'f' and rewrites their headers</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format realign_scan;
&nbsp;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="co1">%loading the job</span>
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">data</span><span class="br0">{</span>iii<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">quality</span> = <span class="nu0">0.9</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">sep</span> = <span class="nu0">4</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span> = <span class="nu0">5</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">rtm</span> = realign_scan;<span class="co1">%1: register to mean (default); 0: register to first</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">interp</span> = <span class="nu0">2</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">weight</span> = <span class="br0">{</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span> = <span class="nu0">5</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">4</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">mask</span> = <span class="nu0">1</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">realign</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/which.html"><span class="kw2">which</span></a> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'realign'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> coregister<span class="br0">(</span>suj_path,im_style<span class="br0">)</span>
<span class="co1">%%%searches in path if struct exist</span>
<span class="co1">%coregister the s img with the mean img;</span>
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'struct'</span><span class="br0">)</span><span class="br0">)</span>;<span class="co1">%if the structural img exist</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">ref</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^mean.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">source</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span>,spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">other</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>           = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><span class="co2">''</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">cost_fun</span>  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><span class="co2">'nmi'</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">sep</span>       = <span class="br0">[</span><span class="nu0">4</span> <span class="nu0">2</span><span class="br0">]</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">tol</span>       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/reshape.html"><span class="kw2">reshape</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><span class="br0">[</span><span class="nu0">0.02</span>; <span class="nu0">0.02</span>; <span class="nu0">0.02</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.01</span>; <span class="nu0">0.01</span>; <span class="nu0">0.01</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>; <span class="nu0">0.001</span>;<span class="br0">]</span><span class="br0">)</span>,<span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">12</span><span class="br0">]</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">coreg</span>.<span class="me1">estimate</span>.<span class="me1">eoptions</span>.<span class="me1">fwhm</span>      = <span class="br0">[</span><span class="nu0">7</span> <span class="nu0">7</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'coreg'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> slice_timing<span class="br0">(</span>suj_path,im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, corrects for different slice times,</span>
<span class="co1">%%%writes new file prefixed by 'a' and moves them into a folder 'a...',</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
count =<span class="nu0">0</span>;
&nbsp;
<span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
    im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span>iii<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="co1">%find number of slices</span>
V=spm_vol<span class="br0">(</span>matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">scans</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>;
nslices = V.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
TR = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2double.html"><span class="kw2">str2double</span></a><span class="br0">(</span>V.<span class="me1">descrip</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'TR'</span>,V.<span class="me1">descrip</span><span class="br0">)</span>+<span class="nu0">3</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'TR'</span>,V.<span class="me1">descrip</span><span class="br0">)</span>+<span class="nu0">6</span><span class="br0">)</span><span class="br0">)</span>/<span class="nu0">1000</span>;<span class="co1">%finding automatically TR</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">nslices</span> = nslices;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">tr</span> = TR;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">ta</span> = matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">tr</span>-matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">tr</span>/matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">nslices</span>;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">so</span> = matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">nslices</span>:-<span class="nu0">1</span>:<span class="nu0">1</span>; <span class="co1">%descending</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">refslice</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ceil.html"><span class="kw2">ceil</span></a><span class="br0">(</span>matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">temporal</span>.<span class="me1">st</span>.<span class="me1">nslices</span>/<span class="nu0">2</span><span class="br0">)</span>; <span class="co1">%middle slice as reference</span>
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'slicetiming'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>;
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'a'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> normalization<span class="br0">(</span>suj_path, im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, normalises images indicated by im_style,</span>
<span class="co1">%%%using parameters from first scan in sessions, writes new file prefixed by 'w'</span>
<span class="co1">%%%and moves them into a folder 'w...', which is located at the same level as 'f'</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format path_spm8 func_vox_size anat_vox_size ;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="co1">%loading the job</span>
    <span class="co1">%source image is the mean image generated in the realignment step</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">source</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^meanf.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="co1">%initialisation of .resample</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span>=<span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>im_style, <span class="co2">'af'</span><span class="br0">)</span>
            im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,im_style<span class="br0">)</span>;
        <span class="kw1">else</span>
            im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        this_session_images=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span>=<span class="br0">[</span>matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span> <span class="br0">{</span>this_session_images<span class="br0">{</span><span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">}</span><span class="br0">}</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">wtsrc</span> = <span class="br0">{</span><span class="br0">}</span>;
    <span class="co1">%template path</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">template</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span> = <span class="br0">[</span>path_spm8 <span class="co2">'\templates\EPI.nii,1'</span><span class="br0">]</span>;
    <span class="co1">%other parameters</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">weight</span> = <span class="br0">{</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smosrc</span> = <span class="nu0">8</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smoref</span> = <span class="nu0">0</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">regtype</span> = <span class="co2">'mni'</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">cutoff</span> = <span class="nu0">25</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">nits</span> = <span class="nu0">16</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">reg</span> = <span class="nu0">1</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">preserve</span> = <span class="nu0">0</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">bb</span> = <span class="br0">[</span>-<span class="nu0">78</span> -<span class="nu0">112</span> -<span class="nu0">50</span>;<span class="nu0">78</span> <span class="nu0">76</span> <span class="nu0">85</span><span class="br0">]</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">vox</span> = func_vox_size; <span class="co1">%default [2 2 2]</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">1</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
&nbsp;
    D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>; <span class="co1">%if struct exist, it is also normalised</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'struct'</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="co1">%initialisation of .resample</span>
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span>=<span class="br0">[</span><span class="br0">]</span>;
        struct_img = <span class="br0">{</span>spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,<span class="co2">'struct'</span><span class="br0">)</span>, <span class="br0">[</span><span class="co2">'^s.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">}</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">resample</span> = struct_img;
&nbsp;
        <span class="co1">%source image is the T1 image</span>
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">source</span> = struct_img;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">subj</span>.<span class="me1">wtsrc</span> = <span class="br0">{</span><span class="br0">}</span>;
        <span class="co1">%template path</span>
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">template</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span> = <span class="br0">[</span>path_spm8 <span class="co2">'\templates\T1.nii,1'</span><span class="br0">]</span>;
        <span class="co1">%other parameters</span>
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">weight</span> = <span class="br0">{</span><span class="br0">}</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smosrc</span> = <span class="nu0">8</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">smoref</span> = <span class="nu0">0</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">regtype</span> = <span class="co2">'mni'</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">cutoff</span> = <span class="nu0">25</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">nits</span> = <span class="nu0">16</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">eoptions</span>.<span class="me1">reg</span> = <span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">preserve</span> = <span class="nu0">0</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">bb</span> = <span class="br0">[</span>-<span class="nu0">78</span> -<span class="nu0">112</span> -<span class="nu0">50</span>;<span class="nu0">78</span> <span class="nu0">76</span> <span class="nu0">85</span><span class="br0">]</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">vox</span> = anat_vox_size; <span class="co1">%default [1 1 1]</span>
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">interp</span> = <span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">normalise</span>.<span class="me1">estwrite</span>.<span class="me1">roptions</span>.<span class="me1">wrap</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'normalize'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
    move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'w'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> smoothing<span class="br0">(</span>suj_path, im_style<span class="br0">)</span>
<span class="co1">%%%searches in path for sessions, smooths images indicated by im_style,</span>
<span class="co1">%%%writes new files prefixed by 's' and moves them into a folder 's...', which</span>
<span class="co1">%%%is located at the same level as 'f'</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
<span class="kw1">global</span> Session_filter im_format smooth_filter;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">smooth</span>.<span class="me1">data</span>=<span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        im_sess = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,im_style<span class="br0">)</span>;
        this_session_images=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><span class="br0">[</span>im_sess <span class="co2">'\'</span><span class="br0">]</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span> spm_select<span class="br0">(</span><span class="co2">'List'</span>,im_sess,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">smooth</span>.<span class="me1">data</span>=<span class="br0">[</span>matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">smooth</span>.<span class="me1">data</span> <span class="br0">{</span>this_session_images<span class="br0">{</span><span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">}</span><span class="br0">}</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">smooth</span>.<span class="me1">fwhm</span>                          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>smooth_filter,<span class="nu0">1</span>,<span class="nu0">3</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">spatial</span>.<span class="me1">smooth</span>.<span class="me1">dtype</span>                         = <span class="nu0">0</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'smooth'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
    move_files<span class="br0">(</span>suj_path,im_style,<span class="br0">[</span><span class="co2">'s'</span> im_style<span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%Auxiliary Functions%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> move_files<span class="br0">(</span>suj_path,source_style,dest_style<span class="br0">)</span>
<span class="co1">%%% moves files with source_style (e.g. swaf) from path (e.g. waf) to new</span>
<span class="co1">%%% destination defined by dest_style</span>
<span class="kw1">global</span> Session_filter im_format;
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session_filter<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> ~isempty<span class="br0">(</span>Session<span class="br0">)</span>
    <span class="kw1">for</span> iii=<span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Session<span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>im_format,<span class="co2">'nii'</span><span class="br0">)</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>source_style,<span class="co2">'f'</span><span class="br0">)</span><span class="co1">%$$$$ f img are not in a specific dir</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">else</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>source_style,<span class="co2">'f'</span><span class="br0">)</span><span class="co1">%$$$$ f img are not in a specific dir</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,<span class="br0">[</span>dest_style <span class="co2">'*.hdr'</span><span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">else</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.'</span> im_format<span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
                movefile<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,source_style,<span class="br0">[</span>dest_style <span class="co2">'*.hdr'</span><span class="br0">]</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>suj_path,Session<span class="br0">{</span>iii<span class="br0">}</span>,dest_style<span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> dirs = get_directories<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">% returns a cell array holding true directories located at path</span>
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
dirs=<span class="br0">{</span>D<span class="br0">(</span>~<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'.'</span><span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'..'</span><span class="br0">)</span>+~<span class="br0">[</span>D.<span class="me1">isdir</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">name</span><span class="br0">}</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>

You must have a structure like <strong>…main_dir\populations\subjects\scans\sessions\f*img</strong>
</p>

<p>
If you have a structural image for the subject, it should be in a structure like: <strong>…main_dir\populations\subjects\scans\struct\s*img</strong><br>

If you have no structural image, do not create the dir 'struct' and the coregistration will not be processed.
</p>

<p>
It will create \af \waf and \swaf folders with the processed images.<br>

</p>

<p>
Processing include:
</p>
<ol>
<li class="level1"><div class="li"> realignment (with option to realign on mean or first scan of session)<br>
</div>
</li>
<li class="level2"><div class="li"> coregistration (if struct image exists)<br>
</div>
</li>
<li class="level2"><div class="li"> slice timing (suggested for TR &gt; 2.5s)<br>
</div>
</li>
<li class="level2"><div class="li"> normalization (on EPI template with 
voxel size of [3 3 3]mm for functional images and on T1 template with 
voxel size of [1 1 1]mm for struct image)<br>
</div>
</li>
<li class="level2"><div class="li"> smoothing (Gaussian filter of 8 mm).<br>
</div>
</li>
</ol>

<p>

<strong>These steps can be now specified line 28 and options for each line 29 to 33</strong>.
</p>

<p>
You must specify some details of your study in lines 23 to 33 of the 
function. If you have specific names or specific order for sessions, 
specify it at the end of this function.<br>

</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

</div>
<div class="secedit editbutton_section editbutton_3"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Preprocessing] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="39807-69273" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Preprocessing" type="submit"></div></form></div>
<h2 class="sectionedit4"><a name="first_level_analysis" id="first_level_analysis">First Level Analysis</a></h2>
<div class="level2">

<p>

<strong><em>updated by YC on 17th Dec 2009</em></strong>
</p>

<p>
<strong>Works with spm8 without adaptation</strong>
</p>
<p><a title="reveal" class="folder " href="#folded_5"> SPM5 or SPM8 : save this function as Labnic_1st_analysis.m</a></p><div class="folded  hidden" id="folded_5">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=4" title="Download Snippet" class="mediafile mf_m">Labnic_1st_analysis.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_analyse
<span class="co1">% analysing of the subjects you will define:</span>
<span class="co1">% you must have a structure like</span>
<span class="co1">% **...\data_fMRI\populations\subjects\scans\sessions\swaf\**</span>
<span class="co1">% your behavioral data are in a matrix begining by ONS in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\behavior\**</span>
<span class="co1">% your analysis will be in :</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% for your processed images.</span>
&nbsp;
<span class="co1">% this function has been adapted by Yann Cojan (yann.cojan@unige.ch)</span>
<span class="co1">% improved by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> TR Session_filter im_format Cnam ons_unit name_ana Ons;
<span class="co1">% defaults.modality = 'FMRI';</span>
&nbsp;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
TR = <span class="nu0">1.7</span>;
im_format = <span class="co2">'nii'</span>; <span class="co1">%or 'img';</span>
Session_filter =<span class="co2">'*RUN*'</span>; <span class="co1">%name of the study in the directory of the sessions</span>
root_path = <span class="co2">'C:\experiments\FLANKER'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana'</span>; <span class="co1">%or 'ana2'; etc</span>
ons_unit = <span class="co2">'secs'</span>; <span class="co1">%or 'scans';</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% analysis</span>
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    <span class="co1">% go to the population folder</span>
    Pop<span class="br0">{</span>pop<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,:<span class="br0">)</span><span class="br0">)</span>;
    sep_pop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>filesep,Pop<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>;
    popu = Pop<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,sep_pop<span class="br0">(</span>end-<span class="nu0">1</span><span class="br0">)</span>+<span class="nu0">1</span>:sep_pop<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
        <span class="co1">%create the subject's analyse folder</span>
        sufolder= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
        sep_suj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>filesep,Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
        sujet = Subject<span class="br0">(</span>sub,sep_suj<span class="br0">(</span>end-<span class="nu0">1</span><span class="br0">)</span>+<span class="nu0">1</span>:sep_suj<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>-<span class="nu0">1</span><span class="br0">)</span>;
        su = Subject<span class="br0">(</span>sub,sep_suj<span class="br0">(</span>end-<span class="nu0">1</span><span class="br0">)</span>+<span class="nu0">2</span>:sep_suj<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>-<span class="nu0">1</span><span class="br0">)</span>;
        <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><span class="br0">[</span>sufolder <span class="co2">'analyse'</span> filesep<span class="br0">]</span>,<span class="co2">'dir'</span><span class="br0">)</span>;
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span>sufolder, <span class="co2">'analyse'</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><span class="br0">[</span>sufolder <span class="co2">'analyse'</span> filesep<span class="br0">]</span>,name_ana<span class="br0">)</span>;
        wkdir=<span class="br0">[</span>sufolder <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> wkdir<span class="br0">]</span><span class="br0">)</span>;
&nbsp;
        <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
        <span class="co1">% read the behavior files to define onsets and conditions</span>
        <span class="co1">% this is the tricky part of reading the behavior files,</span>
        <span class="co1">% contact the script writers for help....</span>
&nbsp;
        <span class="co1">%[Ons Cnam] = readres_FLANKER_missed_pooled([sufolder 'behavior' filesep],su);</span>
        <span class="co1">%% onsets definition</span>
        <span class="co1">% load your ONS* mat in the behavior directory</span>
        <span class="co1">% ONS = spm_select('List',[path 'behavior'],strcat('^ONS+.+\.mat$'));</span>
        <span class="co1">% cd([path 'behavior']);</span>
        <span class="co1">% load(ONS);</span>
        <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
&nbsp;
        <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
        <span class="co1">% do the 1st level analysis for each subject</span>
        ana<span class="br0">(</span>sufolder<span class="br0">)</span>;
        <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% FUNCTION SECTION</span>
&nbsp;
<span class="co1">%% function analyse</span>
<span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = ana<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="kw1">global</span> TR Session_filter im_format Cnam Ons ons_unit name_ana;
&nbsp;
<span class="co1">% select the sessions of interest</span>
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span><span class="br0">[</span>suj_path <span class="co2">'scans'</span><span class="br0">]</span>,Session_filter<span class="br0">)</span><span class="br0">)</span>;
nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Session,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% select swaf images for each Session</span>
<span class="co1">%===================================================================</span>
im_style = <span class="co2">'swaf'</span>;
image_filter = <span class="co2">'*swaf*'</span>;
nscans = <span class="br0">[</span><span class="br0">]</span>;
SPM.<span class="me1">xY</span>.<span class="me1">P</span> = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">% selection of the swaf img of each session</span>
<span class="co1">%===================================================================</span>
<span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
    smoothfolder = <span class="br0">[</span>suj_path <span class="co2">'scans'</span> filesep <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span> filesep <span class="co2">'swaf'</span> filesep<span class="br0">]</span>;
    tmp<span class="br0">{</span>ses<span class="br0">}</span> = spm_select<span class="br0">(</span><span class="co2">'List'</span>,smoothfolder,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>;
    nscans = <span class="br0">[</span>nscans <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>tmp<span class="br0">{</span>ses<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">]</span>;
    SPM.<span class="me1">xY</span>.<span class="me1">P</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strvcat.html"><span class="kw2">strvcat</span></a><span class="br0">(</span>SPM.<span class="me1">xY</span>.<span class="me1">P</span>,<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>smoothfolder,nscans<span class="br0">(</span>ses<span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,tmp<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
SPM.<span class="me1">nscan</span>   = nscans;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span><span class="br0">[</span>suj_path <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% building matrix</span>
<span class="co1">%====================================================================</span>
<span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
    nconds=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Cnam<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span>;
    <span class="kw1">for</span> c=<span class="nu0">1</span>:nconds
        SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">U</span><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">name</span>      = <span class="br0">{</span>Cnam<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">{</span>c<span class="br0">}</span><span class="br0">}</span>;
        SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">U</span><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">ons</span>       = Ons<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">{</span>c<span class="br0">}</span>;
        SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">U</span><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">dur</span>       = <span class="nu0">0</span>;
&nbsp;
        <span class="co1">% define the parametric modulation according to your sessions</span>
        <span class="co1">% (comment the adequate modulation: parametric modulation(if you</span>
        <span class="co1">% already specify it before), or time modulation (nothing to</span>
        <span class="co1">% specify in modul) or none (nothing to specify in modul)</span>
        <span class="co1">%% parametric modulation</span>
        <span class="co1">%         SPM.Sess(ses).U(c).P(1).name ='modul';</span>
        <span class="co1">%         SPM.Sess(ses).U(c).P(1).i = [1 2];</span>
        <span class="co1">%         SPM.Sess(ses).U(c).P(1).P = eval(modul{ses}{c});</span>
        <span class="co1">%         SPM.Sess(ses).U(c).P(1).h = 1;</span>
        <span class="co1">%% time modulation</span>
        <span class="co1">%             SPM.Sess(ses).U(c).P(1).name ='time';</span>
        <span class="co1">%             SPM.Sess(ses).U(c).P(1).i = [1 2];</span>
        <span class="co1">%             SPM.Sess(ses).U(c).P(1).P = eval(Cnam{ses}{c});</span>
        <span class="co1">%             SPM.Sess(ses).U(c).P(1).h = 1;</span>
        <span class="co1">%% no modulation</span>
        SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">U</span><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">P</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'none'</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">% multiple regressors for mvts parameters</span>
<span class="co1">%===================================================================</span>
rnam = <span class="br0">{</span><span class="co2">'X'</span>,<span class="co2">'Y'</span>,<span class="co2">'Z'</span>,<span class="co2">'x'</span>,<span class="co2">'y'</span>,<span class="co2">'z'</span><span class="br0">}</span>;
<span class="kw1">for</span> ses=<span class="nu0">1</span>:nses
    fn = spm_select<span class="br0">(</span><span class="co2">'List'</span>,<span class="br0">[</span>suj_path <span class="co2">'scans'</span> filesep <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span><span class="br0">]</span>,<span class="br0">[</span><span class="co2">'^rp_.*txt'</span><span class="br0">]</span><span class="br0">)</span>;
    <span class="br0">[</span>r1,r2,r3,r4,r5,r6<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/textread.html"><span class="kw2">textread</span></a><span class="br0">(</span><span class="br0">[</span>suj_path <span class="co2">'scans'</span> filesep <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span> filesep fn<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">]</span>,<span class="co2">'%f%f%f%f%f%f'</span><span class="br0">)</span>;
    SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">C</span>.<span class="me1">C</span> = <span class="br0">[</span>r1 r2 r3 r4 r5 r6<span class="br0">]</span>;
    SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">C</span>.<span class="me1">name</span> = rnam;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% basis functions and timing parameters</span>
<span class="co1">%====================================================================</span>
defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t</span>   = <span class="nu0">16</span>;
defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t0</span>  = <span class="nu0">8</span>;
&nbsp;
SPM.<span class="me1">xY</span>.<span class="me1">RT</span>          = TR;
SPM.<span class="me1">xBF</span>.<span class="me1">name</span>       = <span class="co2">'hrf'</span>;             <span class="co1">% 'hrf (with time derivative)'</span>
SPM.<span class="me1">xBF</span>.<span class="me1">order</span>      = <span class="nu0">1</span>;                 <span class="co1">% 2 = hrf + time deriv</span>
SPM.<span class="me1">xBF</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a>     = <span class="nu0">32</span>;                <span class="co1">% length in seconds</span>
&nbsp;
<span class="co1">% find number of slices</span>
<span class="co1">%====================================================================</span>
V  = spm_vol<span class="br0">(</span>SPM.<span class="me1">xY</span>.<span class="me1">P</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> iscell<span class="br0">(</span>V<span class="br0">)</span>
    nslices = V<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
<span class="kw1">else</span>
    nslices = V<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
<span class="kw1">end</span>
ref_slice          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/floor.html"><span class="kw2">floor</span></a><span class="br0">(</span>nslices/<span class="nu0">2</span><span class="br0">)</span>;	<span class="co1">% middle slice in time</span>
SPM.<span class="me1">xBF</span>.<span class="me1">T</span>          = defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t</span>;        <span class="co1">% number of time bins per scan  % useless? cf. defaults above</span>
SPM.<span class="me1">xBF</span>.<span class="me1">T0</span>         = defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t</span>/<span class="nu0">2</span>;		    <span class="co1">% middle slice/timebin          % useless? cf. defaults above</span>
SPM.<span class="me1">xBF</span>.<span class="me1">UNITS</span>      = ons_unit;           <span class="co1">% OPTIONS: 'scans'|'secs' for onsets</span>
SPM.<span class="me1">xBF</span>.<span class="me1">Volterra</span>   = <span class="nu0">1</span>;                 <span class="co1">% OPTIONS: 1|2 = order of convolution</span>
&nbsp;
<span class="co1">% global normalization: OPTIONS:'Scaling'|'None'</span>
<span class="co1">%---------------------------------------------------------------------------</span>
SPM.<span class="me1">xGX</span>.<span class="me1">iGXcalc</span>    = <span class="co2">'None'</span>;
&nbsp;
<span class="co1">% low frequency confound: high-pass cutoff (secs) [Inf = no filtering]</span>
<span class="co1">%---------------------------------------------------------------------------</span>
SPM.<span class="me1">xX</span>.<span class="me1">K</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">HParam</span> = <span class="nu0">128</span>;
&nbsp;
<span class="co1">% intrinsic autocorrelations: OPTIONS: 'none'|'AR(1) + w'</span>
<span class="co1">%-----------------------------------------------------------------------</span>
SPM.<span class="me1">xVi</span>.<span class="me1">form</span>       = <span class="co2">'AR(1)'</span>; <span class="co1">%AR(0.2)???? SOSART</span>
&nbsp;
<span class="co1">% specify SPM working dir for this sub</span>
<span class="co1">%===========================================================================</span>
SPM.<span class="me1">swd</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>;
&nbsp;
<span class="co1">% Configure design matrix</span>
<span class="co1">%===========================================================================</span>
SPM = spm_fmri_spm_ui<span class="br0">(</span>SPM<span class="br0">)</span>;
&nbsp;
<span class="co1">% Estimate parameters</span>
<span class="co1">%==========================================================================</span>
SPM = spm_spm<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> dirs = get_directories<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">% returns a cell array holding true directories located at path</span>
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
dirs=<span class="br0">{</span>D<span class="br0">(</span>~<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'.'</span><span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'..'</span><span class="br0">)</span>+~<span class="br0">[</span>D.<span class="me1">isdir</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">name</span><span class="br0">}</span>;
<span class="co1">% dirs = {'morphing_titrage_run1',...</span>
<span class="co1">%         'morphing_titrage_run2',...</span>
<span class="co1">%         'morphing_test_run5',...</span>
<span class="co1">%         'morphing_faceloc_run11'};</span>
&nbsp;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
<strong><em>updated by YC on 24th Jan 2012</em></strong>
</p>

<p>
if you want to be able to launch the batch in spm8 use this one:

</p>
<p><a title="reveal" class="folder " href="#folded_6"> SPM8 : save this function as Labnic_1stlevel_spm8.m</a></p><div class="folded  hidden" id="folded_6">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=5" title="Download Snippet" class="mediafile mf_m">Labnic_1stlevel_spm8.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_1stlevel_spm8
<span class="co1">% analysing of the subjects you will define:</span>
<span class="co1">% you must have a structure like</span>
<span class="co1">% **...\data_fMRI\populations\subjects\scans\sessions\swaf\**</span>
<span class="co1">% your behavioral data are in a matrix begining by ONS in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\behavior\**</span>
<span class="co1">% your analysis will be in :</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% for your processed images.</span>
&nbsp;
<span class="co1">% this function has been adapted by Yann Cojan (yann.cojan@unige.ch)</span>
<span class="co1">% improved by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> <span class="kw1">global</span>
<span class="kw1">global</span> TR Session_filter im_format Cnam ons_unit name_ana Ons Modul;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
TR = <span class="nu0">1.7</span>;
im_format = <span class="co2">'nii'</span>; <span class="co1">%or 'img';</span>
Session_filter =<span class="co2">'*ATTHYPNO_RUN*'</span>; <span class="co1">%name of the study in the directory of the sessions</span>
root_path = <span class="co2">'F:\FLANKER'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana_E_CI_parametric_1back_2mm'</span>; <span class="co1">%or 'ana2'; etc</span>
ons_unit = <span class="co2">'secs'</span>; <span class="co1">%or 'scans';</span>
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span><span class="br0">[</span>root_path <span class="co2">'\controls'</span><span class="br0">]</span><span class="br0">)</span>
Subject<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
&nbsp;
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% analysis</span>
<span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
    <span class="co1">%create the subject's analyse folder</span>
    sufolder= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
    sep_suj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'\'</span>,Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
    su = Subject<span class="br0">(</span>sub,sep_suj<span class="br0">(</span>end-<span class="nu0">1</span><span class="br0">)</span>+<span class="nu0">2</span>:sep_suj<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>-<span class="nu0">1</span><span class="br0">)</span>;
    <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><span class="br0">[</span>sufolder <span class="co2">'analyse\'</span><span class="br0">]</span>,<span class="co2">'dir'</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span>sufolder, <span class="co2">'analyse\'</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><span class="br0">[</span>sufolder <span class="co2">'analyse\'</span><span class="br0">]</span>,name_ana<span class="br0">)</span>;
    wkdir=<span class="br0">[</span>sufolder <span class="co2">'analyse\'</span> name_ana<span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> wkdir<span class="br0">]</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="co1">% read the behavior files to define onsets and conditions</span>
    <span class="co1">% this is the tricky part of reading the behavior files,</span>
    <span class="co1">% contact the script writers for help....</span>
    <span class="br0">[</span>Ons Modul Cnam<span class="br0">]</span> = readres_flanker_E_CI_parametric<span class="br0">(</span><span class="br0">[</span>sufolder <span class="co2">'behavior\'</span><span class="br0">]</span>,su<span class="br0">)</span>;
    <span class="co1">%% onsets definition</span>
    <span class="co1">% load your ONS* mat in the behavior directory</span>
    <span class="co1">% ONS = spm_select('List',[path 'behavior'],strcat('^ONS+.+\.mat$'));</span>
    <span class="co1">% cd([path 'behavior']);</span>
    <span class="co1">% load(ONS);</span>
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
&nbsp;
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="co1">% do the 1st level analysis for each subject</span>
    ana<span class="br0">(</span>sufolder<span class="br0">)</span>;
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="co1">% do the 1st level analysis for each subject</span>
    con<span class="br0">(</span>sufolder<span class="br0">)</span>;
    <span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% FUNCTION SECTION</span>
&nbsp;
<span class="co1">%% function analyse</span>
<span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = ana<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="kw1">global</span> TR Session_filter im_format Cnam Ons ons_unit name_ana Modul;
&nbsp;
<span class="co1">% select the sessions of interest</span>
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span><span class="br0">[</span>suj_path <span class="co2">'scans'</span><span class="br0">]</span>,Session_filter<span class="br0">)</span><span class="br0">)</span>;
nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Session,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% select swaf images for each Session</span>
<span class="co1">%===================================================================</span>
im_style = <span class="co2">'swf'</span>;
nscans = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span><span class="br0">[</span>suj_path <span class="co2">'analyse\'</span> name_ana <span class="co2">'\'</span><span class="br0">]</span><span class="br0">}</span>;
&nbsp;
&nbsp;
<span class="co1">% selection of the swaf img of each session</span>
<span class="co1">%===================================================================</span>
<span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'scans'</span>,<span class="br0">[</span><span class="br0">]</span>,<span class="co2">'cond'</span>,<span class="br0">[</span><span class="br0">]</span>,<span class="co2">'multi'</span>,<span class="br0">{</span><span class="br0">{</span><span class="co2">''</span><span class="br0">}</span><span class="br0">}</span>,<span class="co2">'regress'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'name'</span>,<span class="br0">{</span><span class="br0">}</span>,<span class="co2">'val'</span>,<span class="br0">{</span><span class="br0">}</span><span class="br0">)</span>,<span class="co2">'multi_reg'</span>,<span class="br0">[</span><span class="br0">]</span>,<span class="co2">'hpf'</span>,<span class="nu0">128</span><span class="br0">)</span>;
    smoothfolder = <span class="br0">[</span>suj_path <span class="co2">'scans\'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span> <span class="co2">'\swf'</span><span class="br0">]</span>;
    tmp<span class="br0">{</span>ses<span class="br0">}</span> = spm_select<span class="br0">(</span><span class="co2">'ExtFPList'</span>,smoothfolder,<span class="br0">[</span><span class="co2">'^'</span> im_style <span class="co2">'.*'</span> im_format<span class="br0">]</span><span class="br0">)</span>;
    nscans = <span class="br0">[</span>nscans <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>tmp<span class="br0">{</span>ses<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">]</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">scans</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellstr.html"><span class="kw2">cellstr</span></a><span class="br0">(</span>tmp<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% building matrix</span>
    <span class="co1">%====================================================================</span>
    nconds=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Cnam<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span>;
    <span class="kw1">for</span> c=<span class="nu0">1</span>:nconds
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">name</span>      = Cnam<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">{</span>c<span class="br0">}</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">onset</span>     = Ons<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">{</span>c<span class="br0">}</span>;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">duration</span>  = <span class="nu0">0</span>;
&nbsp;
        <span class="co1">% no modulation</span>
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">tmod</span> = <span class="nu0">0</span>;<span class="co1">%1 for time modulation </span>
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">(</span>c<span class="br0">)</span>.<span class="me1">pmod</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'name'</span>,<span class="br0">{</span><span class="br0">}</span>,<span class="co2">'param'</span>,<span class="br0">{</span><span class="br0">}</span>,<span class="co2">'poly'</span>,<span class="br0">{</span><span class="br0">}</span><span class="br0">)</span>;
<span class="co1">%         % modulation</span>
<span class="co1">%         if c &lt; 3</span>
<span class="co1">%             count = 0;</span>
<span class="co1">%                 count = count +1;</span>
<span class="co1">%                 matlabbatch{1}.spm.stats.fmri_spec.sess(ses).cond(c).pmod(count).name ='preE';</span>
<span class="co1">%                 matlabbatch{1}.spm.stats.fmri_spec.sess(ses).cond(c).pmod(count).param = Modul{ses}{c}(:,1);</span>
<span class="co1">%                 matlabbatch{1}.spm.stats.fmri_spec.sess(ses).cond(c).pmod(count).poly = 1;</span>
<span class="co1">%         end</span>
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">% multiple regressors for mvts parameters</span>
    <span class="co1">%===================================================================</span>
    fn = spm_select<span class="br0">(</span><span class="co2">'FPList'</span>,<span class="br0">[</span>suj_path <span class="co2">'scans\'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span><span class="br0">]</span>,<span class="co2">'^rp_.*txt'</span><span class="br0">)</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">multi_reg</span> = <span class="br0">{</span>fn<span class="br0">}</span>;  
<span class="kw1">end</span>
&nbsp;
<span class="co1">% basis functions and timing parameters</span>
<span class="co1">%====================================================================</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">timing</span>.<span class="me1">fmri_t</span> = <span class="nu0">16</span>;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">timing</span>.<span class="me1">fmri_t0</span> = <span class="nu0">8</span>;
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">timing</span>.<span class="me1">RT</span> = TR;           <span class="co1">%TR</span>
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">bases</span>.<span class="me1">hrf</span>.<span class="me1">derivs</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>; <span class="co1">%time derivatives</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">timing</span>.<span class="me1">units</span> = ons_unit;  <span class="co1">% OPTIONS: 'scans'|'secs' for onsets</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">volt</span>   = <span class="nu0">1</span>;               <span class="co1">% OPTIONS: 1|2 = order of convolution</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">mask</span> = <span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;              <span class="co1">% explicit masking</span>
&nbsp;
<span class="co1">% global normalization: OPTIONS:'Scaling'|'None'</span>
<span class="co1">%---------------------------------------------------------------------------</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="kw1">global</span>    = <span class="co2">'None'</span>;
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">fact</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'name'</span>,<span class="br0">{</span><span class="br0">}</span>,<span class="co2">'levels'</span>,<span class="br0">{</span><span class="br0">}</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% intrinsic autocorrelations: OPTIONS: 'none'|'AR(1) + w'</span>
<span class="co1">%---------------------------------------------------------------------------</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<span class="me1">cvi</span>       = <span class="co2">'AR(1)'</span>; <span class="co1">%AR(0.2)???? SOSART</span>
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span>matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_spec</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span> <span class="co2">'\SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span>.<span class="me1">Classical</span> = <span class="nu0">1</span>;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> analyse matlabbatch
<span class="co1">% Configure &amp; Estimate</span>
<span class="co1">%==========================================================================</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = con<span class="br0">(</span>sudir<span class="br0">)</span>
<span class="kw1">global</span>  name_ana;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span><span class="br0">[</span>sudir <span class="co2">'\analyse\'</span> name_ana<span class="br0">]</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="co2">'SPM.mat'</span><span class="br0">)</span>;
SPM.<span class="me1">xCon</span> =<span class="br0">[</span><span class="br0">]</span>; <span class="co1">% reset xCon</span>
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">)</span><span class="co1">%adding 6 for mvt regressors that are in SPM.xX.name</span>
    b = strfind<span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
<span class="co1">%     connam{i} = SPM.xX.name{i}([7:b-1 end-1]);</span>
    connam<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> = SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;   
<span class="kw1">end</span>
&nbsp;
C = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'C'</span><span class="br0">)</span><span class="br0">)</span>; C_preE = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'CxpreE^1'</span><span class="br0">)</span><span class="br0">)</span>; C_postE = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'CxpostE^1'</span><span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2">I</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'I'</span><span class="br0">)</span><span class="br0">)</span>; I_preE = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'IxpreE^1'</span><span class="br0">)</span><span class="br0">)</span>; I_postE = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'IxpostE^1'</span><span class="br0">)</span><span class="br0">)</span>;
C_preE0 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'CxpreE0^1'</span><span class="br0">)</span><span class="br0">)</span>; C_postE0 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'CxpostE0^1'</span><span class="br0">)</span><span class="br0">)</span>;
I_preE0 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'IxpreE0^1'</span><span class="br0">)</span><span class="br0">)</span>; I_postE0 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'IxpostE0^1'</span><span class="br0">)</span><span class="br0">)</span>;
EC = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'EC'</span><span class="br0">)</span><span class="br0">)</span>;
EI = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'EI'</span><span class="br0">)</span><span class="br0">)</span>;
<span class="co1">%----------</span>
<span class="co1">%F TASK</span>
<span class="co1">%----------</span>
cn=<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F-task'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span>C;I;EC;EI<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F'</span>;
&nbsp;
<span class="co1">%% main effects</span>
cn=cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = C;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn=cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'I'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2">I</span></a>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> contrasts_name Cnames
<span class="kw1">for</span> c = <span class="nu0">1</span>:cn
    cw = <span class="br0">[</span>cwgt<span class="br0">{</span>c<span class="br0">}</span><span class="br0">]</span>';	<span class="co1">% pad with zero for constant</span>
    tmp<span class="br0">(</span>c<span class="br0">)</span>     = spm_FcUtil<span class="br0">(</span><span class="co2">'Set'</span>,Cnames<span class="br0">{</span>c<span class="br0">}</span>,ctyp<span class="br0">{</span>c<span class="br0">}</span>,<span class="co2">'c'</span>,cw,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span><span class="br0">)</span>;
<span class="kw1">end</span>
SPM.<span class="me1">xCon</span> = tmp;
<span class="co1">%save SPM SPM and evaluate---------------------------------------------------------------------------</span>
SPM = spm_contrasts<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> dirs = get_directories<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">% returns a cell array holding true directories located at path</span>
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
dirs=<span class="br0">{</span>D<span class="br0">(</span>~<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'.'</span><span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'..'</span><span class="br0">)</span>+~<span class="br0">[</span>D.<span class="me1">isdir</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">name</span><span class="br0">}</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
You must specify some details of your study in lines 19 to 24 of the 
function. If you have specific names or specific order for sessions, 
specify it at the end of this function.
</p>

<p>
Between lines 58-68, you have to specify how to load onsets and 
conditions of your experiments. Several choices are possible (reading 
eprime files, creating ons.mat  and loading them, etc…). For help on 
this topic, please contact anyone who has already the script running, 
Yann Cojan (yann.cojan@unige.ch) or Virginie Sterpenich 
(virginie.sterpenich@unige.ch).
</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

<p>
<strong>for connectivity fans… PPIs</strong>
</p>
<p><a title="reveal" class="folder " href="#folded_7"> SPM8 : save this function as Labnic_PPI_spm8.m</a></p><div class="folded  hidden" id="folded_7">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=6" title="Download Snippet" class="mediafile mf_m">Labnic_PPI_spm8.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_PPI_spm8
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">%%</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="kw1">global</span> Session_filter scandir namevar psyconvar rad_sphere TR nslices region
&nbsp;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
mypoints =  <span class="br0">[</span><span class="nu0">42</span> -<span class="nu0">43</span> -<span class="nu0">23</span><span class="br0">]</span>; <span class="co1">%% seed voxel</span>
region = <span class="co2">'rFFA'</span>; <span class="co1">%% region corresponding to the voxel</span>
namevar=<span class="br0">{</span><span class="co2">'Cf'</span> <span class="co2">'If'</span> <span class="co2">'Cs'</span> <span class="co2">'Is'</span><span class="br0">}</span>;
psyconvar=<span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
root_path = <span class="co2">'C:\experiments\FLANKER\'</span>; <span class="co1">% directory where are the populations, main directory</span>
anadir = <span class="co2">'ana_woST\'</span>; <span class="co1">%or 'ana2'; etc</span>
Session_filter = <span class="co2">'*ATTHYPNO_RUN*'</span>;
rad_sphere = <span class="nu0">8</span>; <span class="co1">% radius of the sphere in mm</span>
TR = <span class="nu0">1.7</span>; <span class="co1">% your TR</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
mycon=<span class="nu0">1</span>; <span class="co1">%will take the F-task contrast (1) to define the conditions of the task</span>
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>
    su = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
    scandir = <span class="br0">[</span>su <span class="co2">'scans'</span><span class="br0">]</span>;
&nbsp;
    xyz= mypoints;
    path_ana =<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>,<span class="co2">'analyse'</span>,anadir<span class="br0">)</span>;
    <span class="br0">[</span>SPM,xSPM<span class="br0">]</span> = spm_getSPM_PPI<span class="br0">(</span>path_ana,mycon<span class="br0">)</span>;
&nbsp;
    <span class="co1">% find number of slices</span>
<span class="co1">%====================================================================</span>
V  = spm_vol<span class="br0">(</span>SPM.<span class="me1">xY</span>.<span class="me1">P</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> iscell<span class="br0">(</span>V<span class="br0">)</span>
    nslices = V<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
<span class="kw1">else</span>
    nslices = V<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dim</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
    XYZ  = SPM.<span class="me1">xVol</span>.<span class="me1">XYZ</span>;
    XYZmm = SPM.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,:<span class="br0">)</span>*<span class="br0">[</span>XYZ; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>XYZ,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="br0">[</span>xyz,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'NearestXYZ'</span>,xyz,XYZmm<span class="br0">)</span>;
&nbsp;
    <span class="co1">%% extract neural signal from seed region</span>
    myPPI = spm_regions_PPI<span class="br0">(</span>SPM,xSPM,xyz<span class="br0">)</span>;
&nbsp;
    <span class="co1">%% create a new model and estimates it</span>
    Labnic_analyse_PPI<span class="br0">(</span>su,myPPI,region<span class="br0">)</span>;
&nbsp;
    <span class="co1">%% make the contrasts</span>
    Labnic_contrast_PPI<span class="br0">(</span>su,region<span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="kw1">return</span>
&nbsp;
<span class="co1">%% subfunctions</span>
<span class="kw1">function</span> dirs = get_directories<span class="br0">(</span>suj_path<span class="br0">)</span>
<span class="co1">% returns a cell array holding true directories located at path</span>
D=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>suj_path<span class="br0">)</span>;
dirs=<span class="br0">{</span>D<span class="br0">(</span>~<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'.'</span><span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span><span class="br0">{</span>D.<span class="me1">name</span><span class="br0">}</span>,<span class="co2">'..'</span><span class="br0">)</span>+~<span class="br0">[</span>D.<span class="me1">isdir</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">name</span><span class="br0">}</span>;
<span class="co1">% dirs = {'morphing_titrage_run1',...</span>
<span class="co1">%         'morphing_titrage_run2',...</span>
<span class="co1">%         'morphing_test_run5',...</span>
<span class="co1">%         'morphing_faceloc_run11'};</span>
&nbsp;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> PPI = Labnic_extract_PPI<span class="br0">(</span>SPM, myvoi,psyconvar,namevar<span class="br0">)</span>
<span class="co1">% Bold deconvolution to create physio- or psycho-physiologic interactions</span>
&nbsp;
&nbsp;
<span class="co1">% check inputs and set up variables</span>
<span class="co1">%----------------------------------------------------------------------</span>
RT     = SPM.<span class="me1">xY</span>.<span class="me1">RT</span>;
dt     = SPM.<span class="me1">xBF</span>.<span class="me1">dt</span>;
NT     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/round.html"><span class="kw2">round</span></a><span class="br0">(</span>RT/dt<span class="br0">)</span>;
&nbsp;
&nbsp;
<span class="co1">% Ask whether to perform physiophysiologic or psychophysiologic interactions</span>
<span class="co1">%--------------------------------------------------------------------------</span>
<span class="co1">% set(Finter,'name','PPI Setup')</span>
<span class="co1">% ppiflag    = 'psychophysiologic interaction';</span>
&nbsp;
<span class="co1">% case  'psychophysiologic interaction'  % get hemodynamic response</span>
<span class="co1">%=====================================================================</span>
<span class="co1">%     spm_input('physiological variable:...  ',2,'d');</span>
<span class="co1">%     P      = spm_get(1,'VOI*.mat',{'select VOIs'});</span>
P = myvoi;
p      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span>P,<span class="co2">'xY'</span><span class="br0">)</span>;
xY<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>  = p.<span class="me1">xY</span>;
Sess   = SPM.<span class="me1">Sess</span><span class="br0">(</span>xY<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">Sess</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% get 'causes' or inputs U</span>
<span class="co1">%----------------------------------------------------------------------</span>
<span class="co1">%spm_input('Psychological variable:...  ',2,'d');</span>
U.<span class="me1">name</span> = <span class="br0">{</span><span class="br0">}</span>;
U.<span class="me1">u</span>    = <span class="br0">[</span><span class="br0">]</span>;
U.<span class="me1">w</span>    = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Sess.<span class="me1">U</span><span class="br0">)</span>
    Name<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span> = Sess.<span class="me1">U</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">name</span>;
<span class="kw1">end</span>
count = <span class="nu0">0</span>;
<span class="kw1">for</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>namevar<span class="br0">)</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>namevar<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>,Name<span class="br0">)</span><span class="br0">)</span>;
        count = count +<span class="nu0">1</span>;
        mypsyconvar = psyconvar<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
        <span class="kw1">for</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Sess.<span class="me1">U</span><span class="br0">(</span>count<span class="br0">)</span>.<span class="me1">name</span><span class="br0">)</span>
            U.<span class="me1">u</span>             = <span class="br0">[</span>U.<span class="me1">u</span> Sess.<span class="me1">U</span><span class="br0">(</span>count<span class="br0">)</span>.<span class="me1">u</span><span class="br0">(</span><span class="nu0">33</span>:<span class="kw1">end</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span>;<span class="co1">% don't understand</span>
            U.<span class="me1">name</span><span class="br0">{</span><span class="kw1">end</span> + <span class="nu0">1</span><span class="br0">}</span> = Sess.<span class="me1">U</span><span class="br0">(</span>count<span class="br0">)</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>;
            U.<span class="me1">w</span>             = <span class="br0">[</span>U.<span class="me1">w</span> mypsyconvar<span class="br0">]</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>U.<span class="me1">w</span><span class="br0">)</span> &lt; <span class="nu0">0</span>
    U.<span class="me1">w</span><span class="br0">(</span>U.<span class="me1">w</span> == <span class="nu0">1</span><span class="br0">)</span> = <span class="nu0">4</span>/<span class="br0">(</span><span class="nu0">4</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>U.<span class="me1">w</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% name of PPI file to be saved</span>
<span class="co1">%-------------------------------------------------------------------------</span>
<span class="br0">[</span>tmp, myfile<span class="br0">]</span>= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>myvoi<span class="br0">)</span>;
PPI.<span class="me1">name</span>    = <span class="br0">[</span><span class="co2">'PPI_'</span> myfile<span class="br0">]</span>
&nbsp;
<span class="co1">% Setup variables</span>
<span class="co1">%-------------------------------------------------------------------------</span>
N     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>xY<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">u</span><span class="br0">)</span>;
k     = <span class="nu0">1</span>:NT:N*NT;  			<span class="co1">% microtime to scan time indices</span>
&nbsp;
<span class="co1">% create basis functions and hrf in scan time and microtime</span>
<span class="co1">%-------------------------------------------------------------------------</span>
<span class="co1">%spm('Pointer','watch')</span>
hrf   = spm_hrf<span class="br0">(</span>dt<span class="br0">)</span>;
&nbsp;
<span class="co1">% create convolved explanatory {Hxb} variables in scan time</span>
<span class="co1">%-------------------------------------------------------------------------</span>
xb    = spm_dctmtx<span class="br0">(</span>N*NT + <span class="nu0">128</span>,N<span class="br0">)</span>;
Hxb   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>N,N<span class="br0">)</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:N
    Hx       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/conv.html"><span class="kw2">conv</span></a><span class="br0">(</span>xb<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>,hrf<span class="br0">)</span>;
    Hxb<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span> = Hx<span class="br0">(</span>k + <span class="nu0">128</span><span class="br0">)</span>;
<span class="kw1">end</span>
xb    = xb<span class="br0">(</span><span class="nu0">129</span>:<span class="kw1">end</span>,:<span class="br0">)</span>;
&nbsp;
&nbsp;
<span class="co1">% get confounds (in scan time) and constant term</span>
<span class="co1">%-------------------------------------------------------------------------</span>
X0    = xY<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">X0</span>;
M     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>X0,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
&nbsp;
<span class="co1">% get response variable,</span>
<span class="co1">%-------------------------------------------------------------------------</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xY,<span class="nu0">2</span><span class="br0">)</span>
    Y<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span> = xY<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">u</span>;
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">% remove confounds and save Y in ouput structure</span>
<span class="co1">%-------------------------------------------------------------------------</span>
<span class="co1">% Yc    = Y - X0*inv(X0'*X0)*X0'*Y; %SOSART</span>
Yc    = Y - X0*<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pinv.html"><span class="kw2">pinv</span></a><span class="br0">(</span>X0'*X0<span class="br0">)</span>*X0'*Y;
PPI.<span class="me1">Y</span> = Yc<span class="br0">(</span>:,<span class="nu0">1</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Y,<span class="nu0">2</span><span class="br0">)</span> == <span class="nu0">2</span>
    PPI.<span class="me1">P</span>  = Yc<span class="br0">(</span>:,<span class="nu0">2</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">% specify covariance components; assume neuronal response is white</span>
<span class="co1">% treating confounds as fixed effects</span>
<span class="co1">%-------------------------------------------------------------------------</span>
Q      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/speye.html"><span class="kw2">speye</span></a><span class="br0">(</span>N,N<span class="br0">)</span>*N/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/trace.html"><span class="kw2">trace</span></a><span class="br0">(</span>Hxb'*Hxb<span class="br0">)</span>;
Q      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/blkdiag.html"><span class="kw2">blkdiag</span></a><span class="br0">(</span>Q, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/speye.html"><span class="kw2">speye</span></a><span class="br0">(</span>M,M<span class="br0">)</span>*1e6  <span class="br0">)</span>;
&nbsp;
<span class="co1">% get whitening matrix (NB: confounds have already been whitened)</span>
<span class="co1">%-------------------------------------------------------------------------</span>
W      = SPM.<span class="me1">xX</span>.<span class="me1">W</span><span class="br0">(</span>Sess.<span class="me1">row</span>,Sess.<span class="me1">row</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% create structure for spm_PEB</span>
<span class="co1">%-------------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> P
P<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">X</span> = <span class="br0">[</span>W*Hxb X0<span class="br0">]</span>;		<span class="co1">% Design matrix for lowest level</span>
P<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">C</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/speye.html"><span class="kw2">speye</span></a><span class="br0">(</span>N,N<span class="br0">)</span>/<span class="nu0">4</span>;		<span class="co1">% i.i.d assumptions</span>
P<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">X</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sparse.html"><span class="kw2">sparse</span></a><span class="br0">(</span>N + M,<span class="nu0">1</span><span class="br0">)</span>;	<span class="co1">% Design matrix for parameters (0's)</span>
P<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">C</span> = Q;
&nbsp;
&nbsp;
<span class="co1">% case  'psychophysiologic interaction'</span>
<span class="co1">%=====================================================================</span>
&nbsp;
<span class="co1">% COMPUTE PSYCHOPHYSIOLOGIC INTERACTIONS</span>
<span class="co1">% use basis set in microtime</span>
<span class="co1">%---------------------------------------------------------------------</span>
<span class="co1">% get parameter estimates and neural signal; beta (C) is in scan time</span>
<span class="co1">% This clever trick allows us to compute the betas in scan time which is</span>
<span class="co1">% much quicker than with the large microtime vectors. Then the betas</span>
<span class="co1">% are applied to a microtime basis set generating the correct neural</span>
<span class="co1">% activity to convolve with the psychological variable in mircrotime</span>
<span class="co1">%---------------------------------------------------------------------</span>
C       = spm_PEB<span class="br0">(</span>Y,P<span class="br0">)</span>;
xn      = xb*C<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">E</span><span class="br0">(</span><span class="nu0">1</span>:N<span class="br0">)</span>;
xn      = spm_detrend<span class="br0">(</span>xn<span class="br0">)</span>;
&nbsp;
<span class="co1">% setup psychological variable from inputs and contast weights</span>
<span class="co1">%---------------------------------------------------------------------</span>
PSY     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>N*NT,<span class="nu0">1</span><span class="br0">)</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>U.<span class="me1">u</span>,<span class="nu0">2</span><span class="br0">)</span>
    tmp = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/full.html"><span class="kw2">full</span></a><span class="br0">(</span>U.<span class="me1">u</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>*U.<span class="me1">w</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
    tmp = tmp<span class="br0">(</span><span class="nu0">1</span>:<span class="br0">(</span>N*NT<span class="br0">)</span><span class="br0">)</span>;
    PSY = PSY + tmp;
<span class="kw1">end</span>
PSY     = spm_detrend<span class="br0">(</span>PSY<span class="br0">)</span>;
&nbsp;
<span class="co1">% multiply psychological variable by neural signal</span>
<span class="co1">%---------------------------------------------------------------------</span>
PSYxn   = PSY.*xn;
&nbsp;
<span class="co1">% convolve and resample at each scan for bold signal</span>
<span class="co1">%---------------------------------------------------------------------</span>
ppi	    = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/conv.html"><span class="kw2">conv</span></a><span class="br0">(</span>PSYxn,hrf<span class="br0">)</span>;
ppi     = ppi<span class="br0">(</span>k<span class="br0">)</span>;
&nbsp;
<span class="co1">% similarly for psychological effect</span>
<span class="co1">%---------------------------------------------------------------------</span>
PSYHRF  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/conv.html"><span class="kw2">conv</span></a><span class="br0">(</span>PSY,hrf<span class="br0">)</span>;
PSYHRF  = PSYHRF<span class="br0">(</span>k<span class="br0">)</span>;
&nbsp;
<span class="co1">% save psychological variables</span>
<span class="co1">%---------------------------------------------------------------------</span>
PPI.<span class="me1">psy</span> = U;
PPI.<span class="me1">P</span>   = PSYHRF;
PPI.<span class="me1">xn</span>  = xn;
PPI.<span class="me1">ppi</span> = spm_detrend<span class="br0">(</span>ppi<span class="br0">)</span>;
&nbsp;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>myPPI<span class="br0">]</span> = spm_regions_PPI<span class="br0">(</span>SPM,xSPM,xyz<span class="br0">)</span>
xY.<span class="me1">xyz</span>  = xyz;
&nbsp;
<span class="kw1">global</span> Session_filter scandir psyconvar namevar rad_sphere
<span class="co1">%-Get adjustment options and VOI name</span>
<span class="co1">%-----------------------------------------------------------------------</span>
spm_input<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'at [%3.0f %3.0f %3.0f]'</span>,xY.<span class="me1">xyz</span><span class="br0">)</span>,<span class="nu0">1</span>,<span class="co2">'d'</span>,<span class="sy0">...</span>
    <span class="co2">'VOI time-series extraction'</span><span class="br0">)</span>
&nbsp;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>xY,<span class="co2">'name'</span><span class="br0">)</span>
    tmp = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>xyz'<span class="br0">)</span><span class="br0">)</span>;
    xY.<span class="me1">name</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strrep.html"><span class="kw2">strrep</span></a><span class="br0">(</span>tmp, <span class="co2">' '</span>,<span class="co2">''</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
xY.<span class="me1">Ic</span> = <span class="nu0">1</span>;
&nbsp;
xY.<span class="me1">def</span>    = <span class="co2">'sphere'</span>;
Q = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xSPM.<span class="me1">XYZmm</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> ~isfield<span class="br0">(</span>xY,<span class="co2">'spec'</span><span class="br0">)</span>
    xY.<span class="me1">spec</span> = rad_sphere; <span class="co1">% radius of the sphere</span>
<span class="kw1">end</span>
d = <span class="br0">[</span>xSPM.<span class="me1">XYZmm</span><span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span> - xyz<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>;
    xSPM.<span class="me1">XYZmm</span><span class="br0">(</span><span class="nu0">2</span>,:<span class="br0">)</span> - xyz<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>;
    xSPM.<span class="me1">XYZmm</span><span class="br0">(</span><span class="nu0">3</span>,:<span class="br0">)</span> - xyz<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span><span class="br0">]</span>;
Q = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>d.^<span class="nu0">2</span><span class="br0">)</span> &lt;= xY.<span class="me1">spec</span>^<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Get raw data, whiten and filter</span>
y        = spm_get_data<span class="br0">(</span>SPM.<span class="me1">xY</span>.<span class="me1">VY</span>,xSPM.<span class="me1">XYZ</span><span class="br0">(</span>:,Q<span class="br0">)</span><span class="br0">)</span>;
y        = spm_filter<span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">K</span>,SPM.<span class="me1">xX</span>.<span class="me1">W</span>*y<span class="br0">)</span>;
xY.<span class="me1">XYZmm</span> = xSPM.<span class="me1">XYZmm</span><span class="br0">(</span>:,Q<span class="br0">)</span>;
&nbsp;
<span class="co1">%-Parameter estimates: beta = xX.pKX*xX.K*y</span>
<span class="co1">%---------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>  = spm_get_data<span class="br0">(</span>SPM.<span class="me1">Vbeta</span>,xSPM.<span class="me1">XYZ</span><span class="br0">(</span>:,Q<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%-subtract Y0 = XO*beta,  Y = Yc + Y0 + e</span>
<span class="co1">%---------------------------------------------------------------</span>
y     = y - spm_FcUtil<span class="br0">(</span><span class="co2">'Y0'</span>,SPM.<span class="me1">xCon</span><span class="br0">(</span>xY.<span class="me1">Ic</span><span class="br0">)</span>,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a><span class="br0">)</span>;
&nbsp;
<span class="co1">% extract session-specific rows from data and confounds</span>
<span class="co1">%-----------------------------------------------------------------------</span>
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>scandir,Session_filter<span class="br0">)</span><span class="br0">)</span>;
nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Session,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> ses=<span class="nu0">1</span>:nses
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> xY.<span class="me1">X0</span> y2
    xY.<span class="me1">X0</span>     = SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span>.<span class="me1">X</span><span class="br0">(</span>:,<span class="br0">[</span>SPM.<span class="me1">xX</span>.<span class="me1">iB</span> SPM.<span class="me1">xX</span>.<span class="me1">iG</span><span class="br0">]</span><span class="br0">)</span>;
    xY.<span class="me1">Sess</span>   = ses;
&nbsp;
    <span class="kw1">try</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>     = SPM.<span class="me1">Sess</span><span class="br0">(</span>xY.<span class="me1">Sess</span><span class="br0">)</span>.<span class="me1">row</span>;
        y2     = y<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,:<span class="br0">)</span>;
        xY.<span class="me1">X0</span> = xY.<span class="me1">X0</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,:<span class="br0">)</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">% and add session-specific filter confounds</span>
    <span class="co1">%-----------------------------------------------------------------------</span>
    <span class="kw1">try</span>
        xY.<span class="me1">X0</span> = <span class="br0">[</span>xY.<span class="me1">X0</span> SPM.<span class="me1">xX</span>.<span class="me1">K</span><span class="br0">(</span>xY.<span class="me1">Sess</span><span class="br0">)</span>.<span class="me1">X0</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">%=======================================================================</span>
    <span class="kw1">try</span>
        xY.<span class="me1">X0</span> = <span class="br0">[</span>xY.<span class="me1">X0</span> SPM.<span class="me1">xX</span>.<span class="me1">K</span><span class="br0">(</span>xY.<span class="me1">Sess</span><span class="br0">)</span>.<span class="me1">KH</span><span class="br0">]</span>; <span class="co1">% Compatibility check</span>
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">% compute regional response in terms of first eigenvariate</span>
    <span class="co1">%-----------------------------------------------------------------------</span>
    <span class="br0">[</span>m n<span class="br0">]</span>   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>y2<span class="br0">)</span>;
    <span class="kw1">if</span> m &gt; n
        <span class="br0">[</span>v s v<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/svd.html"><span class="kw2">svd</span></a><span class="br0">(</span>spm_atranspa<span class="br0">(</span>y2<span class="br0">)</span><span class="br0">)</span>;
        s       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span>s<span class="br0">)</span>;
        v       = v<span class="br0">(</span>:,<span class="nu0">1</span><span class="br0">)</span>;
        u       = y2*v/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span>s<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">else</span>
        <span class="br0">[</span>u s u<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/svd.html"><span class="kw2">svd</span></a><span class="br0">(</span>spm_atranspa<span class="br0">(</span>y2'<span class="br0">)</span><span class="br0">)</span>;
        s       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span>s<span class="br0">)</span>;
        u       = u<span class="br0">(</span>:,<span class="nu0">1</span><span class="br0">)</span>;
        v       = y2'*u/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span>s<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    d       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sign.html"><span class="kw2">sign</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>v<span class="br0">)</span><span class="br0">)</span>;
    u       = u*d;
    v       = v*d;
    Y       = u*<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span>s<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>/n<span class="br0">)</span>;
&nbsp;
    <span class="co1">% set in structure</span>
    <span class="co1">%-----------------------------------------------------------------------</span>
    xY.<span class="me1">y</span>    = y2;
    xY.<span class="me1">u</span>    = Y;
    xY.<span class="me1">v</span>    = v;
    xY.<span class="me1">s</span>    = s;
&nbsp;
    str     = <span class="br0">[</span><span class="co2">'VOI_'</span> xY.<span class="me1">name</span><span class="br0">]</span>;
    <span class="kw1">if</span> isfield<span class="br0">(</span>xY,<span class="co2">'Sess'</span><span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>xY.<span class="me1">Sess</span><span class="br0">)</span> == <span class="nu0">1</span>
            str = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'VOI_%s_%i'</span>,xY.<span class="me1">name</span>,xY.<span class="me1">Sess</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    myvoi= <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>SPM.<span class="me1">swd</span>,str<span class="br0">)</span> <span class="co2">'.mat'</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>SPM.<span class="me1">swd</span>,str<span class="br0">)</span>,<span class="co2">'Y'</span>,<span class="co2">'xY'</span><span class="br0">)</span>
    myPPI<span class="br0">{</span>ses<span class="br0">}</span> = Labnic_extract_PPI<span class="br0">(</span>SPM,myvoi,psyconvar,namevar<span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>SPM,xSPM<span class="br0">]</span> = spm_getSPM_PPI<span class="br0">(</span>swd,Ic<span class="br0">)</span>
SCCSid = <span class="co2">'2.51'</span>;
&nbsp;
<span class="co1">%-GUI setup</span>
<span class="co1">%-----------------------------------------------------------------------</span>
SPMid  = spm<span class="br0">(</span><span class="co2">'SFnBanner'</span>,mfilename,SCCSid<span class="br0">)</span>;
spm_help<span class="br0">(</span><span class="co2">'!ContextHelp'</span>,mfilename<span class="br0">)</span>
&nbsp;
<span class="co1">%-Select SPM.mat &amp; note SPM results directory</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="co1">% swd    = spm_str_manip(spm_get(1,'SPM.mat','Select SPM.mat'),'H');</span>
&nbsp;
<span class="co1">%-Preliminaries...</span>
<span class="co1">%=======================================================================</span>
&nbsp;
<span class="co1">%-Load SPM.mat</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>swd,<span class="co2">'SPM.mat'</span><span class="br0">)</span><span class="br0">)</span>;
SPM.<span class="me1">swd</span> = swd;
&nbsp;
<span class="co1">%-Get volumetric data from SPM.mat</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">try</span>
    xX   = SPM.<span class="me1">xX</span>;				<span class="co1">%-Design definition structure</span>
    XYZ  = SPM.<span class="me1">xVol</span>.<span class="me1">XYZ</span>;			<span class="co1">%-XYZ coordinates</span>
    S    = SPM.<span class="me1">xVol</span>.<span class="me1">S</span>;			<span class="co1">%-search Volume {voxels}</span>
    R    = SPM.<span class="me1">xVol</span>.<span class="me1">R</span>;			<span class="co1">%-search Volume {resels}</span>
    M    = SPM.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,<span class="nu0">1</span>:<span class="nu0">3</span><span class="br0">)</span>;		<span class="co1">%-voxels to mm matrix</span>
    VOX  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diag.html"><span class="kw2">diag</span></a><span class="br0">(</span>M'*M<span class="br0">)</span><span class="br0">)</span>';		<span class="co1">%-voxel dimensions</span>
<span class="kw1">catch</span>
&nbsp;
    <span class="co1">% check the model has been estimated</span>
    <span class="co1">%---------------------------------------------------------------</span>
    str = <span class="br0">{</span>	<span class="co2">'This model has not been estimated.'</span>;<span class="sy0">...</span>
        <span class="co2">'Would you like to estimate it now?'</span><span class="br0">}</span>;
    <span class="kw1">if</span> spm_input<span class="br0">(</span>str,<span class="nu0">1</span>,<span class="co2">'bd'</span>,<span class="co2">'yes|no'</span>,<span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0</span><span class="br0">]</span>,<span class="nu0">1</span><span class="br0">)</span>
        <span class="br0">[</span>SPM<span class="br0">]</span> = spm_spm<span class="br0">(</span>SPM<span class="br0">)</span>;
    <span class="kw1">else</span>
        <span class="kw1">return</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">%-Contrast definitions</span>
<span class="co1">%=======================================================================</span>
&nbsp;
<span class="co1">%-Load contrast definitions (if available)</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">try</span>
    xCon = SPM.<span class="me1">xCon</span>;
<span class="kw1">catch</span>
    xCon = <span class="br0">{</span><span class="br0">}</span>;
<span class="kw1">end</span>
&nbsp;
nc       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Ic<span class="br0">)</span>;  <span class="co1">% Number of contrasts</span>
&nbsp;
n = <span class="nu0">1</span>;
&nbsp;
<span class="co1">%-Enforce orthogonality of multiple contrasts for conjunction</span>
<span class="co1">% (Orthogonality within subspace spanned by contrasts)</span>
<span class="co1">%-----------------------------------------------------------------------</span>
Im = <span class="br0">[</span><span class="br0">]</span>;
pm = <span class="br0">[</span><span class="br0">]</span>;
Ex = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">%-Create/Get title string for comparison</span>
<span class="co1">%-----------------------------------------------------------------------</span>
str  = xCon<span class="br0">(</span>Ic<span class="br0">)</span>.<span class="me1">name</span>;
<span class="kw1">if</span> Ex
    mstr = <span class="co2">'masked [excl.] by'</span>;
<span class="kw1">else</span>
    mstr = <span class="co2">'masked [incl.] by'</span>;
<span class="kw1">end</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Im<span class="br0">)</span> == <span class="nu0">1</span>
    str  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s (%s %s at p=%g)'</span>,str,mstr,xCon<span class="br0">(</span>Im<span class="br0">)</span>.<span class="me1">name</span>,pm<span class="br0">)</span>;
&nbsp;
<span class="kw1">elseif</span> ~isempty<span class="br0">(</span>Im<span class="br0">)</span>
    str  = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s (%s {%d'</span>,str,mstr,Im<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">',%d'</span>,Im<span class="br0">(</span><span class="nu0">2</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'} at p=%g)'</span>,pm<span class="br0">)</span><span class="br0">]</span>;
<span class="kw1">end</span>
titlestr     = str;
&nbsp;
<span class="co1">%-Compute &amp; store contrast parameters, contrast/ESS images, &amp; SPM images</span>
<span class="co1">%=======================================================================</span>
SPM.<span class="me1">xCon</span> = xCon;
SPM      = spm_contrasts<span class="br0">(</span>SPM,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span><span class="br0">[</span>Ic,Im<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
xCon     = SPM.<span class="me1">xCon</span>;
VspmSv   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cat.html"><span class="kw2">cat</span></a><span class="br0">(</span><span class="nu0">1</span>,xCon<span class="br0">(</span>Ic<span class="br0">)</span>.<span class="me1">Vspm</span><span class="br0">)</span>;
STAT     = xCon<span class="br0">(</span>Ic<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">STAT</span>;
&nbsp;
<span class="co1">%-Check conjunctions - Must be same STAT w/ same df</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">if</span> <span class="br0">(</span>nc &gt; <span class="nu0">1</span><span class="br0">)</span> &amp;&amp; <span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diff.html"><span class="kw2">diff</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cat.html"><span class="kw2">cat</span></a><span class="br0">(</span><span class="nu0">1</span>,xCon<span class="br0">(</span>Ic<span class="br0">)</span>.<span class="me1">STAT</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span> || <span class="sy0">...</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diff.html"><span class="kw2">diff</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cat.html"><span class="kw2">cat</span></a><span class="br0">(</span><span class="nu0">1</span>,xCon<span class="br0">(</span>Ic<span class="br0">)</span>.<span class="me1">eidf</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span> &gt; <span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'illegal conjunction: can only conjoin SPMs of same STAT &amp; df'</span><span class="br0">)</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%-Degrees of Freedom and STAT string describing marginal distribution</span>
<span class="co1">%-----------------------------------------------------------------------</span>
df          = <span class="br0">[</span>xCon<span class="br0">(</span>Ic<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">eidf</span> xX.<span class="me1">erdf</span><span class="br0">]</span>;
<span class="kw1">if</span> nc&gt;<span class="nu0">1</span>
    <span class="kw1">if</span> n&gt;<span class="nu0">1</span>
        str = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'^{%d \\{Ha:k\\geq%d\\}}'</span>,nc,<span class="br0">(</span>nc-n<span class="br0">)</span>+<span class="nu0">1</span><span class="br0">)</span>;
    <span class="kw1">else</span>
        str = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'^{%d \\{Ha:k=%d\\}}'</span>,nc,<span class="br0">(</span>nc-n<span class="br0">)</span>+<span class="nu0">1</span><span class="br0">)</span>;
    <span class="kw1">end</span>
<span class="kw1">else</span>
    str = <span class="co2">''</span>;
<span class="kw1">end</span>
&nbsp;
<span class="kw1">switch</span> STAT
    <span class="kw1">case</span> <span class="co2">'T'</span>
        STATstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%c%s_{%.0f}'</span>,<span class="co2">'T'</span>,str,df<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'F'</span>
        STATstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%c%s_{%.0f,%.0f}'</span>,<span class="co2">'F'</span>,str,df<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>,df<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'P'</span>
        STATstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s^{%0.2f}'</span>,<span class="co2">'PPM'</span>,df<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%-Compute (unfiltered) SPM pointlist for masked conjunction requested</span>
<span class="co1">%=======================================================================</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'\t%-32s: %30s\n'</span>,<span class="co2">'SPM computation'</span>,<span class="co2">'...initialising'</span><span class="br0">)</span>         <span class="co1">%-#</span>
&nbsp;
<span class="co1">%-Compute conjunction as minimum of SPMs</span>
<span class="co1">%-----------------------------------------------------------------------</span>
Z         = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>     = Ic
    Z = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span>Z,spm_get_data<span class="br0">(</span>xCon<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">Vspm</span>,XYZ<span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% P values for False Discovery FDR rate computation (all search voxels)</span>
<span class="co1">%=======================================================================</span>
<span class="kw1">switch</span> STAT
    <span class="kw1">case</span> <span class="co2">'T'</span>
        Ps = <span class="br0">(</span><span class="nu0">1</span> - spm_Tcdf<span class="br0">(</span>Z,df<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>.^n;
    <span class="kw1">case</span> <span class="co2">'P'</span>
        Ps = <span class="br0">(</span><span class="nu0">1</span> - Z<span class="br0">)</span>.^n;
    <span class="kw1">case</span> <span class="co2">'F'</span>
        Ps = <span class="br0">(</span><span class="nu0">1</span> - spm_Fcdf<span class="br0">(</span>Z,df<span class="br0">)</span><span class="br0">)</span>.^n;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%-Compute mask and eliminate masked voxels</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = Im
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'%s%30s'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\b'</span><span class="br0">)</span>*<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<span class="nu0">30</span><span class="br0">)</span>,<span class="co2">'...masking'</span><span class="br0">)</span>
&nbsp;
    Mask = spm_get_data<span class="br0">(</span>xCon<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">Vspm</span>,XYZ<span class="br0">)</span>;
    um   = spm_u<span class="br0">(</span>pm,<span class="br0">[</span>xCon<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">eidf</span>,xX.<span class="me1">erdf</span><span class="br0">]</span>,xCon<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">STAT</span><span class="br0">)</span>;
    <span class="kw1">if</span> Ex
        Q = Mask &lt;= um;
    <span class="kw1">else</span>
        Q = Mask &gt;  um;
    <span class="kw1">end</span>
    XYZ       = XYZ<span class="br0">(</span>:,Q<span class="br0">)</span>;
    Z         = Z<span class="br0">(</span>Q<span class="br0">)</span>;
    <span class="kw1">if</span> isempty<span class="br0">(</span>Q<span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span>                                           <span class="co1">%-#</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'No voxels survive masking at p=%4.2f'</span>,pm<span class="br0">)</span><span class="br0">)</span>
        <span class="kw1">break</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%-clean up interface</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'\t%-32s: %30s\n'</span>,<span class="co2">'SPM computation'</span>,<span class="co2">'...done'</span><span class="br0">)</span>         <span class="co1">%-#</span>
spm<span class="br0">(</span><span class="co2">'Pointer'</span>,<span class="co2">'Arrow'</span><span class="br0">)</span>
&nbsp;
&nbsp;
&nbsp;
<span class="co1">%=======================================================================</span>
<span class="co1">% - H E I G H T   &amp;   E X T E N T   T H R E S H O L D S</span>
<span class="co1">%=======================================================================</span>
&nbsp;
<span class="co1">%-Height threshold - classical inference</span>
<span class="co1">%-----------------------------------------------------------------------</span>
u      = -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>;
k      = <span class="nu0">0</span>;
u  = <span class="nu0">1</span>;
<span class="kw1">if</span> u &lt;= <span class="nu0">1</span>; u = spm_u<span class="br0">(</span>u^<span class="br0">(</span><span class="nu0">1</span>/n<span class="br0">)</span>,df,STAT<span class="br0">)</span>; <span class="kw1">end</span>
&nbsp;
&nbsp;
&nbsp;
<span class="co1">%-Calculate height threshold filtering</span>
<span class="co1">%-------------------------------------------------------------------</span>
Q      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>Z &gt; u<span class="br0">)</span>;
&nbsp;
<span class="co1">%-Apply height threshold</span>
<span class="co1">%-------------------------------------------------------------------</span>
Z      = Z<span class="br0">(</span>:,Q<span class="br0">)</span>;
XYZ    = XYZ<span class="br0">(</span>:,Q<span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>Q<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'No voxels survive height threshold u=%0.2g'</span>,u<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">%-Extent threshold (disallowed for conjunctions)</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">if</span> ~isempty<span class="br0">(</span>XYZ<span class="br0">)</span>
&nbsp;
    <span class="co1">%-Get extent threshold [default = 0]</span>
    <span class="co1">%-------------------------------------------------------------------</span>
    k     = <span class="nu0">0</span>;
&nbsp;
    <span class="co1">%-Calculate extent threshold filtering</span>
    <span class="co1">%-------------------------------------------------------------------</span>
    A     = spm_clusters<span class="br0">(</span>XYZ<span class="br0">)</span>;
    Q     = <span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>A<span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>A == <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> &gt;= k; Q = <span class="br0">[</span>Q <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">]</span>; <span class="kw1">end</span>
    <span class="kw1">end</span>
&nbsp;
    <span class="co1">% ...eliminate voxels</span>
    <span class="co1">%-------------------------------------------------------------------</span>
    Z     = Z<span class="br0">(</span>:,Q<span class="br0">)</span>;
    XYZ   = XYZ<span class="br0">(</span>:,Q<span class="br0">)</span>;
    <span class="kw1">if</span> isempty<span class="br0">(</span>Q<span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'No voxels survive extent threshold k=%0.2g'</span>,k<span class="br0">)</span><span class="br0">)</span>
    <span class="kw1">end</span>
&nbsp;
<span class="kw1">else</span>
&nbsp;
    k = <span class="nu0">0</span>;
&nbsp;
<span class="kw1">end</span> <span class="co1">% (if ~isempty(XYZ))</span>
&nbsp;
&nbsp;
<span class="co1">%=======================================================================</span>
<span class="co1">% - E N D</span>
<span class="co1">%=======================================================================</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'\t%-32s: %30s\n'</span>,<span class="co2">'SPM computation'</span>,<span class="co2">'...done'</span><span class="br0">)</span>         <span class="co1">%-#</span>
&nbsp;
<span class="co1">%-Assemble output structures of unfiltered data</span>
<span class="co1">%=======================================================================</span>
xSPM   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/struct.html"><span class="kw2">struct</span></a><span class="br0">(</span><span class="co2">'swd'</span>,		swd,<span class="sy0">...</span>
    <span class="co2">'title'</span>,	titlestr,<span class="sy0">...</span>
    <span class="co2">'Z'</span>,		Z,<span class="sy0">...</span>
    <span class="co2">'n'</span>,		n,<span class="sy0">...</span>
    <span class="co2">'STAT'</span>,		STAT,<span class="sy0">...</span>
    <span class="co2">'df'</span>,		df,<span class="sy0">...</span>
    <span class="co2">'STATstr'</span>,	STATstr,<span class="sy0">...</span>
    <span class="co2">'Ic'</span>,		Ic,<span class="sy0">...</span>
    <span class="co2">'Im'</span>,		Im,<span class="sy0">...</span>
    <span class="co2">'pm'</span>,		pm,<span class="sy0">...</span>
    <span class="co2">'Ex'</span>,		Ex,<span class="sy0">...</span>
    <span class="co2">'u'</span>,		u,<span class="sy0">...</span>
    <span class="co2">'k'</span>,		k,<span class="sy0">...</span>
    <span class="co2">'XYZ'</span>,		XYZ,<span class="sy0">...</span>
    <span class="co2">'XYZmm'</span>,	SPM.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,:<span class="br0">)</span>*<span class="br0">[</span>XYZ; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>XYZ,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>,<span class="sy0">...</span>
    <span class="co2">'S'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">S</span>,<span class="sy0">...</span>
    <span class="co2">'R'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">R</span>,<span class="sy0">...</span>
    <span class="co2">'FWHM'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">FWHM</span>,<span class="sy0">...</span>
    <span class="co2">'M'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">M</span>,<span class="sy0">...</span>
    <span class="co2">'iM'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">iM</span>,<span class="sy0">...</span>
    <span class="co2">'DIM'</span>,		SPM.<span class="me1">xVol</span>.<span class="me1">DIM</span>,<span class="sy0">...</span>
    <span class="co2">'VOX'</span>,		VOX,<span class="sy0">...</span>
    <span class="co2">'Vspm'</span>,		VspmSv,<span class="sy0">...</span>
    <span class="co2">'Ps'</span>,		Ps<span class="br0">)</span>;
&nbsp;
<span class="co1">% RESELS per voxel (density) if it exists</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">if</span> isfield<span class="br0">(</span>SPM,<span class="co2">'VRpv'</span><span class="br0">)</span>, xSPM.<span class="me1">VRpv</span> = SPM.<span class="me1">VRpv</span>; <span class="kw1">end</span>
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_analyse_PPI<span class="br0">(</span>su,myPPI,region<span class="br0">)</span>
&nbsp;
<span class="kw1">global</span> Session_filter scandir TR nslices
&nbsp;
anatype = <span class="br0">[</span><span class="co2">'analyse'</span> filesep <span class="co2">'PPI'</span> filesep<span class="br0">]</span>;
<span class="co1">% select the sessions of interest</span>
Session=get_directories<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>scandir,Session_filter<span class="br0">)</span><span class="br0">)</span>;
nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Session,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
myana= <span class="br0">[</span><span class="co2">'PPI_'</span> region filesep<span class="br0">]</span>; <span class="co1">%ROI</span>
&nbsp;
<span class="co1">% specify data: matrix of filenames and TR</span>
<span class="co1">%===========================================================================</span>
nscans=<span class="br0">[</span><span class="br0">]</span>;
SPM.<span class="me1">xY</span>.<span class="me1">P</span>=<span class="br0">[</span><span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> tmp
&nbsp;
<span class="kw1">for</span> ses= <span class="nu0">1</span>:nses
    smoothfolder = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>scandir,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span>,<span class="br0">[</span>filesep <span class="co2">'swf'</span> filesep<span class="br0">]</span><span class="br0">)</span>;
    tmp<span class="br0">{</span>ses<span class="br0">}</span> = spm_select<span class="br0">(</span><span class="co2">'List'</span>,smoothfolder,<span class="co2">'^sw.*nii'</span><span class="br0">)</span>;
    nscans = <span class="br0">[</span>nscans <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>tmp<span class="br0">{</span>ses<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">]</span>;
    SPM.<span class="me1">xY</span>.<span class="me1">P</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strvcat.html"><span class="kw2">strvcat</span></a><span class="br0">(</span>SPM.<span class="me1">xY</span>.<span class="me1">P</span>,<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>smoothfolder,nscans<span class="br0">(</span>ses<span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span>,tmp<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">]</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">% basis functions and timing parameters</span>
<span class="co1">%---------------------------------------------------------------------------</span>
ref_slice=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/floor.html"><span class="kw2">floor</span></a><span class="br0">(</span>nslices/<span class="nu0">2</span><span class="br0">)</span>;	<span class="co1">% middle slice in time</span>
SPM.<span class="me1">xBF</span>.<span class="me1">T</span>          = nslices;        <span class="co1">% number of time bins per scan  % useless? cf. defaults above</span>
SPM.<span class="me1">xBF</span>.<span class="me1">T0</span>         = ref_slice;		    <span class="co1">% middle slice/timebin          % useless? cf. defaults above</span>
SPM.<span class="me1">xBF</span>.<span class="me1">UNITS</span>      = <span class="co2">'scans'</span>;           <span class="co1">% OPTIONS: 'scans'|'secs' for onsets</span>
SPM.<span class="me1">xBF</span>.<span class="me1">Volterra</span>   = <span class="nu0">1</span>;     
SPM.<span class="me1">xBF</span>.<span class="me1">name</span>       = <span class="co2">'hrf'</span>;
SPM.<span class="me1">xBF</span>.<span class="me1">order</span>      = <span class="nu0">1</span>;                 <span class="co1">%2= hrf + time deriv --&gt; 'hrf (with time derivative)';</span>
SPM.<span class="me1">xBF</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a>     = <span class="nu0">32</span>;                <span class="co1">% length in seconds</span>
&nbsp;
SPM.<span class="me1">xY</span>.<span class="me1">RT</span> = TR;
&nbsp;
<span class="co1">% number of scans and sessions</span>
<span class="co1">%---------------------------------------------------------------------------</span>
SPM.<span class="me1">nscan</span>   = nscans;
&nbsp;
<span class="kw1">for</span> ses=<span class="nu0">1</span>:nses
    SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">U</span>=<span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">end</span>
&nbsp;
rnam = <span class="br0">{</span><span class="co2">'PPI'</span> <span class="co2">'contrast'</span> region <span class="co2">'X'</span>,<span class="co2">'Y'</span>,<span class="co2">'Z'</span>,<span class="co2">'x'</span>,<span class="co2">'y'</span>,<span class="co2">'z'</span><span class="br0">}</span>;
<span class="kw1">for</span> ses=<span class="nu0">1</span>:nses
    fn = spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>scandir,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span>,<span class="co2">'^rp_.*txt'</span><span class="br0">)</span>;
    <span class="br0">[</span>r1,r2,r3,r4,r5,r6<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/textread.html"><span class="kw2">textread</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>scandir,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Session<span class="br0">{</span>ses<span class="br0">}</span><span class="br0">)</span>,fn<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>,<span class="co2">'%f%f%f%f%f%f'</span><span class="br0">)</span>;
    SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">C</span>.<span class="me1">C</span> = <span class="br0">[</span>myPPI<span class="br0">{</span>ses<span class="br0">}</span>.<span class="me1">ppi</span> myPPI<span class="br0">{</span>ses<span class="br0">}</span>.<span class="me1">P</span> myPPI<span class="br0">{</span>ses<span class="br0">}</span>.<span class="me1">Y</span> r1 r2 r3 r4 r5 r6<span class="br0">]</span>;
    SPM.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">C</span>.<span class="me1">name</span> = rnam;
<span class="kw1">end</span>
&nbsp;
defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t</span>   = nslices;
defaults.<span class="me1">stats</span>.<span class="me1">fmri</span>.<span class="me1">t0</span>  = ref_slice;
&nbsp;
&nbsp;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="co1">% subject specific bit</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
wkdir =  <span class="br0">[</span>su anatype myana<span class="br0">]</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>wkdir, <span class="co2">'dir'</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span>wkdir<span class="br0">)</span>;
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> <span class="br0">(</span>wkdir<span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% global normalization: OPTIONS:'Scaling'|'None'</span>
<span class="co1">%---------------------------------------------------------------------------</span>
SPM.<span class="me1">xGX</span>.<span class="me1">iGXcalc</span>    = <span class="co2">'None'</span>;
&nbsp;
<span class="co1">% low frequency confound: high-pass cutoff (secs) [Inf = no filtering]</span>
<span class="co1">%---------------------------------------------------------------------------</span>
SPM.<span class="me1">xX</span>.<span class="me1">K</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">HParam</span> = <span class="nu0">128</span>;
&nbsp;
<span class="co1">% intrinsic autocorrelations: OPTIONS: 'none'|'AR(1) + w'</span>
<span class="co1">%-----------------------------------------------------------------------</span>
SPM.<span class="me1">xVi</span>.<span class="me1">form</span>       = <span class="co2">'AR(1)'</span>; <span class="co1">%AR(0.2)???? SOSART</span>
&nbsp;
<span class="co1">% specify SPM working dir for this sub</span>
<span class="co1">%===========================================================================</span>
SPM.<span class="me1">swd</span> = wkdir;
&nbsp;
<span class="co1">% Configure design matrix</span>
<span class="co1">%===========================================================================</span>
SPM = spm_fmri_spm_ui<span class="br0">(</span>SPM<span class="br0">)</span>;
&nbsp;
<span class="co1">% Estimate parameters</span>
<span class="co1">%===========================================================================</span>
SPM = spm_spm<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_contrast_PPI<span class="br0">(</span>su,region<span class="br0">)</span>
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>su,<span class="br0">[</span><span class="co2">'analyse'</span> filesep <span class="co2">'PPI'</span><span class="br0">]</span>,<span class="br0">[</span><span class="co2">'PPI_'</span> region<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="co2">'SPM.mat'</span><span class="br0">)</span>;
&nbsp;
SPM.<span class="me1">xCon</span> =<span class="br0">[</span><span class="br0">]</span>; <span class="co1">% reset xCon</span>
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">)</span><span class="co1">%adding 6 for mvt regressors that are in SPM.xX.name</span>
    connam<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> = SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:<span class="kw1">end</span><span class="br0">)</span>;
<span class="kw1">end</span>
PPI = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'PPI'</span><span class="br0">)</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/contrast.html"><span class="kw2">contrast</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'contrast'</span><span class="br0">)</span><span class="br0">)</span>;
vox = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,region<span class="br0">)</span><span class="br0">)</span>;
<span class="co1">%----------</span>
<span class="co1">%MAIN EFFECTS</span>
<span class="co1">%----------</span>
cn = <span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'PPI'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = PPI;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F'</span>;
cn = cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'contrast'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/contrast.html"><span class="kw2">contrast</span></a>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = region;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = vox;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'PPI'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = PPI;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
Cnames<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'-PPI'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -PPI;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> contrasts_name Cnames
<span class="kw1">for</span> c = <span class="nu0">1</span>:cn
    cw = <span class="br0">[</span>cwgt<span class="br0">{</span>c<span class="br0">}</span><span class="br0">]</span>';	<span class="co1">% pad with zero for constant</span>
    tmp<span class="br0">(</span>c<span class="br0">)</span>     = spm_FcUtil<span class="br0">(</span><span class="co2">'Set'</span>,Cnames<span class="br0">{</span>c<span class="br0">}</span>,ctyp<span class="br0">{</span>c<span class="br0">}</span>,<span class="co2">'c'</span>,cw,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span><span class="br0">)</span>;
<span class="kw1">end</span>
SPM.<span class="me1">xCon</span> = tmp;
&nbsp;
SPM = spm_contrasts<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
You have to specify the first lines of the script, then it should work 
correctly… As contrasts are consistent across studies (PPI, psycho, 
physio factors), they are set and computed by default. If you have 
comments, suggestions, bugs reports, feel free to contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) 
</p>

</div>
<div class="secedit editbutton_section editbutton_4"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[First Level Analysis] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="69274-109469" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="First Level Analysis" type="submit"></div></form></div>
<h2 class="sectionedit5"><a name="first_level_contrasts" id="first_level_contrasts">First Level Contrasts</a></h2>
<div class="level2">

<p>

<strong><em>Updated by YC on July 17th 2009</em></strong>
</p>
<p><a title="reveal" class="folder " href="#folded_8"> SPM5 or SPM8 : save this function as Labnic_1st_contrast_spm5.m</a></p><div class="folded  hidden" id="folded_8">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=7" title="Download Snippet" class="mediafile mf_m">Labnic_1st_contrast_spm5.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_contrast_spm5
<span class="co1">% analysing of the subjects you will define:</span>
<span class="co1">% you must have a structure like</span>
<span class="co1">% **...\data_fMRI\populations\subjects\scans\sessions\swaf\**</span>
<span class="co1">% your behavioral data are in a matrix begining by ONS in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\behavior\**</span>
<span class="co1">% your analysis will be in :</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% for your processed images.</span>
&nbsp;
<span class="co1">% this function has been adapted by Yann Cojan (yann.cojan@unige.ch)</span>
<span class="co1">% improved by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> name_ana;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'D:\'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana'</span>; <span class="co1">%or 'ana2'; etc</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% starting analysing</span>
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    <span class="co1">% go to the population folder</span>
    Pop<span class="br0">{</span>pop<span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,:<span class="br0">)</span><span class="br0">)</span>;
    sep_pop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>filesep,Pop<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>;
    popu = Pop<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>,sep_pop<span class="br0">(</span>end-<span class="nu0">1</span><span class="br0">)</span>+<span class="nu0">1</span>:sep_pop<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
        <span class="co1">%go to the subject's analyse folder</span>
        sufolder= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
        path_ana =<span class="br0">[</span>sufolder <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> path_ana<span class="br0">]</span><span class="br0">)</span>;
        <span class="co1">%select SPM.mat</span>
        <span class="br0">[</span>files<span class="br0">]</span>=spm_select<span class="br0">(</span><span class="co2">'List'</span>,path_ana,<span class="co2">'^SPM.mat$'</span><span class="br0">)</span>;
        jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>path_ana,files<span class="br0">)</span><span class="br0">}</span>;
        <span class="co1">% create the F contrasts</span>
        <span class="br0">[</span>Cf,Cnamesf<span class="br0">]</span> = f_con;
        <span class="kw1">for</span> iconf = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Cf,<span class="nu0">2</span><span class="br0">)</span>
            <span class="co1">% put the contrast in the job</span>
            jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span>iconf<span class="br0">}</span>.<span class="me1">fcon</span>.<span class="me1">name</span> = Cnamesf<span class="br0">{</span>iconf<span class="br0">}</span>;
            jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span>iconf<span class="br0">}</span>.<span class="me1">fcon</span>.<span class="me1">convec</span> = <span class="br0">{</span>Cf<span class="br0">{</span>iconf<span class="br0">}</span><span class="br0">}</span>;
        <span class="kw1">end</span>
&nbsp;
<span class="co1">%         create the T contrasts</span>
        <span class="br0">[</span>Ct,Cnamest<span class="br0">]</span> = t_con;
        <span class="kw1">for</span> icont = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Ct,<span class="nu0">1</span><span class="br0">)</span>
            <span class="co1">% put the contrast in the job</span>
            jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span>iconf+icont<span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = Cnamest<span class="br0">{</span>icont<span class="br0">}</span>;
            jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span>iconf+icont<span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = Ct<span class="br0">(</span>icont,:<span class="br0">)</span>;
        <span class="kw1">end</span>
        <span class="co1">% save a matrix with the names of the contrasts</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="co2">'save contrasts_name Ct Cnamest'</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="co2">'save contrast jobs'</span><span class="br0">)</span>;
        <span class="co1">% run the job</span>
        spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% FUNCTION SECTION: create contrasts</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>Cf,Cnamesf<span class="br0">]</span> = f_con
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
SPM.<span class="me1">xCon</span> = <span class="br0">[</span><span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> SPM SPM
&nbsp;
Cf = <span class="br0">[</span><span class="br0">]</span>; Cnamesf = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">)</span><span class="co1">% creating a variable connam which contain all possible contrasts</span>
    b = strfind<span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
    connam<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> = SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% then named the contrasts</span>
Lbissec_placebo = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'Lbissec_placebo'</span><span class="br0">)</span><span class="br0">)</span>;
&nbsp;
Cnamesf<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span><span class="br0">}</span> = <span class="co2">'F-Task'</span>;
Cf<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span><span class="br0">}</span> = <span class="br0">[</span>Lbissec_placebo;Mbissec_placebo;Rbissec_placebo;Lmemo_placebo;Mmemo_placebo;Rmemo_placebo;Lsearch_placebo;Msearch_placebo;Rsearch_placebo;<span class="sy0">...</span>
    <span class="me1">Lbissec_nico</span>;Mbissec_nico;Rbissec_nico;Lmemo_nico;Mmemo_nico;Rmemo_nico;Lsearch_nico;Msearch_nico;Rsearch_nico<span class="br0">]</span>;<span class="co1">% example</span>
&nbsp;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>Ct,Cnamest<span class="br0">]</span> = t_con
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
&nbsp;
Ct = <span class="br0">[</span><span class="br0">]</span>; Cnamest = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">)</span><span class="co1">% creating a variable connam which contain all possible contrasts</span>
    b = strfind<span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
    connam<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> = SPM.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% then named the contrasts</span>
Mmemo_nico = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>connam,<span class="co2">'Mmemo_nico'</span><span class="br0">)</span><span class="br0">)</span>;
&nbsp;
Cnamest<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span><span class="br0">}</span> = <span class="co2">'Lbissec_placebo'</span>;
Ct<span class="br0">(</span><span class="kw1">end</span>+<span class="nu0">1</span>,:<span class="br0">)</span> = Lbissec_placebo;<span class="co1">% example</span>
&nbsp;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>

You must specify some details of your study in lines 17-18 of the function. 
</p>

<p>
You have to specify your contrast from line 68 to as many contrasts you 
want. For help on this topic, please contact anyone who has already the 
script running, Yann Cojan (yann.cojan@unige.ch) or Virginie Sterpenich 
(virginie.sterpenich@unige.ch).
</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

</div>
<div class="secedit editbutton_section editbutton_5"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[First Level Contrasts] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="109470-113731" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="First Level Contrasts" type="submit"></div></form></div>
<h2 class="sectionedit6"><a name="second_level_analysis" id="second_level_analysis">Second Level Analysis</a></h2>
<div class="level2">

<p>

<strong><em>Updated by YC on Dec 17th 2009</em></strong>
</p>

</div>

<h4><a name="sample_ttest" id="sample_ttest">1 sample ttest</a></h4>
<div class="level4">
<p><a title="reveal" class="folder" href="#folded_9"> SPM5 : save this function as Labnic_rfx_ones_spm5.m</a></p><div class="folded hidden" id="folded_9">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=8" title="Download Snippet" class="mediafile mf_m">Labnic_rfx_ones_spm5.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_ones_spm5
<span class="co1">% create the second level analyis (random effect analysis RFX)</span>
<span class="co1">% create a one sample t-test with one group of subjects</span>
&nbsp;
<span class="co1">% you must speficied the 3 first line of the script</span>
<span class="co1">% dirname is the directory for the main RFX analysis</span>
<span class="co1">% it create a dir for each contrast in this main dir</span>
<span class="co1">% this code take into account that some of the subjects do not have all the</span>
<span class="co1">% contrasts</span>
<span class="co1">% Analysis of each subjects must be in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% At the begining, the script create a mean strucutral image to display the</span>
<span class="co1">% results of the group analysis</span>
&nbsp;
<span class="co1">% this function has been adapted by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> name_ana;
&nbsp;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'D:\vs1'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana1'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="br0">[</span><span class="co2">'RFX_ana_1s'</span><span class="br0">]</span>; <span class="co1">% name for the direcotry of the random analysis</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% create mean structural image to display results of the group</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'Creating mean structural image'</span><span class="br0">)</span>;
PM   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cell.html"><span class="kw2">cell</span></a><span class="br0">(</span>nsuj,<span class="nu0">1</span><span class="br0">)</span>;
ii=<span class="nu0">0</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
    <span class="co1">%go to the subject's analyse folder</span>
    sufolder= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
    path_ana =<span class="br0">[</span>sufolder <span class="co2">'scans'</span> filesep <span class="co2">'struct'</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> path_ana<span class="br0">]</span><span class="br0">)</span>;
    <span class="co1">% select the struct img</span>
    struct_img = spm_select<span class="br0">(</span><span class="co2">'List'</span>,path_ana,<span class="co2">'^ws*'</span><span class="br0">)</span>;
    PM<span class="br0">{</span>sub<span class="br0">}</span> = <span class="br0">[</span>path_ana filesep struct_img<span class="br0">]</span>;
    ii=ii+<span class="nu0">1</span>;
<span class="kw1">end</span>
<span class="co1">% create the expression for the mean</span>
expression = <span class="co2">'(i'</span>;
<span class="kw1">for</span> jj = <span class="br0">[</span><span class="nu0">1</span>:ii<span class="br0">]</span>
    expression = <span class="br0">[</span>expression  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>jj<span class="br0">)</span> <span class="co2">'+i'</span><span class="br0">]</span>;
<span class="kw1">end</span>
expression = <span class="br0">[</span>expression<span class="br0">(</span><span class="nu0">1</span>:end-<span class="nu0">2</span><span class="br0">)</span> <span class="co2">')/'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>ii<span class="br0">)</span><span class="br0">]</span>;
<span class="co1">% fil the job and calculate</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/input.html"><span class="kw2">input</span></a> = PM;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">output</span> =  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span><span class="br0">[</span>dirstr filesep <span class="co2">'meanstruct.nii'</span><span class="br0">]</span><span class="br0">)</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">expression</span> = expression;
&nbsp;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">dmtx</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">mask</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">interp</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">dtype</span> = <span class="nu0">4</span>;
<span class="co1">% run the job</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
&nbsp;
<span class="co1">%% starting analysing</span>
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
<span class="co1">% load the names of the contrasts from the first subject</span>
<span class="co1">% it use the contrasts_name matrix created in the Labnic_contrast script</span>
path_suj1 =<span class="br0">[</span>Subject<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>path_suj1,<span class="br0">[</span>filesep <span class="co2">'contrasts_name'</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span>;
<span class="co1">%     Cnames = Cnames(:,[2:7]);% if you don't want analyse all the contrasts (ex: only 2 to 7)</span>
nb_con = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Cnames,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% loop over contrasts</span>
<span class="kw1">for</span> icon = <span class="nu0">1</span>:nb_con
    defaults.<span class="me1">modality</span>=<span class="co2">'FMRI'</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Processing contrast '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>icon<span class="br0">)</span> <span class="co2">' : '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Cnames<span class="br0">(</span>icon<span class="br0">)</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'-----------------------------'</span><span class="br0">)</span>;
    <span class="co1">%initialise variables</span>
    P   = <span class="br0">{</span><span class="br0">}</span>; scans = <span class="br0">{</span><span class="br0">}</span>;
    <span class="co1">% go to the main dir</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
    <span class="co1">% Create the dir for the contrast of interest</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Cnames<span class="br0">(</span>icon<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% loop over subjects</span>
    <span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
        <span class="co1">%go to the subject's analyse folder</span>
        path_ana =<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> path_ana<span class="br0">]</span><span class="br0">)</span>;
        <span class="co1">%select SPM.mat</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
        <span class="co1">% check the name of the contrast</span>
        <span class="co1">% Find for this subject the con.img corresponding to the contrast of interest (icon)</span>
        <span class="co1">% This works even if the name of the con.img differs from one subject to the other</span>
        contrastindice = <span class="br0">[</span><span class="br0">]</span>;
        <span class="kw1">for</span> icontrast = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>SPM.<span class="me1">xCon</span>,<span class="nu0">2</span><span class="br0">)</span>
            contrastmatch = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>SPM.<span class="me1">xCon</span><span class="br0">(</span>icontrast<span class="br0">)</span>.<span class="me1">name</span>,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span>;
            <span class="kw1">if</span>  ~isempty<span class="br0">(</span>contrastmatch<span class="br0">)</span>
                contrastindice = icontrast;
                <span class="kw1">break</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
        <span class="co1">% Take the adequate 'con' img</span>
        <span class="kw1">if</span> ~isempty<span class="br0">(</span>contrastindice<span class="br0">)</span><span class="co1">% au cas ou le contraste n'existe pas chez un sujet</span>
            <span class="kw1">if</span> contrastindice &lt; <span class="nu0">10</span>
                str = <span class="br0">[</span><span class="co2">'^con_000+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">elseif</span> contrastindice &lt; <span class="nu0">100</span>
                str = <span class="br0">[</span><span class="co2">'^con_00+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">else</span>
                str = <span class="br0">[</span><span class="co2">'^con_0+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">end</span>
            files = spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>,str<span class="br0">)</span>;
            P<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>path_ana,filesep,files,<span class="co2">',1'</span><span class="br0">)</span>;
            <span class="co1">% put the image con in the appropriate group</span>
            scans<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">}</span> = P<span class="br0">{</span><span class="kw1">end</span>,:<span class="br0">}</span>;
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> SPM
    <span class="kw1">end</span> <span class="co1">% end isub loop</span>
    <span class="co1">%affiche les img con sélectionnées</span>
    scans
    <span class="co1">% fil the job</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t1</span>.<span class="me1">scans</span> = scans;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    <span class="co1">% normal parameters</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">tm</span>.<span class="me1">tm_none</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">im</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">em</span> = <span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalc</span>.<span class="me1">g_omit</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">gmsca</span>.<span class="me1">gmsca_no</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">glonorm</span> = <span class="nu0">1</span>;
&nbsp;
    <span class="co1">% run the job for the design specification</span>
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
&nbsp;
    <span class="co1">%% Estimate parameters</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
    SPM = spm_spm<span class="br0">(</span>SPM<span class="br0">)</span>;
&nbsp;
    <span class="co1">%% Create contrasts</span>
    <span class="co1">% select the SPM.mat</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span>,filesep,<span class="co2">'SPM.mat'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
&nbsp;
    <span class="co1">% precise the contrasts between both groups</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'T1'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
&nbsp;
    <span class="co1">% run the job</span>
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
<span class="kw1">end</span> <span class="co1">% end icond loop over contrasts</span>
<span class="kw1">return</span></pre>
</dd></dl>
</div><p><a title="reveal" class="folder " href="#folded_10"> SPM8 : save this function as Labnic_rfx_ones_spm8.m</a></p><div class="folded  hidden" id="folded_10">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=9" title="Download Snippet" class="mediafile mf_m">Labnic_rfx_ones_spm8.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_ones_spm8
<span class="co1">% create the second level analyis (random effect analysis RFX)</span>
<span class="co1">% create a one sample t-test with one group of subjects</span>
&nbsp;
<span class="co1">% you must speficied the 3 first line of the script</span>
<span class="co1">% dirname is the direcotry for the main RFX analysis</span>
<span class="co1">% it create a dir for each contrast in this main dir</span>
<span class="co1">% this code take into account that some of the subjects do not have all the</span>
<span class="co1">% contrasts</span>
<span class="co1">% Analysis of each subjects must be in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% At the begining, the script create a mean strucutral image to display the</span>
<span class="co1">% results of the group analysis</span>
&nbsp;
<span class="co1">% this function has been adapted by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
<span class="co1">% and optimised by Yann Cojan (yann.cojan@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> name_ana;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'C:\experiments\FLANKER\'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana_woST\'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="co2">'RFX\RFX_ones_hypnosis_subjective_31s'</span>; <span class="co1">% name for the directory of the random analysis</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span><span class="br0">[</span>root_path filesep <span class="co2">'controls'</span><span class="br0">]</span><span class="br0">)</span>
Subject<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
&nbsp;
<span class="co1">%% starting analysing</span>
<span class="co1">% load the names of the contrasts from the first subject</span>
<span class="co1">% it use the contrasts_name matrix created in the Labnic_contrast script</span>
path_suj1 =<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
&nbsp;
<span class="co1">% loop over contrasts</span>
&nbsp;
<span class="co1">% defaults.modality='FMRI';</span>
<span class="co1">% disp(['Processing contrast ' num2str(icon) ' : ' char(Cnames(icon))]);</span>
<span class="co1">% disp('-----------------------------');</span>
<span class="co1">%initialise variables</span>
P   = <span class="br0">{</span><span class="br0">}</span>; scans = <span class="br0">{</span><span class="br0">}</span>;
&nbsp;
<span class="co1">% % Create the dir for the contrast of interest</span>
<span class="co1">% mkdir(char(Cnames(icon)));</span>
Cnames = <span class="br0">{</span><span class="co2">'slatency_Cf'</span> <span class="co2">'slatency_If'</span> <span class="co2">'slatency_Cs'</span> <span class="co2">'slatency_Is'</span> <span class="co2">'slatency_ECf'</span> <span class="co2">'slatency_EIf'</span> <span class="co2">'slatency_ECs'</span> <span class="co2">'slatency_EIs'</span><span class="br0">}</span>;
nb_con = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Cnames,<span class="nu0">2</span><span class="br0">)</span>;
<span class="co1">% loop over subjects</span>
count = <span class="nu0">0</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
    count = count+<span class="nu0">1</span>;
    <span class="co1">%go to the subject's analyse folder</span>
    path_ana =<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
&nbsp;
    <span class="co1">% check the name of the contrast</span>
    <span class="co1">% Find for this subject the con.img corresponding to the contrast of</span>
    <span class="co1">% interest (icon)</span>
    con = <span class="nu0">0</span>;
    <span class="kw1">for</span> icon = <span class="nu0">1</span>:nb_con <span class="co1">%for td %10:19 %for hrf  % 20:26 %for tdd %  depending on F and T contrast at the first level</span>
        con = con+<span class="nu0">1</span>;
        <span class="kw1">if</span> sub == <span class="nu0">1</span> <span class="co1">%for initialising the struct</span>
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t1</span>.<span class="me1">scans</span> = <span class="br0">{</span><span class="br0">}</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
            <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span>matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
        <span class="co1">%% mask</span>
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">im</span> = <span class="nu0">0</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">em</span> = <span class="br0">{</span><span class="co2">'C:\experiments\FLANKER\RFX\RFX_anova_woST\mask.img,1'</span><span class="br0">}</span>;
        <span class="co1">% Take the adequate 'latency' img</span>
        str = Cnames<span class="br0">{</span>icon<span class="br0">}</span>;
        files = spm_select<span class="br0">(</span><span class="co2">'ExtFPList'</span>,path_ana,str<span class="br0">)</span>;
        <span class="co1">% put the image con in the appropriate group</span>
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t1</span>.<span class="me1">scans</span><span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span><span class="br0">}</span> = files;
&nbsp;
&nbsp;
        <span class="co1">%         %matlabbatch{con}.spm.stats.factorial_design.cov(1).c = [139 198</span>
        <span class="co1">%         178 184 161 172 123 142 125 174 214 177 102 145 121 136 174 109 105 139 175 131 148 130 142 183 ]';</span>
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">c</span> = <span class="br0">[</span><span class="nu0">10</span>,<span class="nu0">9</span>,<span class="nu0">11</span>,<span class="nu0">7</span>,<span class="nu0">10</span>,<span class="nu0">9</span>,<span class="nu0">3</span>,<span class="nu0">7</span>,<span class="nu0">11</span>,<span class="nu0">10</span>,<span class="nu0">10</span>,<span class="nu0">8</span>,<span class="nu0">6</span>,<span class="nu0">10</span>,<span class="nu0">7</span>,<span class="nu0">10</span>,<span class="nu0">2</span>,<span class="nu0">5</span>,<span class="nu0">7</span>,<span class="nu0">3</span>,<span class="nu0">10</span>,<span class="nu0">4</span>,<span class="nu0">6</span>,<span class="nu0">7</span>,<span class="nu0">2</span>,<span class="nu0">1</span>,<span class="nu0">11</span>,<span class="nu0">9</span>,<span class="nu0">8</span>,<span class="nu0">6</span>,<span class="nu0">4</span>,<span class="nu0">8</span>;<span class="br0">]</span>'; <span class="co1">%hypnosis subj</span>
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">cname</span> = <span class="co2">'hypnosis subjective'</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">iCFI</span> = <span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">iCC</span> = <span class="nu0">1</span>;
&nbsp;
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(1).c = [527.93,430.56,544.31,437.01,418.69,606.21,516.66,373.88,612.50,499.77,430.23,577.45,462.00,454.70,460.17,521.39,395.60,429.86,531.31,484.48,465.62,426.93,420.84,681.16,638.34,447.86,407.31,461.15,370.47,473.02]';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(1).cname = 'reaction time';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(1).iCFI = 1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(1).iCC = 1;</span>
        <span class="co1">%</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).c = [23.18,27.08,80.97,25.36,17.07,73.28,36.61,21.03,22.30,42.92,34.49,116.21,57.44,54.08,40.86,24.04,33.38,58.98,33.16,83.69,58.14,15.97,34.38,-22.34,10.28,78.25,19.23,19.67,49.42,10.67,52.88]';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'incongruency effect';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
        <span class="co1">%</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).c = [-7.2105,1.6933,-10.3191,-5.9564,12.103,-27.4546,11.0383,-8.5667,-9.85,4.7017,-4.4777,5.3444,-17.0412,-7.1307,4.0314,7.9951,-5.6508,14.6891,-17.6318,10.7182,-2.3345,4.404,9.8678,6.1827,5.8837,-1.9921,8.745,-5.7231,-2.1239,-3.0548;]';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'TR_F-S';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
&nbsp;
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).c = [-18.9881,-24.9904,-85.9272,-28.1663,-7.4509,-69.0327,-33.1592,-21.4825,-22.5177,-31.5774,-30.9564,-119.0013,-63.5359,-54.963,-36.2025,-19.6949,-36.909,-57.6552,-38.0087,-91.712,-55.8303,-16.1885,-24.5821,23.7739,-69.5856,-16.0828,-14.7308,-50.3663,-10.876,-47.7222;]';</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'TR_Cf-If';</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
        <span class="co1">%</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).c = [20.0982,31.4695,72.5183,18.2599,27.5145,81.5441,52.4209,16.9066,7.8373,56.2911,37.8267,129.6121,59.0775,51.9855,40.9023,30.59,33.1506,63.7293,33.5807,88.6858,59.559,17.5099,38.3411,-39.5562,90.8655,21.9729,24.6094,44.8306,14.6509,53.9644;]';</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'TR_Cs-Is';</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%                 matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
&nbsp;
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).c =  [-3.0502,4.0862,-11.864,-7.9314,16.0833,-7.4716,15.15,-6.5713,-12.2652,14.7077,1.1963,7.9776,-10.7498,-5.0541,4.3656,9.4451,-4.7046,10.3816,-11.0299,3.846,0.6971,2.8627,11.8134,-4.7998,13.5818,1.949,9.3118,-5.6294,0.8255,1.5937;]';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'TR_Cf-Cs';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
&nbsp;
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).c = [-4.1603,-2.6332,-1.9456,-7.6981,-3.9411,-0.5668,-0.0937,-2.9494,-4.6485,-2.3929,1.5449,1.975,-3.9803,-19.983,-4.1117,-1.9954,2.4152,-10.006,-5.674,-6.2914,-2.0766,-0.3342,-1.45,-0.9462,4.3075,-6.6019,6.8722,-3.0316,1.5413,10.9825;]';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).cname = 'TR_If-Is';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCFI = 1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.factorial_design.cov(2).iCC = 1;</span>
&nbsp;
        <span class="kw1">if</span> sub == <span class="nu0">1</span> <span class="co1">%for initialising the struct</span>
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">tm</span>.<span class="me1">tm_none</span> = <span class="br0">[</span><span class="br0">]</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">im</span> = <span class="nu0">1</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">em</span> = <span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">globalc</span>.<span class="me1">g_omit</span> = <span class="br0">[</span><span class="br0">]</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">gmsca</span>.<span class="me1">gmsca_no</span> = <span class="br0">[</span><span class="br0">]</span>;
            matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">glonorm</span> = <span class="nu0">1</span>;<span class="co1">% precise the contrasts between both groups</span>
        <span class="kw1">end</span>
        <span class="co1">%% for estimation</span>
        con = con+<span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span>,filesep,<span class="co2">'SPM.mat'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span> = <span class="nu0">1</span>;
        <span class="co1">%% for creating contrasts</span>
        con = con+<span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span>,filesep,<span class="co2">'SPM.mat'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = Cnames<span class="br0">{</span>icon<span class="br0">}</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="nu0">1</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{2}.tcon.name = ['-' Cnames{icon}];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{2}.tcon.convec = -1;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{2}.tcon.sessrep = 'none';</span>
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = matlabbatch<span class="br0">{</span>con-<span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">cname</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="br0">[</span><span class="co2">'-'</span> matlabbatch<span class="br0">{</span>con-<span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cov.html"><span class="kw2">cov</span></a><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">cname</span><span class="br0">]</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> =  <span class="br0">[</span><span class="nu0">0</span> -<span class="nu0">1</span><span class="br0">]</span>;
        matlabbatch<span class="br0">{</span>con<span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{4}.tcon.name = [matlabbatch{con-2}.spm.stats.factorial_design.cov(2).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{4}.tcon.convec =  [0 0 1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{4}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.name = ['-' matlabbatch{con-2}.spm.stats.factorial_design.cov(2).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.convec =  [0 0 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.name = ['-' matlabbatch{con-2}.spm.stats.factorial_design.cov(2).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.convec =  [0 0 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.name = matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(2).cname;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.convec = [0 0 1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{5}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.name = ['-' matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(2).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.convec =  [0 0 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{6}.tcon.sessrep = 'none';</span>
        <span class="co1">%</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{7}.tcon.name = matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(3).cname;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{7}.tcon.convec = [0 0 0 1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{7}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{8}.tcon.name = ['-' matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(3).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{8}.tcon.convec =  [0 0 0 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{8}.tcon.sessrep = 'none';</span>
        <span class="co1">%</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{9}.tcon.name = matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(4).cname;</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{9}.tcon.convec = [0 0 0 0 1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{9}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{10}.tcon.name = ['-' matlabbatch{con}.spm.stats{con-2}.factorial_design.cov(4).cname];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{10}.tcon.convec =  [0 0 0 0 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{10}.tcon.sessrep = 'none';</span>
        <span class="co1">%</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{11}.tcon.name = 'impulsivity';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{11}.tcon.convec = [0 1 1 1 1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{11}.tcon.sessrep = 'none';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{12}.tcon.name = '-impulsivity';</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{12}.tcon.convec =  [0 -1 -1 -1 -1];</span>
        <span class="co1">%         matlabbatch{con}.spm.stats.con.consess{12}.tcon.sessrep = 'none';</span>
    <span class="kw1">end</span> <span class="co1">% end icon loop</span>
<span class="kw1">end</span> <span class="co1">% end isub loop</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> test_latency matlabbatch
<span class="co1">% run the job for the design specification</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>
&nbsp;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
You must specify some details of your study in lines 21-23 of the function.
</p>

<p>
It's taking the first subject analysis and conditions and reproduce this
 analysis at the group level. Be sure that every subjects have the 
contrasts in the same order… For help on this topic, please contact 
anyone who has already the script running, <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch). 
</p>

</div>

<h4><a name="sample_ttest1" id="sample_ttest1">2 sample ttest</a></h4>
<div class="level4">
<p><a title="reveal" class="folder " href="#folded_11"> SPM5 : save this function as Labnic_rfx_twos_spm5.m</a></p><div class="folded  hidden" id="folded_11">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=10" title="Download Snippet" class="mediafile mf_m">Labnic_rfx_twos_spm5.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_twos_spm5
&nbsp;
<span class="co1">% create the second level analyis (random effect analysis RFX)</span>
<span class="co1">% create a two sample t-test between 2 populations of subjects</span>
&nbsp;
<span class="co1">% you must speficied the 3 first line of the script</span>
<span class="co1">% dirname is the direcotry for the main RFX analysis</span>
<span class="co1">% it create a dir for each contrast in this main dir</span>
<span class="co1">% this code take into account that some of the subjects do not have all the</span>
<span class="co1">% contrasts</span>
<span class="co1">% Analysis of each subjects must be in:</span>
<span class="co1">% **...\data_fMRI\populations\subjects\analyse\ana1\**</span>
<span class="co1">% At the beginning, the script create a mean structural image to display the</span>
<span class="co1">% results of the group analysis</span>
&nbsp;
<span class="co1">% this function has been adapted by Virginie Sterpenich (Virginie.Sterpenich@unige.ch)</span>
&nbsp;
<span class="kw1">global</span> name_ana;
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'D:\vs1'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'ana1'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="br0">[</span><span class="co2">'RFX_ana_2s'</span><span class="br0">]</span>; <span class="co1">% name for the directory of the random analysis</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% create mean structural image to display results of the group</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'Creating mean structural image'</span><span class="br0">)</span>;
PM   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cell.html"><span class="kw2">cell</span></a><span class="br0">(</span>nsuj,<span class="nu0">1</span><span class="br0">)</span>;
ii=<span class="nu0">0</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
    <span class="co1">%go to the subject's analyse folder</span>
    sufolder= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span>;
    path_ana =<span class="br0">[</span>sufolder <span class="co2">'scans'</span> filesep <span class="co2">'struct'</span><span class="br0">]</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> path_ana<span class="br0">]</span><span class="br0">)</span>;
    <span class="co1">% select the struct img</span>
    struct_img = spm_select<span class="br0">(</span><span class="co2">'List'</span>,path_ana,<span class="co2">'^ws*'</span><span class="br0">)</span>;
    PM<span class="br0">{</span>sub<span class="br0">}</span> = <span class="br0">[</span>path_ana filesep struct_img<span class="br0">]</span>;
    ii=ii+<span class="nu0">1</span>;
<span class="kw1">end</span>
<span class="co1">% create the expression for the mean</span>
expression = <span class="co2">'(i'</span>;
<span class="kw1">for</span> jj = <span class="br0">[</span><span class="nu0">1</span>:ii<span class="br0">]</span>
    expression = <span class="br0">[</span>expression  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>jj<span class="br0">)</span> <span class="co2">'+i'</span><span class="br0">]</span>;
<span class="kw1">end</span>
expression = <span class="br0">[</span>expression<span class="br0">(</span><span class="nu0">1</span>:end-<span class="nu0">2</span><span class="br0">)</span> <span class="co2">')/'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>ii<span class="br0">)</span><span class="br0">]</span>;
<span class="co1">% fil the job and calculate</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/input.html"><span class="kw2">input</span></a> = PM;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">output</span> =  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span><span class="br0">[</span>dirstr filesep <span class="co2">'meanstruct.nii'</span><span class="br0">]</span><span class="br0">)</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">expression</span> = expression;
&nbsp;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">dmtx</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">mask</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">interp</span> = <span class="nu0">0</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">util</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">imcalc</span>.<span class="me1">options</span>.<span class="me1">dtype</span> = <span class="nu0">4</span>;
<span class="co1">% run the job</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
&nbsp;
<span class="co1">%% starting analysing</span>
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
<span class="co1">% load the names of the contrasts from the first subject</span>
<span class="co1">% it use the contrasts_name matrix created in the Labnic_contrast script</span>
path_suj1 =<span class="br0">[</span>Subject<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>path_suj1,filesep,<span class="co2">'contrasts_name'</span><span class="br0">)</span><span class="br0">)</span>;
<span class="co1">%     Cnames = Cnames(:,[2:7]);% if you don't want analyse all the contrasts (ex: only 2 to 7)</span>
nb_con = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Cnames,<span class="nu0">2</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% loop over contrasts</span>
<span class="kw1">for</span> icon = <span class="nu0">1</span>:nb_con
    defaults.<span class="me1">modality</span>=<span class="co2">'FMRI'</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'Processing contrast '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>icon<span class="br0">)</span> <span class="co2">' : '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Cnames<span class="br0">(</span>icon<span class="br0">)</span><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span><span class="co2">'-----------------------------'</span><span class="br0">)</span>;
    <span class="co1">%initialise variables</span>
    P   = <span class="br0">{</span><span class="br0">}</span>; scans1 = <span class="br0">{</span><span class="br0">}</span>; scans2 = <span class="br0">{</span><span class="br0">}</span>;
    <span class="co1">% go to the main dir</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
    <span class="co1">% Create the dir for the contrast of interest</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Cnames<span class="br0">(</span>icon<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">% loop over subjects</span>
    <span class="kw1">for</span> sub = <span class="nu0">1</span>:nsuj
        <span class="co1">%go to the subject's analyse folder</span>
        path_ana =<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>sub,:<span class="br0">)</span><span class="br0">)</span> <span class="co2">'analyse'</span> filesep name_ana<span class="br0">]</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eval.html"><span class="kw2">eval</span></a><span class="br0">(</span><span class="br0">[</span><span class="co2">'cd '</span> path_ana<span class="br0">]</span><span class="br0">)</span>;
        <span class="co1">%select SPM.mat</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
        <span class="co1">% check the name of the contrast</span>
        <span class="co1">% Find for this subject the con.img corresponding to the contrast of interest (icon)</span>
        <span class="co1">% This works even if the name of the con.img differs from one subject to the other !watch out for multiple matches!</span>
        contrastindice = <span class="br0">[</span><span class="br0">]</span>;
        <span class="kw1">for</span> icontrast = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>SPM.<span class="me1">xCon</span>,<span class="nu0">2</span><span class="br0">)</span>
            contrastmatch = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>SPM.<span class="me1">xCon</span><span class="br0">(</span>icontrast<span class="br0">)</span>.<span class="me1">name</span>,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span>;
            <span class="kw1">if</span>  ~isempty<span class="br0">(</span>contrastmatch<span class="br0">)</span>
                contrastindice = icontrast;
                <span class="kw1">break</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
        <span class="co1">%%alternative to loop above, adding some error messages</span>
        <span class="co1">%contrastmatch = find(~cellfun('isempty',regexp(cellstr(char(SPM.xCon.name)),Cnames{icon})));</span>
        <span class="co1">%   if  isempty(contrastmatch) ...no contrast was found</span>
        <span class="co1">%       error('No matching contrast found - check names');</span>
        <span class="co1">%   elseif length(contrastmatch)&gt;1 ... more than 1 contrasts found</span>
        <span class="co1">%       error('Multiple matches found - check names');</span>
        <span class="co1">%   else</span>
        <span class="co1">%       contrastindice = icontrast; ...found exactly 1 match</span>
        <span class="co1">%   end</span>
&nbsp;
        <span class="co1">% Take the adequate 'con' img</span>
        <span class="kw1">if</span> ~isempty<span class="br0">(</span>contrastindice<span class="br0">)</span><span class="co1">% au cas ou le contraste n'existe pas chez un sujet</span>
            <span class="kw1">if</span> contrastindice &lt; <span class="nu0">10</span>
                str = <span class="br0">[</span><span class="co2">'^con_000+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">elseif</span> contrastindice &lt; <span class="nu0">100</span>
                str = <span class="br0">[</span><span class="co2">'^con_00+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">else</span>
                str = <span class="br0">[</span><span class="co2">'^con_0+'</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>contrastindice<span class="br0">)</span> filesep <span class="co2">'.img$'</span><span class="br0">]</span>;
            <span class="kw1">end</span>
            files = spm_select<span class="br0">(</span><span class="co2">'List'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>,str<span class="br0">)</span>;
            P<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>path_ana,filesep,files,<span class="co2">',1'</span><span class="br0">)</span>;
            <span class="co1">% put the image con in the appropriate group</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>P<span class="br0">{</span><span class="kw1">end</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
                scans1<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">}</span> = P<span class="br0">{</span><span class="kw1">end</span>,:<span class="br0">}</span>;
            <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>P<span class="br0">{</span><span class="kw1">end</span><span class="br0">}</span><span class="br0">(</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span><span class="nu0">2</span>,:<span class="br0">)</span><span class="br0">)</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Population<span class="br0">(</span><span class="nu0">2</span>,:<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
                scans2<span class="br0">{</span><span class="kw1">end</span>+<span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">}</span> = P<span class="br0">{</span><span class="kw1">end</span>,:<span class="br0">}</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> SPM
    <span class="kw1">end</span> <span class="co1">% end isub loop</span>
    <span class="co1">%affiche les img con sélectionnées</span>
    scans1
    scans2
    <span class="co1">% fil the job</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">scans1</span> = scans1;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">scans2</span> = scans2;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
    <span class="co1">% normal parameters</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">dept</span> = <span class="nu0">0</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">variance</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">gmsca</span> = <span class="nu0">0</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">t2</span>.<span class="me1">ancova</span> = <span class="nu0">0</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">tm</span>.<span class="me1">tm_none</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">im</span> = <span class="nu0">1</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">masking</span>.<span class="me1">em</span> = <span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalc</span>.<span class="me1">g_omit</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">gmsca</span>.<span class="me1">gmsca_no</span> = <span class="br0">[</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">globalm</span>.<span class="me1">glonorm</span> = <span class="nu0">1</span>;
&nbsp;
    <span class="co1">% run the job for the design specification</span>
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
&nbsp;
    <span class="co1">%% Estimate parameters</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM
    SPM = spm_spm<span class="br0">(</span>SPM<span class="br0">)</span>;
&nbsp;
    <span class="co1">%% Create contrasts</span>
    <span class="co1">% select the SPM.mat</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>dirstr,filesep,Cnames<span class="br0">{</span>icon<span class="br0">}</span>,filesep,<span class="co2">'SPM.mat'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">}</span>;
&nbsp;
    <span class="co1">% precise the contrasts between both groups</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'Gr1 vs Gr2'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
&nbsp;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'Gr2 vs Gr1'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span>-<span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
&nbsp;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'Gr1'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">0</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
&nbsp;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">4</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'Gr2'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">4</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">4</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
&nbsp;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">5</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">name</span> = <span class="co2">'Gr1_and_Gr2'</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">5</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">convec</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">5</span><span class="br0">}</span>.<span class="me1">tcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
    <span class="co1">% run the job</span>
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>dirstr<span class="br0">)</span>
&nbsp;
<span class="kw1">end</span> <span class="co1">% end icond loop over contrasts</span>
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
You must specify some details of your study in lines 21-23 of the function.
</p>

<p>
This function is taking the first subject analysis and conditions and 
reproduce this analysis at the group level. Be sure that every subjects 
have the contrasts in the same order… A 2 sample ttest is computed for 
each contrast of interest made at the first level. 
</p>

<p>
For help please contact anyone who has already the script running, <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch). 
</p>

</div>

<h4><a name="anovas" id="anovas">Anovas</a></h4>
<div class="level4">
<p><a title="reveal" class="folder" href="#folded_12"> SPM5 : save this function as Labnic_Anova_spm5.m</a></p><div class="folded hidden" id="folded_12">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=11" title="Download Snippet" class="mediafile mf_m">Labnic_Anova_spm5.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_anova_spm5
&nbsp;
spm<span class="br0">(</span><span class="co2">'defaults'</span>, <span class="co2">'FMRI'</span><span class="br0">)</span>
<span class="kw1">global</span> defaults
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'C:\experiments\FLANKER\'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'analyse\ana1\'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="br0">[</span><span class="co2">'RFX_anova_within'</span><span class="br0">]</span>; <span class="co1">% name for the directory of the random analysis</span>
cons = <span class="br0">[</span><span class="nu0">7</span> <span class="nu0">9</span> <span class="nu0">11</span> <span class="nu0">12</span><span class="br0">]</span>;<span class="co1">% which contrast is it in the 1st level analysis?</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    Subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,filesep,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> dirstr
&nbsp;
ncon = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>cons<span class="br0">)</span>;
nscan = nsuj*ncon;
&nbsp;
fnm = <span class="co2">'con'</span>;
&nbsp;
<span class="co1">%% defining the factors</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'condition'</span>; <span class="co1">%first factor</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'subject'</span>; <span class="co1">% second factor</span>
&nbsp;
<span class="co1">%% Dependance within factors</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">1</span>; <span class="co1">% Conditions are dependant (=1) because the measure is performed several times within each subject</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">% Subjects are independant (=0)</span>
&nbsp;
<span class="co1">%% Variance within factors (ie sphericity assumed or not)</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">% equal variance for conditions (0: equal; 1:unequal)</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">% equal variance for subjects (0: equal; 1:unequal)</span>
&nbsp;
<span class="kw1">for</span> s = <span class="nu0">1</span>:nsuj
    su = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>s,:<span class="br0">)</span><span class="br0">)</span>;
    scans = <span class="br0">[</span><span class="br0">]</span>;
    conds = <span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> = <span class="nu0">1</span>:ncon
        con = cons<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">)</span>;
        scans = <span class="br0">[</span>scans;<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s%s/%s_%04d.img'</span>,su,name_ana,fnm,con<span class="br0">)</span><span class="br0">}</span><span class="br0">]</span>;
        conds = <span class="br0">[</span>conds; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> s<span class="br0">]</span>;
    <span class="kw1">end</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">scans</span> = scans;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">conds</span> = conds;
<span class="kw1">end</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">1</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">2</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span>dirstr<span class="br0">}</span>;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'full_factor'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> jobs
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span>.<span class="me1">Classical</span> = <span class="nu0">1</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'full_factor_est'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
&nbsp;
<span class="co1">%% Contrast part</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> <span class="br0">(</span>jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>
SPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>SPM,<span class="co2">'xCon'</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% F contrast</span>
cn=<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F-task'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon<span class="br0">)</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>ncon,nsub<span class="br0">)</span><span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F'</span>;
&nbsp;
<span class="co1">%% T-contrasts example</span>
cn=cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F-S'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,nsub<span class="br0">)</span><span class="br0">]</span> ;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<span class="kw1">for</span> c = <span class="nu0">1</span>:cn
    cw = <span class="br0">[</span>cwgt<span class="br0">{</span>c<span class="br0">}</span><span class="br0">]</span>';	<span class="co1">% pad with zero for constant</span>
    SPM.<span class="me1">xCon</span><span class="br0">(</span>c<span class="br0">)</span>     = spm_FcUtil<span class="br0">(</span><span class="co2">'Set'</span>,cnam<span class="br0">{</span>c<span class="br0">}</span>,ctyp<span class="br0">{</span>c<span class="br0">}</span>,<span class="co2">'c'</span>,cw,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
spm_contrasts<span class="br0">(</span>SPM<span class="br0">)</span>;
&nbsp;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
<strong><em>Updated by SP March 7th 2011</em></strong>
</p>

<p>
Note that if you want to correct for potential violations of sphericity 
(ie what you usually do when looking at the p-value in the 
Greenhouse-Geiser line), you need to set the variance of the condition 
factor 'condition' to unequal (==1). The following code asks you this 
question using a popup window.
</p>
<p><a title="reveal" class="folder " href="#folded_13"> SPM8: Save this function as Labnic_Anova_spm8.m</a></p><div class="folded  hidden" id="folded_13">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=12" title="Download Snippet" class="mediafile mf_m">Labnic_Anova_spm8.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_anova_with_covariates_spm8
<span class="co1">% create the second level analyis (random effect analysis RFX)</span>
<span class="co1">% create an ANOVA with 2 factors in this example</span>
<span class="co1">% you must specified the 4 first lines of the script</span>
<span class="co1">% name_ana_grp is the directory for the main RFX analysis</span>
<span class="co1">% Analysis of each subjects must be in:</span>
<span class="co1">% **...\populations\subjects\analyse\ana1\**</span>
&nbsp;
<span class="co1">%% parameters to specify for each study %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
myjob = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;                                          <span class="co1">% myjob(1)==1 : build + estimate model myjob(2)==1 : build contrasts</span>
root_path = <span class="co2">'e:\Data XP\fMRI EWA\data_fMRI\'</span>;         <span class="co1">% directory where are the populations, main directory</span>
name_ana_ind = <span class="co2">'3. analyse\quadriface\'</span>;              <span class="co1">% Folder name of 1st level analysis</span>
name_ana_grp = <span class="co2">'grp_analysis\Quadri_ANOVA12_21S'</span>;       <span class="co1">% name for the directory of the random analysis</span>
cons = <span class="br0">[</span><span class="nu0">3</span>:<span class="nu0">6</span> <span class="nu0">8</span>:<span class="nu0">11</span> <span class="nu0">13</span>:<span class="nu0">16</span><span class="br0">]</span>;                                             <span class="co1">% which contrast is it in the 1st level analysis?</span>
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,name_ana_grp<span class="br0">)</span>;
ncon = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>cons<span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> myjob<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>
    <span class="co1">%% defining the subject list</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dbstop.html"><span class="kw2">dbstop</span></a> <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
    Subject<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
&nbsp;
    Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>Subject<span class="br0">)</span>;
    nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">%% Creation of directory for the rfx</span>
    <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,name_ana_grp<span class="br0">)</span><span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,name_ana_grp<span class="br0">)</span><span class="br0">)</span>
    <span class="kw1">end</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>dirstr<span class="br0">)</span>
    fnm = <span class="co2">'con'</span>;
&nbsp;
    answer_sphericity = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/questdlg.html"><span class="kw2">questdlg</span></a><span class="br0">(</span><span class="co2">'Do you want to correct for potential violations of sphericity of the factor condition ?'</span>,<span class="co2">'Sphericity correction'</span>, <span class="co2">'Yes'</span> , <span class="co2">'No'</span> ,<span class="co2">'Yes'</span><span class="br0">)</span>;   
    answer_sphericity = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>answer_sphericity, <span class="co2">'Yes'</span><span class="br0">)</span>;
&nbsp;
    <span class="co1">%% defining the factors</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'condition'</span>; <span class="co1">% first factor condition</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'subject'</span>; <span class="co1">% second factor subject</span>
&nbsp;
    <span class="co1">%% Dependance within factors</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">1</span>; <span class="co1">% Conditions are dependant (=1) because the measure is performed several times within each subject</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">% Subjects are independant (=0) because they are assumed to pertain to the same group</span>
&nbsp;
    <span class="co1">%% Variance within factors (ie sphericity assumed or not)</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">variance</span> = answer_sphericity;   <span class="co1">% Unequal variance assumed (0: equal; 1:unequal)</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>;                   <span class="co1">% Unequal variance assumed (0: equal; 1:unequal)</span>
&nbsp;
    <span class="co1">%% get the images from each subject</span>
    <span class="kw1">for</span> s = <span class="nu0">1</span>:nsuj
        su = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>s,:<span class="br0">)</span><span class="br0">)</span>;
        scans = <span class="br0">[</span><span class="br0">]</span>;
        conds = <span class="br0">[</span><span class="br0">]</span>;
        <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> = <span class="nu0">1</span>:ncon
            con = cons<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a><span class="br0">)</span>;
            scans = <span class="br0">[</span>scans;<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s%s%s%s%s_%04d.img'</span>,su,filesep,name_ana_ind,filesep,fnm,con<span class="br0">)</span><span class="br0">}</span><span class="br0">]</span>;
            conds = <span class="br0">[</span>conds; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> s<span class="br0">]</span>;
        <span class="kw1">end</span>
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">scans</span> = scans;
        matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">conds</span> = conds;
    <span class="kw1">end</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">1</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">2</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span>dirstr<span class="br0">}</span>;
&nbsp;
    <span class="co1">%% covariates if any</span>
    <span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov(1).c = [10,9,11,7,10,9,3,7,11,10,10,8,6,10,7,10,2,5,7,3,10,4,6,7,2,1,11,9,8,6,4,8,];</span>
    <span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov(1).cname = 'age';%name of the covariate</span>
    <span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov(1).iCFI = 2;</span>
    <span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov(1).iCC = 1;% do you want interaction with factor iCFI-1?</span>
&nbsp;
    matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span>.<span class="me1">Classical</span> = <span class="nu0">1</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'ANOVA'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span> <span class="co1">%save the .mat</span>
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
&nbsp;
<span class="kw1">end</span>
&nbsp;
<span class="kw1">if</span> myjob<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>
    <span class="co1">%% Contrast part</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>dirstr<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> <span class="br0">(</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>
    SPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>SPM,<span class="co2">'xCon'</span><span class="br0">)</span>;
    matlabbatch = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a> filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fcon</span>.<span class="me1">name</span> = <span class="co2">'F(Task)'</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fcon</span>.<span class="me1">convec</span> = <span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span>ncon<span class="br0">)</span>*<span class="br0">(</span>-<span class="nu0">1</span>/ncon<span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon<span class="br0">)</span><span class="br0">}</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<span class="me1">consess</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fcon</span>.<span class="me1">sessrep</span> = <span class="co2">'none'</span>;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">con</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a> = <span class="nu0">1</span>;
&nbsp;
    spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;  
<span class="kw1">end</span>
&nbsp;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
This function is functioning by taking the contrasts (define in cons 
line 10) for simple HRF modeling (like Face_emotional, Face_neutral) and
 make the anova directly at the second level. Furthermore it is doing 
some contrasts at line 146 that you should define.
</p>

<p>
For help please contact anyone who has already the script running, <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch).
</p>

<p>
If you notice some problems or need some help, please contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) or <strong>Virginie Sterpenich</strong> (virginie.sterpenich@unige.ch). 
</p>
<p><a title="reveal" class="folder" href="#folded_14"> SPM5 : or Labnic_Anova_2groups_spm5.m</a></p><div class="folded hidden" id="folded_14">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=13" title="Download Snippet" class="mediafile mf_m">Labnic_Anova_2groups_spm5.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_anova_2groups_spm5
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'D:\SEXO\'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'analyse_fMRI\ana_sexo_rating\'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="co2">'RFX_sexo_2groups'</span>; <span class="co1">% name for the directory of the random analysis</span>
cons = <span class="br0">[</span><span class="nu0">7</span> <span class="nu0">9</span> <span class="nu0">11</span> <span class="nu0">13</span><span class="br0">]</span>;<span class="co1">% which contrast is it in the 1st level analysis?</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
n1 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>subject<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
n2 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>subject<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>dirstr<span class="br0">)</span>
ncon = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>cons<span class="br0">)</span>;
&nbsp;
fnm = <span class="co2">'con'</span>;
<span class="co1">% get image files names</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'group'</span>;<span class="co1">%second factor</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'condition'</span>; <span class="co1">%first factor</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'subject'</span>;
&nbsp;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">%conditions are dept because coming from the same subject</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">1</span>; <span class="co1">%deriv are dept</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">%subjects are not dept</span>
&nbsp;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">1</span>; <span class="co1">%unequal variance for groups</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">%equal variance for condition</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">%equal variance for subjects</span>
&nbsp;
<span class="kw1">for</span> s = <span class="nu0">1</span>:nsuj
    su = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>s,:<span class="br0">)</span><span class="br0">)</span>;
    scans = <span class="br0">[</span><span class="br0">]</span>;
    conds = <span class="br0">[</span><span class="br0">]</span>;
    count = <span class="nu0">0</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> = <span class="nu0">1</span>:ncon
        count = count+<span class="nu0">1</span>;
        con = cons<span class="br0">(</span>count<span class="br0">)</span>;
        scans = <span class="br0">[</span>scans;<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s%s_%04d.img'</span>,su,fnm,con<span class="br0">)</span><span class="br0">}</span><span class="br0">]</span>;
        <span class="kw1">if</span> s&lt;n1+<span class="nu0">1</span>
            group = <span class="nu0">1</span>;
        <span class="kw1">else</span>
            group = <span class="nu0">2</span>;
        <span class="kw1">end</span>
        conds = <span class="br0">[</span>conds; group <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> s<span class="br0">]</span>;
    <span class="kw1">end</span>
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">scans</span> = scans;
    jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">conds</span> = conds;
<span class="kw1">end</span>
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">1</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">2</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">inter</span>.<span class="me1">fnums</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">2</span><span class="br0">]</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span>dirstr<span class="br0">}</span>;
&nbsp;
<span class="co1">%%for covariation</span>
<span class="co1">% jobs{1}.stats{1}.factorial_design.cov.c = repmat([20 24 32 23 30 31 24 17 25 26 25 27 21 29 20 21 25 22 29 26 25 25 25 28]',1,ncon);</span>
<span class="co1">% %jobs{1}.stats{1}.factorial_design.cov.c = repmat([92 106 92 105 91 96 89 94 107 112 106 107 101 105 87 93 89 105 118 80 95 85 90 105]',1,8);</span>
<span class="co1">% jobs{1}.stats{1}.factorial_design.cov.cname = 'impulsivity';</span>
<span class="co1">% jobs{1}.stats{1}.factorial_design.cov.iCFI = 1;</span>
<span class="co1">% jobs{1}.stats{1}.factorial_design.cov.iCC = 1;</span>
&nbsp;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
jobs<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">stats</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span>.<span class="me1">Classical</span> = <span class="nu0">1</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'ANOVA_2groups_spm5'</span>,<span class="co2">'jobs'</span><span class="br0">)</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,jobs<span class="br0">)</span>;
&nbsp;
<span class="co1">%% Contrast part</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> <span class="br0">(</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>
SPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>SPM,<span class="co2">'xCon'</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% F contrast</span>
cn=<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F-task'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span>kron<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>npop<span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span>ncon,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon<span class="br0">)</span>,npop,<span class="nu0">1</span><span class="br0">)</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon*npop<span class="br0">)</span><span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F'</span>;
<span class="co1">%% main effect of group</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C-P'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span>/ncon -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span>/ncon<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<span class="co1">%% main effect of conditions</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'N-E'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C-M'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EM-NM'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">0</span> -<span class="nu0">1</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NM-EM'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EC-NC'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span> <span class="nu0">0</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NC-EC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EC-EM'</span>;
con = <span class="br0">[</span>-<span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EM-EC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NC-NM'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> -<span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NM-NC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
<span class="co1">%% interactions</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'N_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> <span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'N_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">0</span> <span class="nu0">1</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span> <span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<span class="kw1">for</span> c = <span class="nu0">1</span>:cn
    cw = <span class="br0">[</span>cwgt<span class="br0">{</span>c<span class="br0">}</span><span class="br0">]</span>';	<span class="co1">% pad with zero for constant</span>
    SPM.<span class="me1">xCon</span><span class="br0">(</span>c<span class="br0">)</span>     = spm_FcUtil<span class="br0">(</span><span class="co2">'Set'</span>,cnam<span class="br0">{</span>c<span class="br0">}</span>,ctyp<span class="br0">{</span>c<span class="br0">}</span>,<span class="co2">'c'</span>,cw,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
spm_contrasts<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div><p><a title="reveal" class="folder " href="#folded_15"> SPM8: or Labnic_Anova_2groups_spm8.m</a></p><div class="folded  hidden" id="folded_15">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=14" title="Download Snippet" class="mediafile mf_m">Labnic_Anova_2groups_spm8.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span><span class="br0">]</span> = Labnic_rfx_anova_2groups
&nbsp;
<span class="co1">%% parameters to specify for each study</span>
root_path = <span class="co2">'D:\SEXO\'</span>; <span class="co1">% directory where are the populations, main directory</span>
name_ana = <span class="co2">'analyse_fMRI\ana_sexo_rating\'</span>; <span class="co1">%or 'ana2'; etc</span>
dirname = <span class="co2">'RFX_sexo_2groups'</span>; <span class="co1">% name for the directory of the random analysis</span>
cons = <span class="br0">[</span><span class="nu0">7</span> <span class="nu0">9</span> <span class="nu0">11</span> <span class="nu0">13</span><span class="br0">]</span>;<span class="co1">% which contrast is it in the 1st level analysis?</span>
&nbsp;
<span class="co1">%% defining the pop_style</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>root_path<span class="br0">)</span>
Population  = spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which population do you want to process?'</span><span class="br0">)</span>;
npop        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Population,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Definition of subjects to process</span>
<span class="kw1">for</span> pop=<span class="nu0">1</span>:npop
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>Population<span class="br0">(</span>pop,<span class="nu0">1</span>:<span class="kw1">end</span><span class="br0">)</span><span class="br0">)</span>
    subject<span class="br0">{</span>pop<span class="br0">}</span>= spm_select<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inf.html"><span class="kw2">Inf</span></a>,<span class="co2">'dir'</span>,<span class="co2">'which subjects do you want to process?'</span><span class="br0">)</span>;
<span class="kw1">end</span>
Subject = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span>subject<span class="br0">)</span>;
nsuj = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Subject,<span class="nu0">1</span><span class="br0">)</span>;
n1 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>subject<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
n2 = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>subject<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
<span class="co1">%% Creation of directory for the rfx</span>
dirstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span>;
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mkdir.html"><span class="kw2">mkdir</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcat.html"><span class="kw2">strcat</span></a><span class="br0">(</span>root_path,dirname<span class="br0">)</span><span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a> <span class="br0">(</span>dirstr<span class="br0">)</span>
ncon = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>cons<span class="br0">)</span>;
&nbsp;
fnm = <span class="co2">'con'</span>;
<span class="co1">% get image files names</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'group'</span>;<span class="co1">%second factor</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'condition'</span>; <span class="co1">%first factor</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">name</span> = <span class="co2">'subject'</span>;
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">%conditions are dept because coming from the same subject</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">1</span>; <span class="co1">%deriv are dept</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">dept</span> = <span class="nu0">0</span>; <span class="co1">%subjects are not dept</span>
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">1</span>; <span class="co1">%unequal variance for groups</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">%equal variance for condition</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fac</span><span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span>.<span class="me1">variance</span> = <span class="nu0">0</span>; <span class="co1">%equal variance for subjects</span>
&nbsp;
<span class="kw1">for</span> s = <span class="nu0">1</span>:nsuj
    su = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>Subject<span class="br0">(</span>s,:<span class="br0">)</span><span class="br0">)</span>;
    scans = <span class="br0">[</span><span class="br0">]</span>;
    conds = <span class="br0">[</span><span class="br0">]</span>;
    count = <span class="nu0">0</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> = <span class="nu0">1</span>:ncon
        count = count+<span class="nu0">1</span>;
        con = cons<span class="br0">(</span>count<span class="br0">)</span>;
        scans = <span class="br0">[</span>scans;<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s%s_%04d.img'</span>,su,fnm,con<span class="br0">)</span><span class="br0">}</span><span class="br0">]</span>;
        <span class="kw1">if</span> s&lt;<span class="nu0">16</span>
            group = <span class="nu0">1</span>;
        <span class="kw1">else</span>
            group = <span class="nu0">2</span>;
        <span class="kw1">end</span>
        conds = <span class="br0">[</span>conds; group <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cond.html"><span class="kw2">cond</span></a> s<span class="br0">]</span>;
    <span class="kw1">end</span>
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">scans</span> = scans;
    matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">fsuball</span>.<span class="me1">fsubject</span><span class="br0">(</span>s<span class="br0">)</span>.<span class="me1">conds</span> = conds;
<span class="kw1">end</span>
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">1</span>;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">fmain</span>.<span class="me1">fnum</span> = <span class="nu0">2</span>;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<span class="me1">des</span>.<span class="me1">fblock</span>.<span class="me1">maininters</span><span class="br0">{</span><span class="nu0">3</span><span class="br0">}</span>.<span class="me1">inter</span>.<span class="me1">fnums</span> = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">2</span><span class="br0">]</span>;
matlabbatch<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">factorial_design</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a> = <span class="br0">{</span>dirstr<span class="br0">}</span>;
&nbsp;
<span class="co1">%%for covariation</span>
<span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov.c = repmat([20 24 32 23 30 31 24 17 25 26 25 27 21 29 20 21 25 22 29 26 25 25 25 28]',1,ncon);</span>
<span class="co1">% %matlabbatch{1}.spm.stats.factorial_design.cov.c = repmat([92 106 92 105 91 96 89 94 107 112 106 107 101 105 87 93 89 105 118 80 95 85 90 105]',1,8);</span>
<span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov.cname = 'impulsivity';</span>
<span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov.iCFI = 1;</span>
<span class="co1">% matlabbatch{1}.spm.stats.factorial_design.cov.iCC = 1;</span>
&nbsp;
matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">spmmat</span> = <span class="br0">{</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">}</span>;
matlabbatch<span class="br0">{</span><span class="nu0">2</span><span class="br0">}</span>.<span class="me1">spm</span>.<span class="me1">stats</span>.<span class="me1">fmri_est</span>.<span class="me1">method</span>.<span class="me1">Classical</span> = <span class="nu0">1</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a><span class="br0">(</span><span class="co2">'ANOVA_2groups'</span>,<span class="co2">'matlabbatch'</span><span class="br0">)</span>
spm_jobman<span class="br0">(</span><span class="co2">'run'</span>,matlabbatch<span class="br0">)</span>;
&nbsp;
<span class="co1">%% Contrast part</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> <span class="br0">(</span><span class="br0">[</span>dirstr filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>
SPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>SPM,<span class="co2">'xCon'</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% F contrast</span>
cn=<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F-task'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span>kron<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>npop<span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span>ncon,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon<span class="br0">)</span>,npop,<span class="nu0">1</span><span class="br0">)</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/eye.html"><span class="kw2">eye</span></a><span class="br0">(</span>ncon*npop<span class="br0">)</span><span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'F'</span>;
<span class="co1">%% main effect of group</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C-P'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span>/ncon -<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,ncon<span class="br0">)</span>/ncon<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<span class="co1">%% main effect of conditions</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'N-E'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'C-M'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EM-NM'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">0</span> -<span class="nu0">1</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NM-EM'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EC-NC'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span> <span class="nu0">0</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NC-EC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EC-EM'</span>;
con = <span class="br0">[</span>-<span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">0</span> <span class="nu0">0</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'EM-EC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NC-NM'</span>;
con = <span class="br0">[</span><span class="nu0">0</span> <span class="nu0">0</span> -<span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop<span class="br0">)</span> con con*n1/nsuj con*n2/nsuj<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'NM-NC'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
<span class="co1">%% interactions</span>
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'E-N_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C_C-P'</span>;
con = <span class="br0">[</span><span class="nu0">1</span> -<span class="nu0">1</span> <span class="nu0">1</span> -<span class="nu0">1</span><span class="br0">]</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,npop+ncon<span class="br0">)</span> con -con<span class="br0">]</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
cn = cn+<span class="nu0">1</span>;
cnam<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'M-C_P-C'</span>;
cwgt<span class="br0">{</span>cn<span class="br0">}</span> = -cwgt<span class="br0">{</span>cn-<span class="nu0">1</span><span class="br0">}</span>;
ctyp<span class="br0">{</span>cn<span class="br0">}</span> = <span class="co2">'T'</span>;
&nbsp;
<span class="kw1">for</span> c = <span class="nu0">1</span>:cn
    cw = <span class="br0">[</span>cwgt<span class="br0">{</span>c<span class="br0">}</span><span class="br0">]</span>';	<span class="co1">% pad with zero for constant</span>
    SPM.<span class="me1">xCon</span><span class="br0">(</span>c<span class="br0">)</span>     = spm_FcUtil<span class="br0">(</span><span class="co2">'Set'</span>,cnam<span class="br0">{</span>c<span class="br0">}</span>,ctyp<span class="br0">{</span>c<span class="br0">}</span>,<span class="co2">'c'</span>,cw,SPM.<span class="me1">xX</span>.<span class="me1">xKXs</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
spm_contrasts<span class="br0">(</span>SPM<span class="br0">)</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
<p>
You must specify some details of your study in lines 7-10 of the 
functions. 
As contrasts as not as easy to enter than for more classical analysis, 
main contrasts are set by default by feel free to contact <strong>Yann Cojan</strong> (yann.cojan@unige.ch) for problems or suggestions…
</p>

</div>
<div class="secedit editbutton_section editbutton_6"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Second Level Analysis] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="113732-164093" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Second Level Analysis" type="submit"></div></form></div>
<h2 class="sectionedit7"><a name="note_on_sphericity_correction_in_spm_2nd_level_analyses" id="note_on_sphericity_correction_in_spm_2nd_level_analyses">Note on sphericity correction in SPM 2nd level analyses</a></h2>
<div class="level2">

<p>

<strong><em>Updated by SP on June 22th 2011</em></strong>
</p>

<p>
Very often, when doing ANOVAs with SPM, people assume that the error 
variance between experimental conditions is equal, ie it is spheric. 
Sphericity is an extension of the homoscedasticity of variance for the 
population being sampled. It is one of the prerequisites to perform an 
ANOVA. Concretely, sphericity is an assumption about the structure of 
the covariance matrix - between experimental conditions -, namely that 
covariance values should be roughly equal.
</p>

<p>
In SPSS, when sphericity is violated, you generally read the p values 
from the GreenHouse Geiser or Huynh and Feldt correction lines. This 
correction works by decreasing the degree of freedom of your analysis 
and p values are adjusted as a function of how much the variance differs
 between conditions.
</p>

<p>
In SPM, sphericity correction is achieved by answering YES to the 
question 'unequal variance between conditions' (or setting this 
parameter value to 1).
</p>

<p>
Be aware that by default, this parameter is set to 0 in many labnic 
scripts, meaning that you don't correct for sphericity violation, if 
any. Be also aware that in a lot of example you find on the web, many do
 not correct for sphericity.
</p>

<p>
So you wonder, “well, how do I notice whether or not my dataset is spheric ” ?
</p>

<p>
You can check this by looking at your ANOVA GLM matrix, once estimated.<br>

- If your dataset is spheric, you should see an nice-looking eye matrix, ie a white diagonal on a greyish background.<br>

- If your dataset is not spheric, the matrix will look 'messy' and the diagonal will be hardly distinguishable.
</p>

<p>
Once estimated, SPM displays the whitened (ie scaled) design matrix. 
This scaling will be adjusted if sphericity correction is required and 
enabled in your script by setting unequal variance of your condition 
factor to 1. Since sphericity correction rescales your design matrix, it
 will also change and improve the design orthogonality.
</p>

<p>
You may also wonder, “what in my experimental design, renders my dataset non spheric ?”.
</p>

<p>
Well if you have, in the same model, conditions that have been estimated
 using different numbers of trials (n versus 2n for instance), you will 
probably end up with a problem of sphericity. Concretely, you can be 
faced with such a problem in designs where you analyse errors or when 
using a condition with rare events (e.g. oddballs).
</p>

</div>
<div class="secedit editbutton_section editbutton_7"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Note on sphericity correction in SPM 2nd level analyses] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="164094-166515" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Note on sphericity correction in SPM 2nd level analyses" type="submit"></div></form></div>
<h2 class="sectionedit8"><a name="plotting_spheres_instead_of_voxels" id="plotting_spheres_instead_of_voxels">Plotting spheres instead of voxels</a></h2>
<div class="level2">

<p>

<strong><em>Updated by SP on Sep 28th 2010</em></strong>
</p>

<p>
This snippet adds a button to SPM <acronym title="Graphical User Interface">GUI</acronym>
 in the plot function that will make SPM plot the beta for one / several
 voxels contained into a sphere.
The step added to the plot function concerns the specification of the 
sphere radius. Choose 0 and you will plot the beta for 1 voxel, as 
usual. Choose N and you will plot the mean beta for all voxels located 
into a sphere of N mm radious.
It has been tested for SPM8 only and might require adaptations for 
earlier versions of SPM.
1. You need to edit spm_graph.m
3. Replace the following code (around line 219)
</p>
<p><a title="hide" class="folder open" href="#folded_16"> Code to remove / comment</a></p><div class="folded " id="folded_16">
<pre class="code matlab">    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>  = spm_get_data<span class="br0">(</span>SPM.<span class="me1">Vbeta</span>, XYZ<span class="br0">)</span>;
    ResMS = spm_get_data<span class="br0">(</span>SPM.<span class="me1">VResMS</span>,XYZ<span class="br0">)</span>;
    Bcov  = ResMS*SPM.<span class="me1">xX</span>.<span class="me1">Bcov</span>;</pre>
</div>
<p>
and add the following lines
</p>
<p><a title="hide" class="folder open" href="#folded_17"> Code to add</a></p><div class="folded " id="folded_17">
<pre class="code matlab">    <span class="co1">% BEGINNING OF MODIFICATION : plots the mean/SE of a voxel / a bunch of voxels contained into a sphere of Nmm radius</span>
    <span class="co1">% This code replaces the following SPM initial code</span>
    <span class="co1">%     beta  = spm_get_data(SPM.Vbeta, XYZ);</span>
    <span class="co1">%     ResMS = spm_get_data(SPM.VResMS,XYZ);</span>
    <span class="co1">%     Bcov  = ResMS*SPM.xX.Bcov;</span>
&nbsp;
    rad = spm_input<span class="br0">(</span><span class="br0">[</span><span class="co2">'Plot voxel (0) or sphere (radius mm)'</span><span class="br0">]</span>,<span class="co2">'+0'</span>,<span class="co2">'r'</span>,0,1<span class="br0">)</span>;
    d     = <span class="br0">[</span>xSPM.<span class="me1">XYZ</span><span class="br0">(</span>1,:<span class="br0">)</span> - XYZ<span class="br0">(</span>1<span class="br0">)</span>; xSPM.<span class="me1">XYZ</span><span class="br0">(</span>2,:<span class="br0">)</span> - XYZ<span class="br0">(</span>2<span class="br0">)</span>; xSPM.<span class="me1">XYZ</span><span class="br0">(</span>3,:<span class="br0">)</span> - XYZ<span class="br0">(</span>3<span class="br0">)</span><span class="br0">]</span>;  <span class="co1">% Center the contrast on the voxel / sphere coordinates</span>
    Q     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>d.^2<span class="br0">)</span> &lt;= rad^2<span class="br0">)</span>;                                                  <span class="co1">% Find surrounding voxels if rad &gt; 0</span>
    XYZ = xSPM.<span class="me1">XYZ</span><span class="br0">(</span>:,Q<span class="br0">)</span>;                                                               <span class="co1">% Get their coords</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>  = spm_get_data<span class="br0">(</span>SPM.<span class="me1">Vbeta</span>, XYZ<span class="br0">)</span>;                                              <span class="co1">% Get their beta</span>
    ResMS = spm_get_data<span class="br0">(</span>SPM.<span class="me1">VResMS</span>,XYZ<span class="br0">)</span>;                                              <span class="co1">% Get their VResMS values</span>
&nbsp;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>, <span class="nu0">2</span><span class="br0">)</span>&gt;<span class="nu0">1</span>                                                                 <span class="co1">% If more than 1 voxel, then average the stuff before calculating Bcov, SE ..</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>'<span class="br0">)</span>';
        ResMS = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>ResMS<span class="br0">)</span>;
    <span class="kw1">end</span>
    Bcov  = ResMS*SPM.<span class="me1">xX</span>.<span class="me1">Bcov</span>;
&nbsp;
    <span class="co1">% END OF MODIFICATION</span></pre>
</div>
<p>
then when opening spm, you will have a new fuschia button on the left bottom panel of spm.<br>

</p>

</div>
<div class="secedit editbutton_section editbutton_8"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Plotting spheres instead of voxels] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="166516-168777" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Plotting spheres instead of voxels" type="submit"></div></form></div>
<h2 class="sectionedit9"><a name="beta_extraction" id="beta_extraction">Beta Extraction</a></h2>
<div class="level2">

<p>
<strong><em>Updated by YC</em></strong>
</p>

</div>

<h4><a name="beta_extraction_for_spm" id="beta_extraction_for_spm">Beta Extraction for SPM</a></h4>
<div class="level4">

<p>

Before using the following function, you may change one little thing in spm_results_ui.m to activate a new button in the spm <acronym title="Graphical User Interface">GUI</acronym>.<br>

</p>

<p>
1. search for the <strong>%-Not currently used</strong> sentence (around line 570) and replace the old paragraph by this: 

</p>
<p><a title="reveal" class="folder" href="#folded_18"> this little part</a></p><div class="folded hidden" id="folded_18">
<pre class="code matlab">  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/uicontrol.html"><span class="kw2">uicontrol</span></a><span class="br0">(</span>Finter,<span class="co2">'Style'</span>,<span class="co2">'Frame'</span>,<span class="co2">'Position'</span>,<span class="br0">[</span>010 050 <span class="nu0">110</span> 030<span class="br0">]</span>.*WS<span class="br0">)</span>
  <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>spm<span class="br0">(</span><span class="co2">'CheckModality'</span><span class="br0">)</span>,<span class="co2">'FMRI'</span><span class="br0">)</span>
  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/uicontrol.html"><span class="kw2">uicontrol</span></a><span class="br0">(</span>Finter,<span class="co2">'Style'</span>,<span class="co2">'PushButton'</span>,<span class="co2">'String'</span>,<span class="co2">'Extract Betas'</span>,<span class="co2">'FontSize'</span>,FS<span class="br0">(</span><span class="nu0">10</span><span class="br0">)</span>,<span class="sy0">...</span>
  <span class="co2">'ToolTipString'</span>,<span class="co2">' '</span>,<span class="sy0">...</span>
  <span class="co2">'Callback'</span>,<span class="co2">'extract_clubetas(SPM,xSPM)'</span>,<span class="sy0">...</span>
  <span class="co2">'Interruptible'</span>,<span class="co2">'on'</span>,<span class="co2">'Enable'</span>,<span class="co2">'on'</span>,<span class="sy0">...</span>
  <span class="co2">'Position'</span>,<span class="br0">[</span>015 055 <span class="nu0">100</span> 020<span class="br0">]</span>.*WS,<span class="sy0">...</span>
  <span class="co2">'ForegroundColor'</span>,<span class="co2">'m'</span><span class="br0">)</span>;
  <span class="kw1">end</span></pre>
</div>
<p>

then when opening spm, you will have a new fuschia button on the left bottom panel of spm.<br>

</p>

<p>
2. save the following function as 
</p>
<p><a title="reveal" class="folder " href="#folded_19"> extract_clubetas.m</a></p><div class="folded  hidden" id="folded_19">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=18" title="Download Snippet" class="mediafile mf_m">extract_clubetas.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span>Data<span class="br0">]</span> = extract_clubetas<span class="br0">(</span>SPM,xSPM<span class="br0">)</span>
sub2pr=<span class="br0">[</span><span class="nu0">1</span>:SPM.<span class="me1">nscan</span><span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> Data
<span class="br0">[</span>xyzmm,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'NearestXYZ'</span>,spm_results_ui<span class="br0">(</span><span class="co2">'GetCoords'</span><span class="br0">)</span>,xSPM.<span class="me1">XYZmm</span><span class="br0">)</span>;
spm_results_ui<span class="br0">(</span><span class="co2">'SetCoords'</span>,xSPM.<span class="me1">XYZmm</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
A         = spm_clusters<span class="br0">(</span>xSPM.<span class="me1">XYZ</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>         = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>A == A<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
xyz = xSPM.<span class="me1">XYZmm</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>';
&nbsp;
pathlist = SPM.<span class="me1">xY</span>.<span class="me1">P</span>;
&nbsp;
allbetas= <span class="br0">[</span><span class="br0">]</span>;
Allbetas = <span class="br0">[</span><span class="br0">]</span>;
allxyz = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">%--- to write</span>
XYZ  = SPM.<span class="me1">xVol</span>.<span class="me1">XYZ</span>;
XYZmm = SPM.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,:<span class="br0">)</span>*<span class="br0">[</span>XYZ; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>XYZ,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
bob = spm_input<span class="br0">(</span><span class="co2">'nature of extraction'</span>,<span class="co2">'+1'</span>,<span class="co2">'b'</span>,<span class="co2">'VOI|cluster'</span>,<span class="br0">[</span><span class="nu0">0</span>,<span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> ~bob
    <span class="br0">[</span>xyz xyzmm<span class="br0">]</span> = spm_VOI_yann<span class="br0">(</span>SPM,xSPM<span class="br0">)</span>;
    xyz = xyzmm';
<span class="kw1">end</span>
&nbsp;
cond_list = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>
    mydir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>pathlist<span class="br0">{</span>sub<span class="br0">}</span><span class="br0">)</span>;
    sSPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="br0">[</span>mydir filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>;
    nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">)</span>;<span class="co1">%num of session</span>
    convec = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
        <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">)</span>
            index = sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">col</span><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
            convec<span class="br0">(</span>ses,index<span class="br0">)</span> = <span class="nu0">1</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a> = sSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">)</span>
        b = strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
        list_cond<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    <span class="br0">[</span>b,c,d<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>list_cond,<span class="co2">'first'</span><span class="br0">)</span>;
    <span class="br0">[</span>m n<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sort.html"><span class="kw2">sort</span></a><span class="br0">(</span>c<span class="br0">)</span>;
    cond_list = <span class="br0">[</span>cond_list b<span class="br0">(</span>n<span class="br0">)</span><span class="br0">]</span>;
<span class="kw1">end</span>
<span class="br0">[</span>b,c,d<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>cond_list,<span class="co2">'first'</span><span class="br0">)</span>;
<span class="br0">[</span>m n<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sort.html"><span class="kw2">sort</span></a><span class="br0">(</span>c<span class="br0">)</span>;
thelist = b<span class="br0">(</span>n<span class="br0">)</span>;
&nbsp;
Allbetas = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
&nbsp;
messages = <span class="br0">{</span><span class="co2">'hot baby... hot...'</span> <span class="co2">'what are you thinking about?...'</span> <span class="co2">'wait and see...'</span> <span class="co2">'wait for reaching heaven...'</span> <span class="co2">'Please wait... (no luck! the basic)'</span><span class="br0">}</span>;
colors = <span class="br0">{</span><span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0.4</span>,<span class="nu0">0.6</span><span class="br0">]</span> <span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0.6</span>,<span class="nu0">0.4</span><span class="br0">]</span> <span class="br0">[</span><span class="nu0">0.4</span>,<span class="nu0">1</span>,<span class="nu0">0.6</span><span class="br0">]</span> <span class="br0">[</span><span class="nu0">0.4</span>,<span class="nu0">0.6</span>,<span class="nu0">1</span><span class="br0">]</span> <span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0.4</span>,<span class="nu0">1</span><span class="br0">]</span><span class="br0">}</span>;
<span class="br0">[</span>m n<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sort.html"><span class="kw2">sort</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rand.html"><span class="kw2">rand</span></a><span class="br0">(</span><span class="nu0">1</span>,<span class="nu0">5</span><span class="br0">)</span><span class="br0">)</span>;
h = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/waitbar.html"><span class="kw2">waitbar</span></a><span class="br0">(</span><span class="nu0">0</span>,messages<span class="br0">{</span>n<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">}</span>,<span class="co2">'Color'</span>,colors<span class="br0">{</span>n<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">}</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>
    mydir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>pathlist<span class="br0">{</span>sub<span class="br0">}</span><span class="br0">)</span>;
    sSPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="br0">[</span>mydir filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>;
    nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">)</span>;<span class="co1">%num of session</span>
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span>
        sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">fname</span> = <span class="br0">[</span>mydir filesep sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">fname</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    tmpallbetas= <span class="br0">[</span><span class="br0">]</span>;
    tmpallxyz = <span class="br0">[</span><span class="br0">]</span>;
    Tmpallbetas= <span class="br0">[</span><span class="br0">]</span>;
    list_cond = <span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> cluvox = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xyz,<span class="nu0">1</span><span class="br0">)</span>
        <span class="br0">[</span>nxyz,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'NearestXYZ'</span>,xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span>,XYZmm<span class="br0">)</span>;
        govox=<span class="nu0">1</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>nxyz'-xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span><span class="br0">)</span>.^<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>&gt;=<span class="nu0">1.7321</span> <span class="co1">%one voxel in each dimZ</span>
            govox= spm_input<span class="br0">(</span><span class="br0">{</span><span class="co2">'No data stored for this voxel'</span>,<span class="co2">'Closest voxels with data are:'</span>,<span class="sy0">...</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
                <span class="co2">'Continue anyway?'</span><span class="br0">}</span>,<span class="sy0">...</span>
                <span class="nu0">1</span>,<span class="co2">'bd'</span>,<span class="br0">{</span><span class="co2">'OK'</span>,<span class="co2">'NO'</span><span class="br0">}</span>,<span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        vXYZ     = XYZ<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>  ;         <span class="co1">% coordinates in voxels</span>
&nbsp;
        <span class="co1">%-Get parameter and hyperparameter estimates</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>= spm_get_data<span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span>, vXYZ<span class="br0">)</span>;
&nbsp;
        convec = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
            <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">)</span>
                index = sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">col</span><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
                convec<span class="br0">(</span>ses,index<span class="br0">)</span> = <span class="nu0">1</span>;
            <span class="kw1">end</span>
&nbsp;
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a> = sSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">)</span>
            b = strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
            list_cond<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        tmpallbetas  = <span class="br0">[</span>tmpallbetas; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>'<span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="kw1">for</span> c = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span>
        C = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>thelist<span class="br0">{</span>c<span class="br0">}</span>,list_cond<span class="br0">)</span>;
        Tmpallbetas = <span class="br0">[</span>Tmpallbetas <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>tmpallbetas<span class="br0">(</span>:,C<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    Allbetas<span class="br0">(</span>sub,:<span class="br0">)</span> = Tmpallbetas;
    <span class="co1">%allxyz= [allxyz;mean(tmpallxyz,1)];</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/waitbar.html"><span class="kw2">waitbar</span></a><span class="br0">(</span>sub/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>,h<span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/close.html"><span class="kw2">close</span></a><span class="br0">(</span>h<span class="br0">)</span>
&nbsp;
ctitle = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>nxyz'<span class="br0">)</span> <span class="co2">'  nvox = '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xyz,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
tmpaxe = thelist<span class="br0">(</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
npop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">X</span>,<span class="nu0">2</span><span class="br0">)</span>;
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/reshape.html"><span class="kw2">reshape</span></a><span class="br0">(</span>Allbetas<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/logical.html"><span class="kw2">logical</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">X</span><span class="br0">(</span>:,pop<span class="br0">)</span>,<span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Allbetas,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>SPM.<span class="me1">xX</span>.<span class="me1">X</span><span class="br0">(</span>:,pop<span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Allbetas,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="br0">[</span>Maj,ST,SE<span class="br0">]</span> = yann_bar<span class="br0">(</span>Data<span class="br0">)</span>;
<span class="kw1">switch</span> spm_input<span class="br0">(</span><span class="co2">'errorbar?'</span>,<span class="nu0">2</span>,<span class="co2">'b'</span>,<span class="co2">'yes|no'</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'yes'</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/figure.html"><span class="kw2">figure</span></a>
        h  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/bar.html"><span class="kw2">bar</span></a><span class="br0">(</span>Maj'<span class="br0">)</span>;
        <span class="kw1">for</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Maj,<span class="nu0">1</span><span class="br0">)</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> == <span class="nu0">1</span> &amp; npop &gt; <span class="nu0">1</span>
                N = -<span class="nu0">0.08</span>;
            <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> == <span class="nu0">1</span>
                N = <span class="nu0">0</span>;
            <span class="kw1">else</span>
                N = <span class="nu0">0.08</span>;
            <span class="kw1">end</span>
            <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Maj,<span class="nu0">2</span><span class="br0">)</span>
                coef = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>+npop*N;
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a><span class="br0">(</span><span class="br0">[</span>coef coef<span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> <span class="nu0">0</span> - SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span> + Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a> <span class="br0">(</span><span class="br0">[</span>coef-<span class="nu0">0.05</span> coef+<span class="nu0">0.05</span><span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a> <span class="br0">(</span><span class="br0">[</span>coef-<span class="nu0">0.05</span> coef+<span class="nu0">0.05</span><span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>-SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> -SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'no'</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/figure.html"><span class="kw2">figure</span></a>
        h  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/bar.html"><span class="kw2">bar</span></a><span class="br0">(</span>Maj'<span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/set.html"><span class="kw2">set</span></a><span class="br0">(</span>h,<span class="co2">'FaceColor'</span>,<span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>*.8<span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/set.html"><span class="kw2">set</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/gca.html"><span class="kw2">gca</span></a>, <span class="co2">'XTickLabel'</span>,tmpaxe, <span class="co2">'XTick'</span> , <span class="br0">[</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>tmpaxe<span class="br0">)</span><span class="br0">]</span>,<span class="co2">'FontSize'</span>,<span class="nu0">6</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/title.html"><span class="kw2">title</span></a><span class="br0">(</span>ctitle,<span class="co2">'FontSize'</span>,<span class="nu0">16</span><span class="br0">)</span>
&nbsp;
<span class="co1">%% Functions</span>
<span class="kw1">function</span> <span class="br0">[</span>Maj,ST,SE<span class="br0">]</span> = yann_bar<span class="br0">(</span>Data<span class="br0">)</span>
<span class="co1">% function [Maj,ST,SE] = yann_bar(Data)</span>
<span class="co1">% calculate Mean, stdev and std error for Data</span>
<span class="co1">% developed by Yann Cojan (yann.cojan@unige.ch)</span>
&nbsp;
npop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Data<span class="br0">)</span>
&nbsp;
<span class="kw1">switch</span> spm_input<span class="br0">(</span><span class="co2">'Reset lowest value to:?'</span>,<span class="nu0">1</span>,<span class="co2">'b'</span>,<span class="co2">'zero|mean|unchanged'</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'zero'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            <span class="kw1">if</span> isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>&lt;<span class="nu0">0</span><span class="br0">)</span><span class="br0">)</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>- <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">else</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span> + <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'mean'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span> - <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'unchanged'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
                count = <span class="nu0">1</span>;
                <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                    Maj<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
                <span class="kw1">end</span>
            <span class="kw1">else</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>&gt;<span class="nu0">1</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                SE<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
                ST<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            SE<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
            ST<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">else</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                SE<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
                ST<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            SE<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
            ST<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>XYZ XYZmm<span class="br0">]</span> = spm_VOI_yann<span class="br0">(</span>SPM,xSPM,hReg<span class="br0">)</span>
<span class="co1">% see spm_VOI for help</span>
&nbsp;
<span class="co1">%-Parse arguments</span>
<span class="co1">%-----------------------------------------------------------------------</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; <span class="nu0">2</span>,   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'insufficient arguments'</span><span class="br0">)</span>, <span class="kw1">end</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; <span class="nu0">3</span>,	 hReg = <span class="br0">[</span><span class="br0">]</span>; <span class="kw1">end</span>
&nbsp;
Num      = <span class="nu0">16</span>;			<span class="co1">% maxima per cluster</span>
Dis      = 04;			<span class="co1">% distance among maxima (mm)</span>
&nbsp;
<span class="co1">%-Title</span>
<span class="co1">%-----------------------------------------------------------------------</span>
spm<span class="br0">(</span><span class="co2">'FigName'</span>,<span class="br0">[</span><span class="co2">'SPM{'</span>,xSPM.<span class="me1">STAT</span>,<span class="co2">'}: Small Volume Correction'</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%-Get current location {mm}</span>
<span class="co1">%-----------------------------------------------------------------------</span>
xyzmm    = spm_results_ui<span class="br0">(</span><span class="co2">'GetCoords'</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%-Specify search volume</span>
<span class="co1">%-----------------------------------------------------------------------</span>
str      = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">' at [%.0f,%.0f,%.0f]'</span>,xyzmm<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>,xyzmm<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>,xyzmm<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span><span class="br0">)</span>;
SPACE    = spm_input<span class="br0">(</span><span class="co2">'Search volume...'</span>,-<span class="nu0">1</span>,<span class="co2">'m'</span>,<span class="sy0">...</span>
    <span class="br0">{</span><span class="br0">[</span><span class="co2">'Sphere'</span>,str<span class="br0">]</span>,<span class="br0">[</span><span class="co2">'Box'</span>,str<span class="br0">]</span>,<span class="co2">'Image'</span><span class="br0">}</span>,<span class="br0">[</span><span class="co2">'S'</span>,<span class="co2">'B'</span>,<span class="co2">'I'</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% voxels in entire search volume {mm}</span>
<span class="co1">%-----------------------------------------------------------------------</span>
XYZmm    = SPM.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,:<span class="br0">)</span>*<span class="br0">[</span>SPM.<span class="me1">xVol</span>.<span class="me1">XYZ</span>; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>, SPM.<span class="me1">xVol</span>.<span class="me1">S</span><span class="br0">)</span><span class="br0">]</span>;
Q        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xSPM.<span class="me1">XYZmm</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
O        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>     XYZmm,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
FWHM     = xSPM.<span class="me1">FWHM</span>;
&nbsp;
&nbsp;
<span class="kw1">switch</span> SPACE
&nbsp;
    <span class="kw1">case</span> <span class="co2">'S'</span> <span class="co1">%-Sphere</span>
        <span class="co1">%---------------------------------------------------------------</span>
        D          = spm_input<span class="br0">(</span><span class="co2">'radius of VOI {mm}'</span>,-<span class="nu0">2</span><span class="br0">)</span>;
        str        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%0.1fmm sphere'</span>,D<span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>xSPM.<span class="me1">XYZmm</span> - xyzmm*Q<span class="br0">)</span>.^<span class="nu0">2</span><span class="br0">)</span> &lt;= D^<span class="nu0">2</span><span class="br0">)</span>;
        k          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>     XYZmm - xyzmm*O<span class="br0">)</span>.^<span class="nu0">2</span><span class="br0">)</span> &lt;= D^<span class="nu0">2</span><span class="br0">)</span>;
        D          = D./xSPM.<span class="me1">VOX</span>;
&nbsp;
&nbsp;
    <span class="kw1">case</span> <span class="co2">'B'</span> <span class="co1">%-Box</span>
        <span class="co1">%---------------------------------------------------------------</span>
        D          = spm_input<span class="br0">(</span><span class="co2">'box dimensions [k l m] {mm}'</span>,-<span class="nu0">2</span><span class="br0">)</span>;
        str        = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%0.1f x %0.1f x %0.1f mm box'</span>,D<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>,D<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>,D<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span><span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span>xSPM.<span class="me1">XYZmm</span> - xyzmm*Q<span class="br0">)</span> &lt;= D<span class="br0">(</span>:<span class="br0">)</span>*Q/<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
        k          = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span>     XYZmm - xyzmm*O<span class="br0">)</span> &lt;= D<span class="br0">(</span>:<span class="br0">)</span>*O/<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
        D          = D./xSPM.<span class="me1">VOX</span>;
&nbsp;
&nbsp;
    <span class="kw1">case</span> <span class="co2">'I'</span> <span class="co1">%-Mask Image</span>
        <span class="co1">%---------------------------------------------------------------</span>
        Msk   = spm_select<span class="br0">(</span><span class="nu0">1</span>,<span class="co2">'image'</span>,<span class="co2">'Image defining search volume'</span><span class="br0">)</span>;
        D     = spm_vol<span class="br0">(</span>Msk<span class="br0">)</span>;
        str   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'image mask: %s'</span>,spm_str_manip<span class="br0">(</span>Msk,<span class="co2">'a30'</span><span class="br0">)</span><span class="br0">)</span>;
        VOX   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>D.<span class="me1">mat</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,<span class="nu0">1</span>:<span class="nu0">3</span><span class="br0">)</span>.^<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
        FWHM  = FWHM.*<span class="br0">(</span>xSPM.<span class="me1">VOX</span>./VOX<span class="br0">)</span>;
        XYZ   = D.<span class="me1">mat</span> \ <span class="br0">[</span>xSPM.<span class="me1">XYZmm</span>; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xSPM.<span class="me1">XYZmm</span>, <span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>spm_sample_vol<span class="br0">(</span>D, XYZ<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span>, XYZ<span class="br0">(</span><span class="nu0">2</span>,:<span class="br0">)</span>, XYZ<span class="br0">(</span><span class="nu0">3</span>,:<span class="br0">)</span>,<span class="nu0">0</span><span class="br0">)</span> &gt; <span class="nu0">0</span><span class="br0">)</span>;
        XYZ   = D.<span class="me1">mat</span> \ <span class="br0">[</span>     XYZmm; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>    XYZmm, <span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
        k     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>spm_sample_vol<span class="br0">(</span>D, XYZ<span class="br0">(</span><span class="nu0">1</span>,:<span class="br0">)</span>, XYZ<span class="br0">(</span><span class="nu0">2</span>,:<span class="br0">)</span>, XYZ<span class="br0">(</span><span class="nu0">3</span>,:<span class="br0">)</span>,<span class="nu0">0</span><span class="br0">)</span> &gt; <span class="nu0">0</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">end</span>
&nbsp;
xSPM.<span class="me1">S</span>     = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>k<span class="br0">)</span>;
xSPM.<span class="me1">R</span>     = spm_resels<span class="br0">(</span>FWHM,D,SPACE<span class="br0">)</span>;
xSPM.<span class="me1">Z</span>     = xSPM.<span class="me1">Z</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>;
xSPM.<span class="me1">XYZ</span>   = xSPM.<span class="me1">XYZ</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>;
xSPM.<span class="me1">XYZmm</span> = xSPM.<span class="me1">XYZmm</span><span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>;
xSPM.<span class="me1">Ps</span>    = xSPM.<span class="me1">Ps</span><span class="br0">(</span>k<span class="br0">)</span>;
XYZ = xSPM.<span class="me1">XYZ</span>;
XYZmm = xSPM.<span class="me1">XYZmm</span>;
<span class="co1">%-Tabulate p values</span>
<span class="co1">%-----------------------------------------------------------------------</span>
str       = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'search volume: %s'</span>,str<span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>SPACE,<span class="br0">{</span><span class="co2">'S'</span>,<span class="co2">'B'</span><span class="br0">}</span><span class="br0">)</span><span class="br0">)</span>
    str = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'%s at [%.0f,%.0f,%.0f]'</span>,str,xyzmm<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>,xyzmm<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>,xyzmm<span class="br0">(</span><span class="nu0">3</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
TabDat    = spm_list<span class="br0">(</span><span class="co2">'List'</span>,xSPM,hReg,Num,Dis,str<span class="br0">)</span>;
&nbsp;
<span class="co1">%-Reset title</span>
<span class="co1">%-----------------------------------------------------------------------</span>
spm<span class="br0">(</span><span class="co2">'FigName'</span>,<span class="br0">[</span><span class="co2">'SPM{'</span>,xSPM.<span class="me1">STAT</span>,<span class="co2">'}: Results'</span><span class="br0">]</span><span class="br0">)</span>;</pre>
</dd></dl>
</div>
</div>

<h4><a name="beta_extraction_for_xjview" id="beta_extraction_for_xjview">Beta Extraction for xjview</a></h4>
<div class="level4">
<p><a title="reveal" class="folder" href="#folded_20"> First add this little part (around line 353) in xjview.m</a></p><div class="folded hidden" id="folded_20">
<pre class="code matlab">handles.<span class="me1">extract_betasPush</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/uicontrol.html"><span class="kw2">uicontrol</span></a><span class="br0">(</span>handles.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/figure.html"><span class="kw2">figure</span></a>, <span class="co2">'style'</span>, <span class="co2">'push'</span>,<span class="sy0">...</span>
    <span class="co2">'unit'</span>,<span class="co2">'normalized'</span>,<span class="sy0">...</span>
    <span class="co2">'String'</span>, <span class="co2">'Extract Betas'</span>, <span class="sy0">...</span>
    <span class="co2">'position'</span>, ExtractBetasPosition,<span class="sy0">...</span>
    <span class="co2">'callback'</span>, @CallBack_extract_clubetas,<span class="sy0">...</span>
    <span class="co2">'ForeGroundColor'</span>,<span class="co2">'m'</span>,<span class="sy0">...</span>
    <span class="co2">'visible'</span>, <span class="co2">'on'</span><span class="br0">)</span>;</pre>
</div>
<p>
 between <strong>'callback', @CallBack_commonRegionPush);</strong> and <strong>handles.displayPush </strong>
</p>
<p><a title="hide" class="folder open" href="#folded_21"> Then add the following part at the end of xjview.m just before the last return</a></p><div class="folded " id="folded_21">
<pre class="code matlab"><span class="kw1">function</span> CallBack_extract_clubetas<span class="br0">(</span>hObject, eventdata, readdata<span class="br0">)</span>
<span class="kw1">if</span> nargin&lt;<span class="nu0">3</span>
    readdata=<span class="nu0">1</span>;
<span class="kw1">end</span>
&nbsp;
 handles = guidata<span class="br0">(</span>hObject<span class="br0">)</span>;
<span class="br0">[</span>img.<span class="me1">p</span>, img.<span class="me1">fname</span>, img.<span class="me1">ext</span><span class="br0">]</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>handles.<span class="me1">imageFileName</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>;
spmfile=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>img.<span class="me1">p</span>,<span class="co2">'SPM.mat'</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>spmfile<span class="br0">(</span><span class="nu0">3</span>:<span class="kw1">end</span><span class="br0">)</span>, <span class="co2">'file'</span><span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'Possible disk swapping in xjview.m'</span><span class="br0">)</span>;
    spmfile=spmfile<span class="br0">(</span><span class="nu0">3</span>:<span class="kw1">end</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>spmfile<span class="br0">)</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'SPM2'</span>,spm<span class="br0">(</span><span class="co2">'ver'</span><span class="br0">)</span><span class="br0">)</span>
        spmfile = spm_get<span class="br0">(</span><span class="br0">[</span><span class="nu0">0</span> <span class="nu0">1</span><span class="br0">]</span>,<span class="co2">'SPM.mat'</span>,<span class="co2">'locate the RFX SPM.mat'</span><span class="br0">)</span>;
    <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span><span class="co2">'SPM5'</span>,spm<span class="br0">(</span><span class="co2">'ver'</span><span class="br0">)</span><span class="br0">)</span>
        spmfile = spm_select<span class="br0">(</span><span class="br0">[</span><span class="nu0">0</span>:<span class="nu0">1</span><span class="br0">]</span>,<span class="co2">'SPM.mat'</span>,<span class="co2">'locate the RFX SPM.mat'</span><span class="br0">)</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>spmfile<span class="br0">)</span>
    <span class="kw1">return</span>
<span class="kw1">end</span>
xSPM=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span>spmfile, <span class="co2">'SPM'</span><span class="br0">)</span>;
<span class="br0">[</span>glmpath, glmpath<span class="br0">]</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>xSPM.<span class="me1">SPM</span>.<span class="me1">swd</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
clu = handles.<span class="me1">currentDisplayMNI</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span>;
center = handles.<span class="me1">currentxyz</span>;
mni = cell2mat<span class="br0">(</span>handles.<span class="me1">currentDisplayMNI</span>'<span class="br0">)</span>;
cor = mni2cor<span class="br0">(</span>mni, handles.<span class="me1">M</span><span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>;
<span class="br0">[</span>xyzmm,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'NearestXYZ'</span>,center,mni'<span class="br0">)</span>;
A = spm_clusters<span class="br0">(</span>cor'<span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>A == A<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
xyz = mni<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>,:<span class="br0">)</span>;
sub2pr=<span class="br0">[</span><span class="nu0">1</span>:xSPM.<span class="me1">SPM</span>.<span class="me1">nscan</span><span class="br0">]</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> Data
pathlist = xSPM.<span class="me1">SPM</span>.<span class="me1">xY</span>.<span class="me1">P</span>;
&nbsp;
allbetas= <span class="br0">[</span><span class="br0">]</span>;
Allbetas = <span class="br0">[</span><span class="br0">]</span>;
allxyz = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">%--- to write</span>
XYZ  = xSPM.<span class="me1">SPM</span>.<span class="me1">xVol</span>.<span class="me1">XYZ</span>;
XYZmm = xSPM.<span class="me1">SPM</span>.<span class="me1">xVol</span>.<span class="me1">M</span><span class="br0">(</span><span class="nu0">1</span>:<span class="nu0">3</span>,:<span class="br0">)</span>*<span class="br0">[</span>XYZ; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ones.html"><span class="kw2">ones</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>XYZ,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
bob = spm_input<span class="br0">(</span><span class="co2">'nature of extraction'</span>,<span class="co2">'+1'</span>,<span class="co2">'b'</span>,<span class="co2">'VOI|cluster'</span>,<span class="br0">[</span><span class="nu0">0</span>,<span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">if</span> ~bob
    radius=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/inputdlg.html"><span class="kw2">inputdlg</span></a><span class="br0">(</span><span class="co2">'Radius of the sphere?'</span><span class="br0">)</span>;
    <span class="kw1">if</span> isempty<span class="br0">(</span>radius<span class="br0">)</span>
        <span class="kw1">return</span>
    <span class="kw1">end</span>
    radius=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2num.html"><span class="kw2">str2num</span></a><span class="br0">(</span>radius<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span><span class="br0">)</span>;
    <span class="br0">[</span>d<span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'Edist'</span>,center,XYZmm<span class="br0">)</span>;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>d&lt;=radius<span class="br0">)</span>;
    clus=XYZmm<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
    xyz = clus';
<span class="kw1">end</span>
&nbsp;
cond_list = <span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>
    mydir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>pathlist<span class="br0">{</span>sub<span class="br0">}</span><span class="br0">)</span>;
    <span class="co1">%% initiation of matrix Allbetas and Tmpallbetas with the max</span>
    <span class="co1">%% number of conditions</span>
    sSPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="br0">[</span>mydir filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>;
    nses = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">)</span>;<span class="co1">%num of session</span>
    convec = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
        <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">)</span>
            index = sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">col</span><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
            convec<span class="br0">(</span>ses,index<span class="br0">)</span> = <span class="nu0">1</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a> = sSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec<span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">)</span>
        b = strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
        list_cond<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    cond_list = <span class="br0">[</span>cond_list <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>list_cond<span class="br0">)</span><span class="br0">]</span>;
<span class="kw1">end</span>
thelist = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>cond_list<span class="br0">)</span>;
Allbetas = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
h = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/waitbar.html"><span class="kw2">waitbar</span></a><span class="br0">(</span><span class="nu0">0</span>,<span class="co2">'Please Wait...'</span><span class="br0">)</span>;
<span class="kw1">for</span> sub = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>
    mydir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>pathlist<span class="br0">{</span>sub<span class="br0">}</span><span class="br0">)</span>;
    sSPM = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a><span class="br0">(</span><span class="br0">[</span>mydir filesep <span class="co2">'SPM.mat'</span><span class="br0">]</span><span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span>
        sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">fname</span> = <span class="br0">[</span>mydir filesep sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>.<span class="me1">fname</span><span class="br0">]</span>;
    <span class="kw1">end</span>
    tmpallbetas= <span class="br0">[</span><span class="br0">]</span>;
    tmpallxyz = <span class="br0">[</span><span class="br0">]</span>;
    Tmpallbetas= <span class="br0">[</span><span class="br0">]</span>;
    list_cond = <span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">for</span> cluvox = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xyz,<span class="nu0">1</span><span class="br0">)</span>
        <span class="br0">[</span>nxyz,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span> = spm_XYZreg<span class="br0">(</span><span class="co2">'NearestXYZ'</span>,xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span>,XYZmm<span class="br0">)</span>;
        govox=<span class="nu0">1</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><span class="br0">(</span>nxyz'-xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span><span class="br0">)</span>.^<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>&gt;=<span class="nu0">1.7321</span> <span class="co1">%one voxel in each dimZ</span>
            govox= spm_input<span class="br0">(</span><span class="br0">{</span><span class="co2">'No data stored for this voxel'</span>,<span class="co2">'Closest voxels with data are:'</span>,<span class="sy0">...</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>xyz<span class="br0">(</span>cluvox,:<span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
                <span class="co2">'Continue anyway?'</span><span class="br0">}</span>,<span class="sy0">...</span>
                <span class="nu0">1</span>,<span class="co2">'bd'</span>,<span class="br0">{</span><span class="co2">'OK'</span>,<span class="co2">'NO'</span><span class="br0">}</span>,<span class="br0">[</span><span class="nu0">1</span>,<span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        vXYZ     = XYZ<span class="br0">(</span>:,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>  ;         <span class="co1">% coordinates in voxels</span>
&nbsp;
        <span class="co1">%-Get parameter and hyperparameter estimates</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a>= spm_get_data<span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span>, vXYZ<span class="br0">)</span>;
&nbsp;
        convec = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Vbeta</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">for</span> ses = <span class="nu0">1</span>:nses
            <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">)</span>
                index = sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">col</span><span class="br0">(</span>sSPM.<span class="me1">SPM</span>.<span class="me1">Sess</span><span class="br0">(</span>ses<span class="br0">)</span>.<span class="me1">Fc</span><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
                convec<span class="br0">(</span>ses,index<span class="br0">)</span> = <span class="nu0">1</span>;
            <span class="kw1">end</span>
&nbsp;
        <span class="kw1">end</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a> = sSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">name</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec<span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">)</span>
            b = strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'*bf'</span><span class="br0">)</span>;
            list_cond<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/real.html"><span class="kw2">real</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">(</span><span class="nu0">7</span>:b-<span class="nu0">1</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        tmpallbetas  = <span class="br0">[</span>tmpallbetas; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/beta.html"><span class="kw2">beta</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>convec<span class="br0">)</span><span class="br0">)</span>'<span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="kw1">for</span> c = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span>
        C = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>thelist<span class="br0">{</span>c<span class="br0">}</span>,list_cond<span class="br0">)</span>;
        Tmpallbetas = <span class="br0">[</span>Tmpallbetas <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>tmpallbetas<span class="br0">(</span>:,C<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
&nbsp;
    Allbetas<span class="br0">(</span>sub,:<span class="br0">)</span> = Tmpallbetas;
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/waitbar.html"><span class="kw2">waitbar</span></a><span class="br0">(</span>sub/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>sub2pr<span class="br0">)</span>,h<span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/close.html"><span class="kw2">close</span></a><span class="br0">(</span>h<span class="br0">)</span>
&nbsp;
ctitle = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>nxyz'<span class="br0">)</span> <span class="co2">'  nvox = '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xyz,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="br0">]</span>;
tmpaxe = thelist<span class="br0">(</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>thelist<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
npop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>xSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">X</span>,<span class="nu0">2</span><span class="br0">)</span>;
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/reshape.html"><span class="kw2">reshape</span></a><span class="br0">(</span>Allbetas<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/logical.html"><span class="kw2">logical</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>xSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">X</span><span class="br0">(</span>:,pop<span class="br0">)</span>,<span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Allbetas,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span>xSPM.<span class="me1">SPM</span>.<span class="me1">xX</span>.<span class="me1">X</span><span class="br0">(</span>:,pop<span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Allbetas,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="br0">[</span>Maj,ST,SE<span class="br0">]</span> = yann_bar<span class="br0">(</span>Data<span class="br0">)</span>;
<span class="kw1">switch</span> spm_input<span class="br0">(</span><span class="co2">'errorbar?'</span>,<span class="nu0">2</span>,<span class="co2">'b'</span>,<span class="co2">'yes|no'</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'yes'</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/figure.html"><span class="kw2">figure</span></a>
        h  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/bar.html"><span class="kw2">bar</span></a><span class="br0">(</span>Maj'<span class="br0">)</span>;
        <span class="kw1">for</span>  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Maj,<span class="nu0">1</span><span class="br0">)</span>
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> == <span class="nu0">1</span> &amp; npop &gt; <span class="nu0">1</span>
                N = -<span class="nu0">0.08</span>;
            <span class="kw1">elseif</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a> == <span class="nu0">1</span>
                N = <span class="nu0">0</span>;
            <span class="kw1">else</span>
                N = <span class="nu0">0.08</span>;
            <span class="kw1">end</span>
            <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a> = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Maj,<span class="nu0">2</span><span class="br0">)</span>
                coef = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a>+npop*N;
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a><span class="br0">(</span><span class="br0">[</span>coef coef<span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> <span class="nu0">0</span> - SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span> + Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a> <span class="br0">(</span><span class="br0">[</span>coef-<span class="nu0">0.05</span> coef+<span class="nu0">0.05</span><span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/line.html"><span class="kw2">line</span></a> <span class="br0">(</span><span class="br0">[</span>coef-<span class="nu0">0.05</span> coef+<span class="nu0">0.05</span><span class="br0">]</span>,<span class="br0">(</span><span class="br0">[</span>-SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span> -SE<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>+Maj<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/i.html"><span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/j.html"><span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span><span class="br0">]</span><span class="br0">)</span>,<span class="sy0">...</span>
                    <span class="co2">'LineWidth'</span>,<span class="nu0">1.5</span>,<span class="co2">'Color'</span>,<span class="co2">'k'</span><span class="br0">)</span>
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'no'</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/figure.html"><span class="kw2">figure</span></a>
        h  = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/bar.html"><span class="kw2">bar</span></a><span class="br0">(</span>Maj'<span class="br0">)</span>;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/set.html"><span class="kw2">set</span></a><span class="br0">(</span>h,<span class="co2">'FaceColor'</span>,<span class="br0">[</span><span class="nu0">1</span> <span class="nu0">1</span> <span class="nu0">1</span><span class="br0">]</span>*.8<span class="br0">)</span>
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/set.html"><span class="kw2">set</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/gca.html"><span class="kw2">gca</span></a>, <span class="co2">'XTickLabel'</span>,tmpaxe, <span class="co2">'XTick'</span> , <span class="br0">[</span><span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>tmpaxe<span class="br0">)</span><span class="br0">]</span>,<span class="co2">'FontSize'</span>,<span class="nu0">6</span><span class="br0">)</span>;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/title.html"><span class="kw2">title</span></a><span class="br0">(</span>ctitle,<span class="co2">'FontSize'</span>,<span class="nu0">16</span><span class="br0">)</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>Maj,ST,SE<span class="br0">]</span> = yann_bar<span class="br0">(</span>Data<span class="br0">)</span>
<span class="co1">% function [Maj,ST,SE] = yann_bar(Data)</span>
<span class="co1">% calculate Mean, stdev and std error for Data</span>
<span class="co1">% adapted by Yann Cojan (yann.cojan@unige.ch)</span>
&nbsp;
npop = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>Data<span class="br0">)</span>
&nbsp;
<span class="kw1">switch</span> spm_input<span class="br0">(</span><span class="co2">'Reset lowest value to:?'</span>,<span class="nu0">1</span>,<span class="co2">'b'</span>,<span class="co2">'zero|mean|unchanged'</span><span class="br0">)</span>;
    <span class="kw1">case</span> <span class="co2">'zero'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            <span class="kw1">if</span> isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>&lt;<span class="nu0">0</span><span class="br0">)</span><span class="br0">)</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>- <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">else</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span> + <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/min.html"><span class="kw2">min</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'mean'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span> - <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">case</span> <span class="co2">'unchanged'</span>
        <span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
            <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
                count = <span class="nu0">1</span>;
                <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                    Maj<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
                <span class="kw1">end</span>
            <span class="kw1">else</span>
                Maj<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/mean.html"><span class="kw2">mean</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">for</span> pop = <span class="nu0">1</span>:npop
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span>&gt;<span class="nu0">1</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                SE<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
                ST<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            SE<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
            ST<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">else</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">for</span> hu = <span class="nu0">1</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span>
                 SE<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>/<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sqrt.html"><span class="kw2">sqrt</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span>;
                ST<span class="br0">(</span>pop,hu<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/std.html"><span class="kw2">std</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>~isnan<span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span><span class="br0">(</span>:,hu<span class="br0">)</span><span class="br0">)</span>,hu<span class="br0">)</span><span class="br0">)</span>;
            <span class="kw1">end</span>
        <span class="kw1">else</span>
            SE<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
            ST<span class="br0">(</span>pop,:<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>Data<span class="br0">{</span>pop<span class="br0">}</span>,<span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span></pre>
</div>
</div>

<h4><a name="remark_concerning_the_standard_error_estimated_by_spm" id="remark_concerning_the_standard_error_estimated_by_spm">Remark concerning the standard error estimated by SPM</a></h4>
<div class="level4">

<p>
<strong><em>Updated by SP June 22th 2011</em></strong>
</p>

<p>
You will notice that if you estimate the SEM of your extracted beta - 
using std(beta)/sqrt(n) - you will find a very different estimate than 
the one calculated by SPM.
This is because SPM derives the SE from the unexplained variance in the 
model, ie the variance of the residual. This is calculated in spm_graph,
 line ~328.
SE    = sqrt(diag(SPM.xCon(Ic).c'*Bcov*SPM.xCon(Ic).c));
% knowing that Bcov  = ResMS*SPM.xX.Bcov
</p>

<p>
In a traditional ANOVA language, this is equivalent to the root mean 
square error (RMSE = sqrt(MSE) = SQRT(STD/SQRT(n))^2 = SQRT(SE)^2) aka 
the standard error.
<a href="http://en.wikipedia.org/wiki/Root_mean_square_deviation" class="urlextern" title="http://en.wikipedia.org/wiki/Root_mean_square_deviation" rel="nofollow">http://en.wikipedia.org/wiki/Root_mean_square_deviation</a>
<a href="http://en.wikipedia.org/wiki/Mean_squared_error" class="urlextern" title="http://en.wikipedia.org/wiki/Mean_squared_error" rel="nofollow">http://en.wikipedia.org/wiki/Mean_squared_error</a>
</p>

<p>
You can find some useful SPM posts here:<br>

<a href="https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R20753&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4" class="urlextern" title="https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R20753&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4" rel="nofollow">https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R20753&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4</a><br>

<a href="https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R27896&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4" class="urlextern" title="https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R27896&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4" rel="nofollow">https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=ind0708&amp;L=SPM&amp;P=R27896&amp;1=SPM&amp;9=A&amp;I=-3&amp;J=on&amp;d=No+Match%3BMatch%3BMatches&amp;z=4</a>
</p>

</div>
<div class="secedit editbutton_section editbutton_9"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Beta Extraction] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="168778-188544" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Beta Extraction" type="submit"></div></form></div>
<h2 class="sectionedit10"><a name="code_snippets" id="code_snippets">Code Snippets</a></h2>
<div class="level2">

<p>

Need help with SPM? Want to program something?
</p>

<p>
First, have a look at the <a href="http://www.jiscmail.ac.uk/cgi-bin/webadmin?A0=spm" class="urlextern" title="http://www.jiscmail.ac.uk/cgi-bin/webadmin?A0=spm" rel="nofollow">SPM mailing-list</a> (<a href="http://www.jiscmail.ac.uk/cgi-bin/wa.exe?S1=spm" class="urlextern" title="http://www.jiscmail.ac.uk/cgi-bin/wa.exe?S1=spm" rel="nofollow">Search page</a>).
</p>

<p>
Second, hasn't John Ashburner already done it in his <a href="http://www.sph.umich.edu/%7Enichols/JohnsGems.html" class="urlextern" title="http://www.sph.umich.edu/~nichols/JohnsGems.html" rel="nofollow">SPM99</a>, <a href="http://www.sph.umich.edu/%7Enichols/JohnsGems2.html" class="urlextern" title="http://www.sph.umich.edu/~nichols/JohnsGems2.html" rel="nofollow">SPM2</a>, <a href="http://www.sph.umich.edu/%7Enichols/JohnsGems5.html" class="urlextern" title="http://www.sph.umich.edu/~nichols/JohnsGems5.html" rel="nofollow">SPM5</a> Gems?
</p>

<p>
Third, you may find it below…
</p>

</div>

<h3><a name="image_calculator" id="image_calculator">Image Calculator</a></h3>
<div class="level3">

<p>

This is an example how to batch the Image Calculator function (spm_imcalc) for several subjects (SPM2):

</p>
<p><a title="reveal" class="folder" href="#folded_22"> How to Batch a Image Calculator function for several subjects</a></p><div class="folded hidden" id="folded_22">
<pre class="code matlab"><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a>
&nbsp;
sub2pr  = str2mat<span class="br0">(</span><span class="co2">'s01'</span>,<span class="co2">'s02'</span>,<span class="co2">'s03'</span>,<span class="co2">'s04'</span>,<span class="co2">'s05'</span>,<span class="co2">'s06'</span>,<span class="co2">'s07'</span>,<span class="co2">'s08'</span>,<span class="co2">'s09'</span>,<span class="co2">'s10'</span>,<span class="co2">'s11'</span>,<span class="co2">'s12'</span>,<span class="co2">'s13'</span>,<span class="co2">'s14'</span>,<span class="co2">'s15'</span>,<span class="co2">'s16'</span><span class="br0">)</span>;
n_sub   = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>sub2pr,<span class="nu0">1</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> k        = <span class="nu0">1</span>:n_sub;
    ksub2pr  = sub2pr<span class="br0">(</span>k,:<span class="br0">)</span>;
&nbsp;
    <span class="co1">% INPUT IMAGE:  </span>
    p_INPUT  = <span class="br0">[</span><span class="co2">'D:\Gschwind\Data\CHUV_2006'</span> filesep ksub2pr filesep <span class="co2">'ANAT'</span> filesep <span class="co2">'IBA'</span> filesep <span class="co2">'Atlased'</span><span class="br0">]</span>; 
    V_in       = spm_get<span class="br0">(</span><span class="co2">'Files'</span>,p_INPUT,<span class="co2">'struct_mpr_radiol_Atlas.img'</span><span class="br0">)</span> <span class="co1">%change for spm_select in SPM5</span>
&nbsp;
    <span class="co1">% OUTPUT IMAGE</span>
    V_out  = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>p_INPUT,<span class="co2">'cerebellum.img'</span><span class="br0">)</span><span class="br0">]</span> <span class="co1">% give a new name and change p_INPUT if necessary</span>
&nbsp;
    <span class="co1">% IMCALC FUNCTION</span>
    f   = <span class="co2">'i1&gt;90'</span>; 
&nbsp;
    V_out  = spm_imcalc_ui<span class="br0">(</span>V_in,V_out,f<span class="br0">)</span>   
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/close.html"><span class="kw2">close</span></a> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a> </pre>
</div>
</div>

<h3><a name="moving_data_or_spmmat" id="moving_data_or_spmmat">Moving Data or SPM.mat</a></h3>
<div class="level3">

<p>

In case your data have “moved hose” from one computer to another or within the computer, SPM.mat needs to know the new adress.
This is an example how to move house for SPM.mat:

</p>
<p><a title="hide" class="folder open" href="#folded_23"> Moving house script for SPM.mat</a></p><div class="folded " id="folded_23">

<pre class="code matlab"><span class="kw1">function</span> MG_moveSPM
&nbsp;
<span class="kw1">if</span> spm<span class="br0">(</span><span class="co2">'ver'</span><span class="br0">)</span>==<span class="co2">'SPM2'</span>
    mypath = spm_get<span class="br0">(</span>-<span class="nu0">1</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>,<span class="co2">'Select parent directory with all SPM.mat to move in its childs!'</span><span class="br0">)</span>;
<span class="kw1">else</span>
    mypath = spm_select<span class="br0">(</span><span class="nu0">1</span>,<span class="co2">'dir'</span>,<span class="co2">'Select parent directory with all SPM.mat to move in its childs!'</span>,<span class="co2">''</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a><span class="br0">)</span>
<span class="kw1">end</span>
mypathlist = genpath<span class="br0">(</span>mypath<span class="br0">)</span>;
mypathlist = strread<span class="br0">(</span>mypathlist,<span class="co2">'%s'</span>,<span class="co2">'delimiter'</span>,<span class="co2">';'</span><span class="br0">)</span>;
&nbsp;
<span class="kw1">for</span> d=<span class="nu0">2</span>:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/size.html"><span class="kw2">size</span></a><span class="br0">(</span>mypathlist<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>mypathlist<span class="br0">{</span>d<span class="br0">}</span><span class="br0">)</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><span class="co2">'SPM.mat'</span><span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/load.html"><span class="kw2">load</span></a> SPM;
        xSPM=SPM;
        xSPM.<span class="me1">swd</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/pwd.html"><span class="kw2">pwd</span></a>;
        SPM=xSPM;
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'SPM.mat is changed!!'</span><span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/save.html"><span class="kw2">save</span></a> SPM.<span class="me1">mat</span> SPM
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span>xSPM.<span class="me1">swd</span><span class="br0">)</span>
    <span class="kw1">end</span>
<span class="kw1">end</span></pre>
</div>
</div>

<h3><a name="read_eprime_text_files" id="read_eprime_text_files">Read Eprime text files</a></h3>
<div class="level3">
<p><a title="reveal" class="folder " href="#folded_24"> save this function as read_eprimetxt.m</a></p><div class="folded  hidden" id="folded_24">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=23" title="Download Snippet" class="mediafile mf_m">read_eprimetxt.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> <span class="br0">[</span>hnames,A,B,tvals,rowlevel<span class="br0">]</span> = read_eprimetxt<span class="br0">(</span>filename, varnames<span class="br0">)</span>
<span class="co1">% read_eprimetxt - reads E-prime text files as edat</span>
<span class="co1">%     V = read_eprimetxt('FILENAME') returns in V, the names of variables found in</span>
<span class="co1">%     the E-Prime text file FILENAME (in alphabetical order)</span>
<span class="co1">%</span>
<span class="co1">%     [V, A, B] = read_eprimetxt('FILENAME') also returns numeric data, stored in A, and text</span>
<span class="co1">%     data, stored in B.</span>
<span class="co1">%</span>
<span class="co1">% See also: xlsread</span>
&nbsp;
txt=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/textread.html"><span class="kw2">textread</span></a><span class="br0">(</span>filename, <span class="co2">'%s'</span>, <span class="nu0">1</span>, <span class="co2">'delimiter'</span>, <span class="co2">'\n'</span><span class="br0">)</span>;
<span class="kw1">if</span> isequal<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/double.html"><span class="kw2">double</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/textread.html"><span class="kw2">textread</span></a><span class="br0">(</span>filename, <span class="co2">'%c'</span>, <span class="nu0">3</span><span class="br0">)</span><span class="br0">)</span>', <span class="br0">[</span><span class="nu0">65535</span> <span class="nu0">65534</span> <span class="nu0">42</span><span class="br0">]</span><span class="br0">)</span>
    <span class="co1">%  Null separated characters...</span>
    fid=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>filename,<span class="co2">'rt'</span><span class="br0">)</span>;
    txt=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/char.html"><span class="kw2">char</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fid, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/getfield.html"><span class="kw2">getfield</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/dir.html"><span class="kw2">dir</span></a><span class="br0">(</span>filename<span class="br0">)</span>, <span class="co2">'bytes'</span><span class="br0">)</span>, <span class="co2">'char'</span><span class="br0">)</span><span class="br0">)</span>';
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fid<span class="br0">)</span>;
    txt<span class="br0">(</span>txt==255<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
    txt<span class="br0">(</span>txt==254<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
    txt<span class="br0">(</span>txt==0<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
    txt=strread<span class="br0">(</span>txt, <span class="co2">'%s'</span>, <span class="co2">'delimiter'</span>, <span class="co2">'\n'</span><span class="br0">)</span>;
<span class="kw1">elseif</span> isequal<span class="br0">(</span>txt, <span class="br0">{</span><span class="co2">'*** Header Start ***'</span><span class="br0">}</span><span class="br0">)</span>
    txt=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/textread.html"><span class="kw2">textread</span></a><span class="br0">(</span>filename, <span class="co2">'%s'</span>, <span class="co2">'delimiter'</span>, <span class="co2">'\n'</span><span class="br0">)</span>;
<span class="kw1">else</span>
    hnames<span class="br0">{</span><span class="nu0">1</span><span class="br0">}</span> = <span class="co2">'impossible'</span>;
    A = <span class="br0">[</span><span class="br0">]</span>;
    B = <span class="br0">[</span><span class="br0">]</span>;
    tvals = <span class="br0">[</span><span class="br0">]</span>;
    rowlevel = <span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">return</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Wrong type of file, it should be an E-prime generated text file, starting with a header'</span><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="co1">% Header.nvars=strmatch('*** Header End ***', txt)-strmatch('*** Header Start ***', txt)-1;</span>
&nbsp;
&nbsp;
<span class="co1">%% Vars</span>
v=txt;
v<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'*** '</span>, txt<span class="br0">)</span><span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/datenum.html"><span class="kw2">datenum</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/version.html"><span class="kw2">version</span></a><span class="br0">(</span><span class="co2">'-date'</span><span class="br0">)</span><span class="br0">)</span> &gt; <span class="nu0">733044</span> <span class="co1">%732892 % 732687 % 732341</span>
    <span class="br0">[</span>vnames, vvals<span class="br0">]</span>=strread<span class="br0">(</span>v,<span class="co2">'%s%s'</span>,<span class="nu0">1</span>,<span class="co2">'delimiter'</span>, <span class="co2">': '</span><span class="br0">)</span>;
    <span class="co1">% elseif str2num(version('-release'))&gt;=14</span>
    <span class="co1">%         %it still bugs with Matlab 7.0.4.365 (R14) Service Pack 2 !!</span>
    <span class="co1">%         for i=1:size(v,1)</span>
    <span class="co1">%             [vnames(i), vvals(i)]=strread(v{i},'%s%s',1,'delimiter', ': ');</span>
    <span class="co1">%         end</span>
<span class="kw1">else</span>
    vnames=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cell.html"><span class="kw2">cell</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>v<span class="br0">)</span>,1<span class="br0">)</span>;
    vvals=vnames;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>v<span class="br0">)</span>
        <span class="br0">[</span>vnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,b<span class="br0">]</span>= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strtok.html"><span class="kw2">strtok</span></a><span class="br0">(</span>v<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>, <span class="co2">': '</span><span class="br0">)</span>;
        vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>=b<span class="br0">(</span>3:<span class="kw1">end</span><span class="br0">)</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%% LevelNames</span>
LevelNames=vvals<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'LevelName'</span>, vnames<span class="br0">)</span><span class="br0">)</span>;
vvals<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'LevelName'</span>, vnames<span class="br0">)</span><span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
vnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'LevelName'</span>, vnames<span class="br0">)</span><span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">% Identical variable names across levels should be specified using []</span>
ilevels=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'Level'</span>, vnames, <span class="co2">'exact'</span><span class="br0">)</span>;
levels=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2num.html"><span class="kw2">str2num</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strvcat.html"><span class="kw2">strvcat</span></a><span class="br0">(</span>vvals<span class="br0">(</span>ilevels<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>;
vlevels=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>vnames<span class="br0">)</span>,1<span class="br0">)</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>ilevels<span class="br0">)</span>
    vlevels<span class="br0">(</span>ilevels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>:<span class="kw1">end</span><span class="br0">)</span>=levels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
<span class="kw1">end</span>
<span class="co1">% vvals(strmatch('Level', vnames))=[];</span>
<span class="co1">% vlevels(strmatch('Level', vnames))=[];</span>
<span class="co1">% vnames(strmatch('Level', vnames))=[];</span>
&nbsp;
&nbsp;
<span class="co1">% List of column headers</span>
<span class="br0">[</span>hnames,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">]</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>vnames<span class="br0">)</span>;
<span class="co1">%j(     strmatch('Level', hnames, 'exact'))=NaN;</span>
&nbsp;
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>hnames<span class="br0">)</span>
    <span class="kw1">if</span> ~isequal<span class="br0">(</span>hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,<span class="co2">'Level'</span><span class="br0">)</span>
        l=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/unique.html"><span class="kw2">unique</span></a><span class="br0">(</span>vlevels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
        l=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nonzeros.html"><span class="kw2">nonzeros</span></a><span class="br0">(</span>l<span class="br0">)</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>l<span class="br0">)</span>&gt;<span class="nu0">1</span>
            <span class="co1">%hnames(i)</span>
            <span class="kw1">for</span> k=2:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>l<span class="br0">)</span>
                hnames<span class="br0">{</span><span class="kw1">end</span>+1<span class="br0">}</span>=<span class="br0">[</span> hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> <span class="co2">'['</span> LevelNames<span class="br0">{</span>l<span class="br0">(</span>k<span class="br0">)</span><span class="br0">}</span> <span class="co2">']'</span><span class="br0">]</span>;
                vnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/intersect.html"><span class="kw2">intersect</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>vlevels==l<span class="br0">(</span>k<span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,vnames,<span class="co2">'exact'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>=hnames<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>;
            <span class="kw1">end</span>
            hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> = <span class="br0">[</span> hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span> <span class="co2">'['</span> LevelNames<span class="br0">{</span>l<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">}</span> <span class="co2">']'</span><span class="br0">]</span>;
            vnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/intersect.html"><span class="kw2">intersect</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>vlevels==l<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>hnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,vnames,<span class="co2">'exact'</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span>=hnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
hnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'Level'</span>, hnames, <span class="co2">'exact'</span><span class="br0">)</span><span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
hnames=<span class="br0">[</span>hnames ; LevelNames<span class="br0">(</span>2:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/max.html"><span class="kw2">max</span></a><span class="br0">(</span>levels<span class="br0">)</span><span class="br0">)</span> <span class="br0">]</span>;
<span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">]</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sort.html"><span class="kw2">sort</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>hnames<span class="br0">)</span><span class="br0">)</span>;
hnames=hnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>';
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> &lt;= <span class="nu0">1</span>
    <span class="co1">%returns headers only</span>
    <span class="co1">%     k=strmatch('Level',hnames, 'exact');</span>
    <span class="co1">%     hnames(k)=[];</span>
    <span class="co1">%     k=strmatch('LevelName',hnames, 'exact');</span>
    <span class="co1">%     hnames(k)=[];</span>
    k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'VersionPersist'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
    hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">%% Converts text to numerical values</span>
<span class="co1">% To tease apart numerical/text values, we create a new array containing</span>
<span class="co1">% mixed data types</span>
<span class="co1">% try</span>
<span class="co1">%     % With version &gt; 7.0</span>
<span class="co1">%     xvals=cellfun(str2func('str2num'), vvals, 'UniformOutput', 0);</span>
<span class="co1">%</span>
<span class="co1">%     %Where non numerical data were...</span>
<span class="co1">%     tvals=cellfun('isempty', xvals);</span>
<span class="co1">%     % We also need to check for a strange behavior of str2num</span>
<span class="co1">%     tvals=tvals | cellfun('length',xvals) &gt; 1;</span>
<span class="co1">%</span>
<span class="co1">%     % we put them back in the mixed type array xvals</span>
<span class="co1">%     xvals(tvals)=vvals(tvals);</span>
<span class="co1">% catch</span>
<span class="co1">%     xvals=cell(length(vvals),1);</span>
<span class="co1">%     tvals=logical(zeros(length(vvals),1));</span>
<span class="co1">%     for i=1:length(vvals)</span>
<span class="co1">%         xvals{i}=str2num(vvals{i});</span>
<span class="co1">%         if isempty(xvals{i}) &amp; ~isempty(vvals{i})</span>
<span class="co1">%             xvals{i}=vvals{i};</span>
<span class="co1">%             tvals(i)=1;</span>
<span class="co1">%         end</span>
<span class="co1">%     end</span>
<span class="co1">% end</span>
&nbsp;
nrows=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diff.html"><span class="kw2">diff</span></a><span class="br0">(</span>levels<span class="br0">)</span>==0<span class="br0">)</span>+<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sum.html"><span class="kw2">sum</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/diff.html"><span class="kw2">diff</span></a><span class="br0">(</span>levels<span class="br0">)</span>&gt;0<span class="br0">)</span>+<span class="nu0">1</span>;
nvars= <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>hnames<span class="br0">)</span>;
<span class="co1">%table of values</span>
tvals=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cell.html"><span class="kw2">cell</span></a><span class="br0">(</span>nrows,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>hnames<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
rowlevel=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>nrows,1<span class="br0">)</span>;
row=<span class="nu0">0</span>;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>levels<span class="br0">)</span>-1
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>==1 || levels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>&gt;=levels<span class="br0">(</span><span class="re0">i</span>-1<span class="br0">)</span>
        row=row<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>+<span class="nu0">1</span>;
    <span class="kw1">else</span>
        row=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span>rowlevel&gt;levels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    rowlevel<span class="br0">(</span>row<span class="br0">)</span>=levels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a>=ilevels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>+1:ilevels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>+<span class="nu0">1</span><span class="br0">)</span>-<span class="nu0">1</span>
        <span class="co1">% Fills with values for the corresponding level</span>
        k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>vnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'i'</span><span class="br0">)</span>
            v = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a>;
        <span class="kw1">else</span>
            v=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2double.html"><span class="kw2">str2double</span></a><span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">)</span>;
        <span class="kw1">end</span>
        <span class="kw1">if</span> isnan<span class="br0">(</span>v<span class="br0">)</span> &amp;&amp; ~isempty<span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">)</span>
            v=vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>;
        <span class="kw1">end</span>
        tvals<span class="br0">(</span>row,k<span class="br0">)</span>=<span class="br0">{</span>v<span class="br0">}</span>;
    <span class="kw1">end</span>
    k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>LevelNames<span class="br0">(</span>levels<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span><span class="br0">)</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
    <span class="kw1">if</span> row<span class="br0">(</span>1<span class="br0">)</span>&gt;1
        tvals<span class="br0">(</span>row,k<span class="br0">)</span>=<span class="br0">{</span>tvals<span class="br0">{</span>row<span class="br0">(</span>1<span class="br0">)</span>-1,k<span class="br0">}</span>+1<span class="br0">}</span>;
    <span class="kw1">else</span>
        tvals<span class="br0">(</span>row,k<span class="br0">)</span>=<span class="br0">{</span>1<span class="br0">}</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a>=ilevels<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span>+1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>vvals<span class="br0">)</span>
    <span class="co1">% Fills with values for the corresponding level</span>
    k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>vnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmp.html"><span class="kw2">strcmp</span></a><span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>,<span class="co2">'i'</span><span class="br0">)</span>
        v = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a>;
    <span class="kw1">else</span>
        v=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2double.html"><span class="kw2">str2double</span></a><span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    <span class="kw1">if</span> isnan<span class="br0">(</span>v<span class="br0">)</span> &amp;&amp; ~isempty<span class="br0">(</span>vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span><span class="br0">)</span>
        v=vvals<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">}</span>;
    <span class="kw1">end</span>
    tvals<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">{</span>v<span class="br0">}</span>;
<span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="co1">%% Converts to Number and Text arrays</span>
B = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cell.html"><span class="kw2">cell</span></a><span class="br0">(</span>nrows,nvars<span class="br0">)</span>;
B<span class="br0">(</span>:<span class="br0">)</span> = <span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;
vIsNaN = false<span class="br0">(</span>nrows,nvars<span class="br0">)</span>;
<span class="co1">% find non-numeric entries in data cell array</span>
vIsText = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellfun.html"><span class="kw2">cellfun</span></a><span class="br0">(</span><span class="co2">'isclass'</span>,tvals,<span class="co2">'char'</span><span class="br0">)</span>;
<span class="co1">% place text cells in text array</span>
<span class="co1">% then replace them with NaN</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>vIsText<span class="br0">(</span>:<span class="br0">)</span><span class="br0">)</span>
    vIsText=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>vIsText<span class="br0">)</span>;
    B<span class="br0">(</span>:,vIsText<span class="br0">)</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/deblank.html"><span class="kw2">deblank</span></a><span class="br0">(</span>tvals<span class="br0">(</span>:,vIsText<span class="br0">)</span><span class="br0">)</span>;
    <span class="co1">% Replace [] in char array...</span>
    B<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellfun.html"><span class="kw2">cellfun</span></a><span class="br0">(</span><span class="co2">'isempty'</span>,B<span class="br0">)</span><span class="br0">)</span>=<span class="br0">{</span><span class="co2">''</span><span class="br0">}</span>;
    tvals<span class="br0">(</span>:,vIsText<span class="br0">)</span>=<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a><span class="br0">}</span>;
<span class="kw1">end</span>
<span class="co1">% place NaN in empty numeric cells</span>
vIsNaN  = <span class="sy0">...</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellfun.html"><span class="kw2">cellfun</span></a><span class="br0">(</span><span class="co2">'isempty'</span>,tvals<span class="br0">)</span>|<span class="sy0">...</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cellfun.html"><span class="kw2">cellfun</span></a><span class="br0">(</span><span class="co2">'isclass'</span>,tvals,<span class="co2">'char'</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>vIsNaN<span class="br0">(</span>:<span class="br0">)</span><span class="br0">)</span>
    tvals<span class="br0">(</span>vIsNaN<span class="br0">)</span>=<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nan.html"><span class="kw2">NaN</span></a><span class="br0">}</span>;
<span class="kw1">end</span>
A = cell2mat<span class="br0">(</span>tvals<span class="br0">)</span>;
B=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/reshape.html"><span class="kw2">reshape</span></a><span class="br0">(</span>B,<span class="br0">[</span>nrows,nvars<span class="br0">]</span><span class="br0">)</span>;
&nbsp;
<span class="co1">%% Ouputs requested variables</span>
<span class="kw1">if</span> nargin&gt;1
    <span class="kw1">if</span> ~iscell<span class="br0">(</span>varnames<span class="br0">)</span>
        varnames=<span class="br0">{</span>varnames<span class="br0">}</span>;
    <span class="kw1">end</span>
    k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/zeros.html"><span class="kw2">zeros</span></a><span class="br0">(</span>1,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>varnames<span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>=1:<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>varnames<span class="br0">)</span>
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ismember.html"><span class="kw2">ismember</span></a><span class="br0">(</span>varnames<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>,hnames<span class="br0">)</span>
            k<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">)</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span>varnames<span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>,hnames,<span class="co2">'exact'</span><span class="br0">)</span>;
        <span class="kw1">else</span>
            <span class="co1">%k(i)=strmatch(varnames{i},hnames,'exact');</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>k==0<span class="br0">)</span>
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'Variable name not found'</span><span class="br0">)</span>;
    <span class="kw1">end</span>
    hnames=hnames<span class="br0">(</span>k<span class="br0">)</span>;
    A=A<span class="br0">(</span>:,k<span class="br0">)</span>;
    B=B<span class="br0">(</span>:,k<span class="br0">)</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">% add: Procedure[Block]	Procedure[Trial] Running[Block]	Running[Trial]</span>
k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'Level'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
A<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;B<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'LevelName'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
A<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;B<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'VersionPersist'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
A<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;B<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'Procedure'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
A<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;B<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
k=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strmatch.html"><span class="kw2">strmatch</span></a><span class="br0">(</span><span class="co2">'Running'</span>,hnames, <span class="co2">'exact'</span><span class="br0">)</span>;
A<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;B<span class="br0">(</span>:,k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;hnames<span class="br0">(</span>k<span class="br0">)</span>=<span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="kw1">return</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>tvals,rowlevel,varlevel<span class="br0">]</span>=filllevels<span class="br0">(</span>tvals,rowlevel,varlevel,curlevel,row,nlevels<span class="br0">)</span>
<span class="co1">% fill lower levels in the hierarchy</span>
<span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a>=nlevels:-1:curlevel
    k=<span class="br0">(</span>varlevel&lt;<span class="re0">j</span><span class="br0">)</span> &amp; varlevel&gt;<span class="nu0">0</span>;
    tvals<span class="br0">(</span>row-<span class="br0">[</span>0:rowlevel<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>-1<span class="br0">]</span>,k<span class="br0">)</span>=<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/repmat.html"><span class="kw2">repmat</span></a><span class="br0">(</span>tvals<span class="br0">(</span>row,k<span class="br0">)</span>,rowlevel<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">j.html"&gt;<span class="kw2"><span class="re0">j</span></span></a><span class="br0">)</span>,1<span class="br0">)</span>;
<span class="kw1">end</span>
varlevel<span class="br0">(</span>varlevel&gt;=curlevel<span class="br0">)</span>=<span class="nu0">0</span>;
rowlevel<span class="br0">(</span>curlevel:<span class="kw1">end</span><span class="br0">)</span>=<span class="nu0">0</span>;
<span class="kw1">return</span></pre>
</dd></dl>
</div>
</div>

<h3><a name="several_spm_versions" id="several_spm_versions">Several SPM Versions</a></h3>
<div class="level3">

<p>

In case you must use several SPM versions in the same MATLAB you'll have to change the path and <strong>clear the global variables</strong>.
For that purpose you can create a function that does all this (example 
from SPM2 to SPM5). Copy and paste this into your matlab-batches 
directory (name p_spm5) and edit the SPM path according to your PC:     
  

</p>
<p><a title="reveal" class="folder" href="#folded_25"> Change between SPM2 and SPM5</a></p><div class="folded hidden" id="folded_25">
<pre class="code matlab"><span class="kw1">function</span> p_spm5
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmpath.html"><span class="kw2">rmpath</span></a><span class="br0">(</span>genpath<span class="br0">(</span><span class="co2">'C:\SPM\spm2'</span><span class="br0">)</span><span class="br0">)</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/clear.html"><span class="kw2">clear</span></a> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/all.html"><span class="kw2">all</span></a> <span class="kw1">global</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/addpath.html"><span class="kw2">addpath</span></a><span class="br0">(</span>genpath<span class="br0">(</span><span class="co2">'C:\SPM\spm5'</span><span class="br0">)</span>,<span class="co2">'-begin'</span><span class="br0">)</span>
spm fmri</pre>
</div>
<p>
Loading the data contained in a MR volume in SPM (I always forget that)

</p>
<pre class="code matlab"><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/image.html"><span class="kw2">IMAGE</span></a>=spm_read_vols<span class="br0">(</span>spm_vol<span class="br0">(</span>spm_select<span class="br0">(</span><span class="co2">'List'</span>,your_file_directory,<span class="co2">'your_filename.img'</span><span class="br0">)</span><span class="br0">)</span></pre>

</div>

<h3><a name="matlab_figure_in_pdf" id="matlab_figure_in_pdf">Matlab figure in PDF</a></h3>
<div class="level3">
<p><a title="reveal" class="folder " href="#folded_26"> Save your Matlab figure as a PDF in exactly the present appearance and size (needs GHOSTSCRIPT installed)</a></p><div class="folded  hidden" id="folded_26">
<pre class="code matlab"><span class="kw1">function</span> myprintpdf<span class="br0">(</span>myname<span class="br0">)</span>  
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/print.html"><span class="kw2">print</span></a><span class="br0">(</span><span class="co2">'-depsc2'</span>,myname<span class="br0">)</span>; myfile=<span class="br0">[</span>myname <span class="co2">'.eps'</span><span class="br0">]</span>; eps2pdf<span class="br0">(</span>myfile<span class="br0">)</span>; <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a><span class="br0">(</span>myfile<span class="br0">)</span>;
<span class="kw1">return</span>
&nbsp;
<span class="co1">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
&nbsp;
<span class="kw1">function</span> <span class="br0">[</span>result,msg<span class="br0">]</span> = eps2pdf<span class="br0">(</span>epsFile,fullGsPath,orientation<span class="br0">)</span>
<span class="co1">%EPS2PDF Converts an eps file to a pdf file using GhostScript (GS)</span>
<span class="co1">%</span>
<span class="co1">%   [result,msg] = eps2pdf(epsFile,fullGsPath,orientation)</span>
<span class="co1">%</span>
<span class="co1">%   - epsFile:      eps file name to be converted to pdf file</span>
<span class="co1">%   - fullGsPath:   (optional) FULL GS path, including the file name, to</span>
<span class="co1">%                   the GS executable (on win32 it could be c:\program</span>
<span class="co1">%                   files\gs\gs8.14\bin\gswin32c.exe). The existence for</span>
<span class="co1">%                   fullGsPath will be checked for if given. On the other</span>
<span class="co1">%                   hand, if fullGsPath is not given or empty it defaults</span>
<span class="co1">%                   to 'gswin32c' for pcs and 'gs' for unix and the</span>
<span class="co1">%                   existence will not be checked for. But in this, latter</span>
<span class="co1">%                   case, GS's path must be in the system's path variable.</span>
<span class="co1">%   - orientation:  (optional) a flag that tells how the orientation tag in eps file should be treated</span>
<span class="co1">%                   just before the conversion (orientation tag is changed or even removed):</span>
<span class="co1">%                       0 -&gt; no change (default)</span>
<span class="co1">%                       1 -&gt; flip orientation</span>
<span class="co1">%                       2 -&gt; remove orientation</span>
<span class="co1">%   </span>
<span class="co1">%   - result:       0 if ok, anything else otherwise</span>
<span class="co1">%   - msg:          resulting status on file being processed</span>
<span class="co1">%</span>
<span class="co1">%   NOTES: GhostScript is needed for this function to work. Orientation can</span>
<span class="co1">%   also be changed - use this only if you have problems with the orientation - in</span>
<span class="co1">%   such a case try with orientation=1 first and then orientation=2 if the first option is</span>
<span class="co1">%   not the right one.</span>
<span class="co1">%</span>
<span class="co1">%   EPS2PDF converts an existing EPS file to a PDF file using Ghostscript. EPS2PDF</span>
<span class="co1">%   reads an eps file, modifies the bounding box and creates a pdf file whose size</span>
<span class="co1">%   is determined by the bounding box and not by the paper size. This can not be</span>
<span class="co1">%   accomplished by using Ghostscript only. So, all that one needs is of course</span>
<span class="co1">%   Matlab and Ghostscript drivers.</span>
<span class="co1">% </span>
<span class="co1">%   This tool is especially suited for LaTeX (TeX) users who want to create pdf</span>
<span class="co1">%   documents on the fly (by including pdf graphics and using either pdftex or</span>
<span class="co1">%   pdflatex). An example would be, if you are using LaTeX (TeX) to typeset</span>
<span class="co1">%   documents then the usual (simple) way to include graphics is to include eps</span>
<span class="co1">%   graphics using for example (if there exists myfigure.eps)</span>
<span class="co1">%   \begin{figure}</span>
<span class="co1">%       \centering</span>
<span class="co1">%       \includegraphics[scale=0.8]{myfigure}\\</span>
<span class="co1">%       \caption{some caption.}</span>
<span class="co1">%   \end{figure}</span>
<span class="co1">%   To use pdflatex (pdftex) you do not need to change anything but provide another</span>
<span class="co1">%   file myfigure.pdf in the same directory along with myfigure.eps. And this file,</span>
<span class="co1">%   of course, can be generated by EPS2PDF.</span>
<span class="co1">%</span>
<span class="co1">%   This function was tested on win32 system running Matlab R13sp1. It should work</span>
<span class="co1">%   on all platforms, if not, contact the author.</span>
<span class="co1">%</span>
<span class="co1">%   SOURCE:     The original idea came from the "eps-to-pdf" converter written in perl by Sebastian Rahtz</span>
<span class="co1">%</span>
<span class="co1">%   Primoz Cermelj, 24.08.2004</span>
<span class="co1">%   (c) Primoz Cermelj, primoz.cermelj@email.si</span>
<span class="co1">%</span>
<span class="co1">%   Version: 0.9.3</span>
<span class="co1">%   Last revision: 04.10.2004</span>
<span class="co1">%--------------------------------------------------------------------------</span>
<span class="kw1">global</span> epsFileContent
&nbsp;
<span class="kw1">if</span> ispc
    DEF_GS_PATH = <span class="co2">'gswin32c.exe'</span>;
<span class="kw1">else</span>
    DEF_GS_PATH = <span class="co2">'gs'</span>;
<span class="kw1">end</span>
GS_PARAMETERS = <span class="co2">'-q -dNOPAUSE -dBATCH -dDOINTERPOLATE -dUseFlateCompression=true -sDEVICE=pdfwrite -r1200'</span>;
&nbsp;
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargchk.html"><span class="kw2">nargchk</span></a><span class="br0">(</span>1,3,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 2 || isempty<span class="br0">(</span>fullGsPath<span class="br0">)</span>
    fullGsPath = DEF_GS_PATH;
<span class="kw1">else</span>
    <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>fullGsPath<span class="br0">)</span>
        status = <span class="br0">[</span><span class="co2">'Ghostscript executable could not be found: '</span> fullGsPath<span class="br0">]</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a>,      result = <span class="nu0">1</span>;    <span class="kw1">end</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> &gt; 1,  msg = status;  <span class="kw1">else</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span>status<span class="br0">)</span>;  <span class="kw1">end</span>;
        <span class="kw1">return</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 3 || isempty<span class="br0">(</span>orientation<span class="br0">)</span>
    orientation = <span class="nu0">0</span>;
<span class="kw1">end</span>
orientation = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/round.html"><span class="kw2">round</span></a><span class="br0">(</span>orientation<span class="br0">)</span><span class="br0">)</span>;
orientation = orientation<span class="br0">(</span>1<span class="br0">)</span>;
<span class="kw1">if</span> orientation &lt; 0 | orientation &gt; 2
    orientation = <span class="nu0">0</span>;
<span class="kw1">end</span>
&nbsp;
epsFileContent = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">%---------</span>
<span class="co1">% Get file name, path</span>
<span class="co1">%---------</span>
source = epsFile;
<span class="br0">[</span>pathstr,sourceName,ext<span class="br0">]</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>source<span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>pathstr<span class="br0">)</span>
    pathstr = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a>;
    source = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pathstr,source<span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
targetName = <span class="br0">[</span>sourceName <span class="co2">'.pdf'</span><span class="br0">]</span>;
target = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pathstr,targetName<span class="br0">)</span>;    <span class="co1">% target - pdf file</span>
&nbsp;
tmpFileName = sourceName;
tmpFile = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>pathstr,<span class="br0">[</span>tmpFileName ext <span class="co2">'.eps2pdf~'</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
&nbsp;
<span class="co1">% Create tmp file,...</span>
<span class="br0">[</span>ok,errStr<span class="br0">]</span> = create_tmpepsfile<span class="br0">(</span>source,tmpFile,orientation<span class="br0">)</span>;
<span class="kw1">if</span> ~ok
    status = <span class="br0">[</span><span class="co2">'Error while creating temporary eps file: '</span> epsFile <span class="co2">' - '</span> errStr<span class="br0">]</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a>,      result = <span class="nu0">1</span>;    <span class="kw1">end</span>;
    <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> &gt; 1,  msg = status;  <span class="kw1">else</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span>status<span class="br0">)</span>; <span class="kw1">end</span>;
<span class="kw1">else</span>
    <span class="co1">% Run Ghostscript</span>
    comandLine = <span class="br0">[</span><span class="co2">'"'</span> fullGsPath <span class="co2">'"'</span> <span class="co2">' '</span> GS_PARAMETERS <span class="co2">' -sOutputFile='</span> <span class="co2">'"'</span> target <span class="co2">'"'</span> <span class="co2">' -f '</span> <span class="co2">'"'</span> tmpFile <span class="co2">'"'</span><span class="br0">]</span>;
    <span class="br0">[</span>stat, result<span class="br0">]</span> = system<span class="br0">(</span>comandLine<span class="br0">)</span>;
    <span class="kw1">if</span> stat
        status = <span class="br0">[</span><span class="co2">'pdf file not created - error running Ghostscript - check GS path: '</span> result<span class="br0">]</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a>,      result = <span class="nu0">1</span>;    <span class="kw1">end</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> &gt; 1,  msg = status;  <span class="kw1">else</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span>status<span class="br0">)</span>;  <span class="kw1">end</span>;  
    <span class="kw1">else</span>
        status = <span class="co2">'pdf successfully created'</span>; 
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a>,      result = <span class="nu0">0</span>;    <span class="kw1">end</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargout.html"><span class="kw2">nargout</span></a> &gt; 1,  msg = status;  <span class="kw1">else</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span>status<span class="br0">)</span>;  <span class="kw1">end</span>; 
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Delete tmp file</span>
<span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>tmpFile<span class="br0">)</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a><span class="br0">(</span>tmpFile<span class="br0">)</span>;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%/////////////////////////////////////////////////////////////////////</span>
<span class="co1">%                       SUBFUNCTIONS SECTION</span>
<span class="co1">%/////////////////////////////////////////////////////////////////////</span>
&nbsp;
<span class="co1">%--------------------------------------------------------------------</span>
<span class="kw1">function</span> <span class="br0">[</span>ok,errStr<span class="br0">]</span> = create_tmpepsfile<span class="br0">(</span>epsFile,tmpFile,orientation<span class="br0">)</span>
<span class="co1">% Creates tmp eps file - file with refined content</span>
<span class="kw1">global</span> epsFileContent
&nbsp;
ok = <span class="nu0">0</span>;
errStr = <span class="br0">[</span><span class="br0">]</span>;
<span class="br0">[</span>ok,errStr<span class="br0">]</span> = read_epsfilecontent<span class="br0">(</span> epsFile <span class="br0">)</span>;
<span class="kw1">if</span> ~ok
    <span class="kw1">return</span>
<span class="kw1">end</span>
<span class="br0">[</span>ok,errStr<span class="br0">]</span> = update_epsfilecontent<span class="br0">(</span> epsFile,orientation <span class="br0">)</span>;
<span class="kw1">if</span> ~ok
    <span class="kw1">return</span>
<span class="kw1">end</span>
fh = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>tmpFile,<span class="co2">'w'</span><span class="br0">)</span>;
<span class="kw1">if</span> fh == -<span class="nu0">1</span>
    errStr = <span class="br0">[</span><span class="co2">'Temporary file cannot be created. Check write permissions.'</span><span class="br0">]</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
<span class="kw1">try</span>
    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fwrite.html"><span class="kw2">fwrite</span></a><span class="br0">(</span>fh,epsFileContent,<span class="co2">'char'</span><span class="br0">)</span>;  <span class="co1">% fwrite is faster than fprintf</span>
    ok = <span class="nu0">1</span>;
<span class="kw1">catch</span>
    errStr = <span class="br0">[</span><span class="co2">'Error writing temporary file. Check write permissions.'</span><span class="br0">]</span>;
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fh<span class="br0">)</span>;
<span class="co1">%--------------------------------------------------------------------</span>
&nbsp;
&nbsp;
<span class="co1">%--------------------------------------------------------------------</span>
<span class="kw1">function</span> <span class="br0">[</span>ok,errStr<span class="br0">]</span> = read_epsfilecontent<span class="br0">(</span> epsFile <span class="br0">)</span>
<span class="co1">% Reads the content of the eps file into epsFileContent</span>
<span class="kw1">global</span> epsFileContent
&nbsp;
ok = <span class="nu0">0</span>;
errStr = <span class="br0">[</span><span class="br0">]</span>;
fh = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>epsFile,<span class="co2">'r'</span><span class="br0">)</span>;
<span class="kw1">if</span> fh == -<span class="nu0">1</span>
    errStr = <span class="br0">[</span><span class="co2">'File: '</span> epsFile <span class="co2">' cannot be accessed or does not exist'</span><span class="br0">]</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
<span class="kw1">try</span>
    epsFileContent = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fread.html"><span class="kw2">fread</span></a><span class="br0">(</span>fh,<span class="co2">'char=&gt;char'</span><span class="br0">)</span>';       <span class="co1">% fread is faster than fscanf</span>
    ok = <span class="nu0">1</span>;
<span class="kw1">catch</span>
    errStr = lasterror;
<span class="kw1">end</span>
<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>fh<span class="br0">)</span>;
<span class="co1">%--------------------------------------------------------------------</span>
&nbsp;
&nbsp;
<span class="co1">%--------------------------------------------------------------------</span>
<span class="kw1">function</span> <span class="br0">[</span>ok,errStr<span class="br0">]</span> = update_epsfilecontent<span class="br0">(</span>epsFile,orientation<span class="br0">)</span>
<span class="co1">% Updates eps file by adding some additional information into the header</span>
<span class="co1">% section concerning the bounding box (BB)</span>
<span class="kw1">global</span> epsFileContent
&nbsp;
ok = <span class="nu0">0</span>;
errStr = <span class="br0">[</span><span class="br0">]</span>;
&nbsp;
<span class="co1">% Read current BB coordinates</span>
ind = strfind<span class="br0">(</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>epsFileContent<span class="br0">)</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span><span class="co2">'%%BoundingBox:'</span><span class="br0">)</span><span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>ind<span class="br0">)</span>
    errStr = <span class="br0">[</span><span class="co2">'Cannot find Bounding Box in file: '</span> epsFile<span class="br0">]</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
ii = ind<span class="br0">(</span>1<span class="br0">)</span> + <span class="nu0">14</span>;
fromBB = ii;
<span class="kw1">while</span> ~<span class="br0">(</span><span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span><span class="br0">)</span> | <span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\r'</span><span class="br0">)</span><span class="br0">)</span> | <span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <span class="co2">'%'</span><span class="br0">)</span><span class="br0">)</span>
    ii = ii + <span class="nu0">1</span>;
<span class="kw1">end</span>
toBB = ii - <span class="nu0">1</span>;
coordsStr = epsFileContent<span class="br0">(</span>fromBB:toBB<span class="br0">)</span>;
coords = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2num.html"><span class="kw2">str2num</span></a><span class="br0">(</span> coordsStr <span class="br0">)</span>;
<span class="kw1">if</span> isempty<span class="br0">(</span>coords<span class="br0">)</span>
    errStr = <span class="br0">[</span><span class="co2">'Error reading BB coordinates from file: '</span> epsFile<span class="br0">]</span>;
    <span class="kw1">return</span>
<span class="kw1">end</span>
NL = getnl;
w = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span>coords<span class="br0">(</span>3<span class="br0">)</span>-coords<span class="br0">(</span>1<span class="br0">)</span><span class="br0">)</span>;
h = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/abs.html"><span class="kw2">abs</span></a><span class="br0">(</span>coords<span class="br0">(</span>4<span class="br0">)</span>-coords<span class="br0">(</span>2<span class="br0">)</span><span class="br0">)</span>;
&nbsp;
<span class="co1">% Change the orientation if requested</span>
changeOrientation = <span class="nu0">0</span>;
<span class="kw1">if</span> orientation ~= 0
    ind = strfind<span class="br0">(</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>epsFileContent<span class="br0">)</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span><span class="co2">'%%Orientation:'</span><span class="br0">)</span><span class="br0">)</span>;
    <span class="kw1">if</span> ~isempty<span class="br0">(</span>ind<span class="br0">)</span>
        ii = ind<span class="br0">(</span>1<span class="br0">)</span> + <span class="nu0">14</span>;
        fromOR = ii;
        <span class="kw1">while</span> ~<span class="br0">(</span><span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span><span class="br0">)</span> | <span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\r'</span><span class="br0">)</span><span class="br0">)</span> | <span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span> == <span class="co2">'%'</span><span class="br0">)</span><span class="br0">)</span>
            ii = ii + <span class="nu0">1</span>;
        <span class="kw1">end</span>
        toOR = ii - <span class="nu0">1</span>;
        orientStr = strim<span class="br0">(</span>epsFileContent<span class="br0">(</span>fromOR:toOR<span class="br0">)</span><span class="br0">)</span>;
        <span class="kw1">if</span> ~isempty<span class="br0">(</span>orientStr<span class="br0">)</span> &amp; orientation == <span class="nu0">1</span>           <span class="co1">% flip</span>
            <span class="kw1">if</span> strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>orientStr<span class="br0">)</span>,<span class="co2">'landscape'</span><span class="br0">)</span>
                changeOrientation = <span class="nu0">1</span>;
                orientStr = <span class="co2">'Portrait'</span>;
            <span class="kw1">elseif</span> strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>orientStr<span class="br0">)</span>,<span class="co2">'portrait'</span><span class="br0">)</span>
                changeOrientation = <span class="nu0">1</span>;
                orientStr = <span class="co2">'Landscape'</span>;                
            <span class="kw1">end</span>            
        <span class="kw1">elseif</span>  ~isempty<span class="br0">(</span>orientStr<span class="br0">)</span> &amp; orientation == <span class="nu0">2</span>      <span class="co1">% remove</span>
            <span class="kw1">if</span> strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>orientStr<span class="br0">)</span>,<span class="co2">'landscape'</span><span class="br0">)</span> | strfind<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>orientStr<span class="br0">)</span>,<span class="co2">'portrait'</span><span class="br0">)</span>
                changeOrientation = <span class="nu0">1</span>;
                orientStr = <span class="co2">' '</span>;
            <span class="kw1">end</span>
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">% Refine the content - add additional information and even change the</span>
<span class="co1">% orientation</span>
addBBContent = <span class="br0">[</span><span class="co2">' 0 0 '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>w<span class="br0">)</span> <span class="co2">' '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>h<span class="br0">)</span> <span class="co2">' '</span> NL<span class="sy0">...</span>
                    <span class="co2">'&lt;&lt; /PageSize ['</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>w<span class="br0">)</span> <span class="co2">' '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>h<span class="br0">)</span> <span class="co2">'] &gt;&gt; setpagedevice'</span> NL<span class="sy0">...</span>
                    <span class="co2">'gsave '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>-coords<span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">' '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/int2str.html"><span class="kw2">int2str</span></a><span class="br0">(</span>-coords<span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="br0">)</span> <span class="co2">' translate'</span><span class="br0">]</span>;
<span class="kw1">if</span> changeOrientation
    <span class="kw1">if</span> fromOR &gt; fromBB
        epsFileContent = <span class="br0">[</span>epsFileContent<span class="br0">(</span>1:fromBB-1<span class="br0">)</span> addBBContent epsFileContent<span class="br0">(</span>toBB+1:fromOR-1<span class="br0">)</span> orientStr epsFileContent<span class="br0">(</span>toOR+1:<span class="kw1">end</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">else</span>
        epsFileContent = <span class="br0">[</span>epsFileContent<span class="br0">(</span>1:fromOR-1<span class="br0">)</span> orientStr epsFileContent<span class="br0">(</span>toOR+1:fromBB-1<span class="br0">)</span> addBBContent epsFileContent<span class="br0">(</span>toBB+1:<span class="kw1">end</span><span class="br0">)</span><span class="br0">]</span>;
    <span class="kw1">end</span>
<span class="kw1">else</span>
    epsFileContent = <span class="br0">[</span>epsFileContent<span class="br0">(</span>1:fromBB-1<span class="br0">)</span> addBBContent  epsFileContent<span class="br0">(</span>toBB+1:<span class="kw1">end</span><span class="br0">)</span><span class="br0">]</span>;
<span class="kw1">end</span>
&nbsp;
ok = <span class="nu0">1</span>;
<span class="co1">%--------------------------------------------------------------------</span>
&nbsp;
<span class="co1">%--------------------------------------------------------------------</span>
<span class="kw1">function</span> NL = getnl
<span class="co1">% Returns new-line string as found from first occurance from epsFileContent</span>
<span class="kw1">global</span> epsFileContent
&nbsp;
NL = <span class="co2">'\r\n'</span>;        <span class="co1">% default (for Windows systems)</span>
ii = <span class="nu0">1</span>;
len = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span>epsFileContent<span class="br0">)</span>;
<span class="kw1">while</span> ~<span class="br0">(</span>epsFileContent<span class="br0">(</span>ii<span class="br0">)</span>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span> | epsFileContent<span class="br0">(</span>ii<span class="br0">)</span>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\r'</span><span class="br0">)</span> | ii&lt;len<span class="br0">)</span>
    ii = ii + <span class="nu0">1</span>;
<span class="kw1">end</span>
<span class="kw1">if</span> epsFileContent<span class="br0">(</span>ii<span class="br0">)</span>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span>
    NL = <span class="co2">'\n'</span>;
<span class="kw1">elseif</span> epsFileContent<span class="br0">(</span>ii<span class="br0">)</span>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\r'</span><span class="br0">)</span>
    NL = <span class="co2">'\r'</span>;
    <span class="kw1">if</span> epsFileContent<span class="br0">(</span>ii+1<span class="br0">)</span>==<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span><span class="co2">'\n'</span><span class="br0">)</span>
        NL = <span class="br0">[</span>NL <span class="co2">'\n'</span><span class="br0">]</span>;
    <span class="kw1">end</span>
<span class="kw1">end</span>
NL = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/sprintf.html"><span class="kw2">sprintf</span></a><span class="br0">(</span>NL<span class="br0">)</span>;
<span class="co1">%--------------------------------------------------------------------</span>
&nbsp;
&nbsp;
<span class="co1">%--------------------------------------------------------------------</span>
<span class="kw1">function</span> outstr = strim<span class="br0">(</span>str<span class="br0">)</span>
<span class="co1">% Removes leading and trailing spaces (spaces, tabs, endlines,...)</span>
<span class="co1">% from the str string.</span>
<span class="kw1">if</span> isnumeric<span class="br0">(</span>str<span class="br0">)</span>;
    outstr = str;
    <span class="kw1">return</span>
<span class="kw1">end</span>
ind = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/find.html"><span class="kw2">find</span></a><span class="br0">(</span> ~isspace<span class="br0">(</span>str<span class="br0">)</span> <span class="br0">)</span>;        <span class="co1">% indices of the non-space characters in the str    </span>
<span class="kw1">if</span> isempty<span class="br0">(</span>ind<span class="br0">)</span>
    outstr = <span class="br0">[</span><span class="br0">]</span>;        
<span class="kw1">else</span>
    outstr = str<span class="br0">(</span> ind<span class="br0">(</span>1<span class="br0">)</span>:ind<span class="br0">(</span><span class="kw1">end</span><span class="br0">)</span> <span class="br0">)</span>;
<span class="kw1">end</span>
<span class="co1">%--------------------------------------------------------------------</span></pre>
</div>
<p>
Here a handy function to convert PS files to <acronym title="Portable Document Format">PDF</acronym> (found <a href="http://www.mathworks.com/matlabcentral/fileexchange/19516" class="urlextern" title="http://www.mathworks.com/matlabcentral/fileexchange/19516" rel="nofollow">here</a>).
 
You can use it for example to convert the PS files created by SPM during
 preprocessing to verify realignment, normalisation, etc. Works straight
 out of the box in Matlab.
</p>
<p><a title="hide" class="folder open" href="#folded_27"> ps2pdf.m</a></p><div class="folded " id="folded_27">
<dl class="file">
<dt><a href="http://labnic.unige.ch/wiki/doku.php?do=export_code&amp;id=references:batches_spm8&amp;codeblock=27" title="Download Snippet" class="mediafile mf_m">ps2pdf.m</a></dt>
<dd><pre class="code file matlab"><span class="kw1">function</span> ps2pdf<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span>
<span class="co1">%PS2PDF Function to convert a PostScript file to PDF using Ghostscript</span>
<span class="co1">%</span>
<span class="co1">%  Converts a postscript file into PDF. The resulting PDF file will contain</span>
<span class="co1">%  one page for each page defined in the postscript files, so a multi-page</span>
<span class="co1">%  postscript file, like those generated by using the '-append' option of </span>
<span class="co1">%  MATLAB's print command, can be used to generate a multi-page PDF file. </span>
<span class="co1">%</span>
<span class="co1">%   Ghostscript is a third-party application currently supplied with </span>
<span class="co1">%   MATLAB. The caller may also specify a different version of Ghostscript</span>
<span class="co1">%   to use.</span>
<span class="co1">%</span>
<span class="co1">%   PS2PDF expects to be called with a set of parameter-value pairs. The</span>
<span class="co1">%   order of these is unimportant, but required parameters MUST be</span>
<span class="co1">%   specified</span>
<span class="co1">%</span>
<span class="co1">%   In the list below, required parameters are marked with an asterisk *</span>
<span class="co1">%   Parameter:        Value:  </span>
<span class="co1">%   *  psfile         full or relative path to the postscript file to convert</span>
<span class="co1">%</span>
<span class="co1">%   *  pdffile        full or relative path to the pdf file to create</span>
<span class="co1">%</span>
<span class="co1">%      gscommand      path to Ghostscript executable to use; this will try</span>
<span class="co1">%                     to default to the version of Ghostscript shipped with </span>
<span class="co1">%                     MATLAB, if any. If this value is specified you should </span>
<span class="co1">%                     also specify the gsfontpath and gslibpath values.</span>
<span class="co1">%</span>
<span class="co1">%      gsfontpath     full path to the Ghostscript font files</span>
<span class="co1">%                     If a gscommand is specified then this path should</span>
<span class="co1">%                     also be specified and reference the same Ghostscript</span>
<span class="co1">%                     version</span>
<span class="co1">%</span>
<span class="co1">%                     If gscommand is NOT specified and we can determine</span>
<span class="co1">%                     the version of Ghostscript, if any, shipped with</span>
<span class="co1">%                     MATLAB, then this value will be overridden to use the</span>
<span class="co1">%                     path that references MATLAB's version of Ghostscript</span>
<span class="co1">%</span>
<span class="co1">%      gslibpath      full path to the Ghostscript library (.ps) files. </span>
<span class="co1">%                     If a gscommand is specified then this path should</span>
<span class="co1">%                     also be specified and reference the same Ghostscript</span>
<span class="co1">%                     version</span>
<span class="co1">%</span>
<span class="co1">%                     If gscommand is NOT specified and we can determine</span>
<span class="co1">%                     the version of Ghostscript, if any, shipped with</span>
<span class="co1">%                     MATLAB, then this value will be overridden to use the</span>
<span class="co1">%                     path that references MATLAB's version of Ghostscript</span>
<span class="co1">%</span>
<span class="co1">%      gspapersize    paper size to use in the created .pdf file. If not </span>
<span class="co1">%                     specified or the specified value is not recognized </span>
<span class="co1">%                     it will use whatever default paper size is </span>
<span class="co1">%                     built into the version of Ghostscript being run</span>
<span class="co1">%</span>
<span class="co1">%                         NOTE: no scaling of the input occurs - it's simply</span>
<span class="co1">%                         placed on a page with the specified paper size. </span>
<span class="co1">%</span>
<span class="co1">%                         Valid values for gspapersize are: </span>
<span class="co1">%                              'letter', 'ledger', 'legal', '11x17', </span>
<span class="co1">%                              'archA', 'archB', 'archC', 'archD', 'archE', </span>
<span class="co1">%                              'a0', 'a1', 'a2', 'a3','a4', 'a5',</span>
<span class="co1">%                              'a6', 'a7', 'a8', 'a9', 'a10'</span>
<span class="co1">%                         </span>
<span class="co1">%      deletepsfile   0 to keep the input ps file after creating pdf</span>
<span class="co1">%                     non-zero to delete the input ps file after creating pdf</span>
<span class="co1">%                     Default is 0: keep the input ps file (do NOT delete it)</span>
<span class="co1">%                        NOTE: if the pdf creation process fails, the input</span>
<span class="co1">%                        PS file will be kept regardless of this setting</span>
<span class="co1">%</span>
<span class="co1">%      verbose        0 to suppress display of status/progress info; </span>
<span class="co1">%                     non-zero to allow display of status/progress info</span>
<span class="co1">%                     Default is 0 (no display)</span>
<span class="co1">%</span>
<span class="co1">% Example usage: </span>
<span class="co1">%    use MATLAB's version of Ghostscript to generate an A4 pdf file</span>
<span class="co1">%      ps2pdf('psfile', 'input.ps', 'pdffile', 'output.pdf', 'gspapersize', 'a4')</span>
<span class="co1">%</span>
<span class="co1">%    use a local copy of Ghostcript to generate a file, and display some </span>
<span class="co1">%    status/progress info while doing so.</span>
<span class="co1">%      ps2pdf('psfile', '../reports/input.ps', 'pdffile', 'c:\temp\output3.pdf', ...</span>
<span class="co1">%            'gspapersize', 'a4', 'verbose', 1, ...)</span>
<span class="co1">%            'gscommand', 'C:\Program Files\GhostScript\bin\gswin32c.exe', ...</span>
<span class="co1">%            'gsfontpath', 'C:\Program Files\GhostScript\fonts', ...</span>
<span class="co1">%            'gslibpath', 'C:\Program Files\GhostScript\lib')</span>
<span class="co1">%</span>
<span class="co1">%    use MATLAB's version of Ghostscript to generate a pdf file and delete</span>
<span class="co1">%    the input.ps file when done </span>
<span class="co1">%      ps2pdf('psfile', 'input.ps', 'pdffile', 'output.pdf', 'gspapersize', 'a4', 'deletepsfile', 1)</span>
&nbsp;
<span class="co1">%   Update log: </span>
<span class="co1">%      Aug 15, 2008: fixed bug where embedded space in location of </span>
<span class="co1">%                    MATLAB's version of Ghostscript caused ps2pdf to fail.</span>
<span class="co1">%      Apr 16, 2008: added deletepsfile option</span>
&nbsp;
<span class="co1">%   Copyright 2008 The MathWorks, Inc.</span>
&nbsp;
   <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/nargin.html"><span class="kw2">nargin</span></a> &lt; 1 
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:parameters'</span>, <span class="co2">'No parameters specified. Type '</span><span class="co2">'help ps2pdf'</span><span class="co2">' for details on how to use this function.'</span><span class="br0">)</span>;
   <span class="kw1">end</span>
&nbsp;
   <span class="co1">% parse input args</span>
   gsData = LocalParseArgs<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span>:<span class="br0">}</span><span class="br0">)</span>;
&nbsp;
   <span class="co1">% setup the file that tells GS what we want it to do</span>
   gsData = LocalCreateResponseFile<span class="br0">(</span>gsData<span class="br0">)</span>; 
&nbsp;
   gsDebug = <span class="nu0">0</span>;
   <span class="kw1">if</span> gsData.<span class="me1">verbose</span> 
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'ps2pdf: input settings are:\n'</span><span class="br0">)</span>;
      <span class="kw1">if</span> isfield<span class="br0">(</span>gsData, <span class="co2">'paperSizes'</span><span class="br0">)</span>
          gsData = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/rmfield.html"><span class="kw2">rmfield</span></a><span class="br0">(</span>gsData, <span class="co2">'paperSizes'</span><span class="br0">)</span>;
      <span class="kw1">end</span>
      gsData  <span class="co1">%#ok&lt;NOPRT&gt;</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span><span class="co2">'ps2pdf: response file for Ghostscript is:\n'</span><span class="br0">)</span>;
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/type.html"><span class="kw2">type</span></a><span class="br0">(</span>gsData.<span class="me1">responseFile</span><span class="br0">)</span>;
      gsDebug = <span class="nu0">1</span>;
   <span class="kw1">end</span>
&nbsp;
   <span class="co1">%to hold results/status from system call</span>
   s = <span class="nu0">0</span>; <span class="co1">%#ok&lt;NASGU&gt;</span>
   r = <span class="co2">''</span>; <span class="co1">%#ok&lt;NASGU&gt;</span>
&nbsp;
   <span class="co1">% run Ghostscript to convert the file</span>
   <span class="kw1">if</span> gsData.<span class="me1">useBuiltin</span> 
      <span class="br0">[</span>s, r<span class="br0">]</span> = gsData.<span class="me1">cmd</span><span class="br0">(</span><span class="br0">[</span><span class="co2">'@'</span> gsData.<span class="me1">responseFile</span><span class="br0">]</span>, gsData.<span class="me1">psFile</span>, gsDebug<span class="br0">)</span>;
   <span class="kw1">else</span> 
      <span class="br0">[</span>s, r<span class="br0">]</span> = system<span class="br0">(</span><span class="br0">[</span>gsData.<span class="me1">cmd</span> <span class="co2">' @'</span> gsData.<span class="me1">responseFile</span> <span class="co2">' '</span> gsData.<span class="me1">psFile</span><span class="br0">]</span><span class="br0">)</span>;
   <span class="kw1">end</span>
&nbsp;
   <span class="kw1">if</span> gsData.<span class="me1">verbose</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span> <span class="br0">[</span><span class="co2">'Ghostscript STDOUT: '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>s<span class="br0">)</span> <span class="br0">]</span> <span class="br0">)</span>;
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/disp.html"><span class="kw2">disp</span></a><span class="br0">(</span> <span class="br0">[</span><span class="co2">'Ghostscript STDERR: '</span> r <span class="br0">]</span> <span class="br0">)</span>;
   <span class="kw1">else</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a><span class="br0">(</span>gsData.<span class="me1">responseFile</span><span class="br0">)</span>
   <span class="kw1">end</span>
&nbsp;
   <span class="kw1">if</span> s &amp;&amp; ~isempty<span class="br0">(</span>r<span class="br0">)</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscript'</span>,  <span class="br0">[</span><span class="co2">'Problem converting PostScript. System returned error: '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>s<span class="br0">)</span> <span class="co2">'.'</span> r<span class="br0">]</span><span class="br0">)</span> 
   <span class="kw1">elseif</span> s
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscript'</span>,  <span class="br0">[</span><span class="co2">'Problem calling GhostScript. System returned error: '</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>s<span class="br0">)</span><span class="br0">]</span><span class="br0">)</span> 
   <span class="kw1">end</span>
&nbsp;
   <span class="co1">%if after all this we still couldn't create the file, report the error</span>
   fid = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span> gsData.<span class="me1">pdfFile</span>, <span class="co2">'r'</span><span class="br0">)</span>;
   <span class="kw1">if</span> <span class="br0">(</span> fid == -1 <span class="br0">)</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscript'</span>, <span class="co2">'%s'</span>, <span class="br0">[</span> <span class="co2">'Ghostscript could not create '</span><span class="co2">''</span> gsData.<span class="me1">pfdFile</span> <span class="co2">''</span><span class="co2">'.'</span> <span class="br0">]</span><span class="br0">)</span>
   <span class="kw1">else</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span> fid <span class="br0">)</span>;
   <span class="kw1">end</span>
&nbsp;
   <span class="co1">% if we get here, we successfully created pdf file; delete ps file if</span>
   <span class="co1">% requested to do so</span>
   <span class="kw1">if</span> gsData.<span class="me1">deletePSFile</span> 
       <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a><span class="br0">(</span>gsData.<span class="me1">psFile</span><span class="br0">)</span>;
   <span class="kw1">end</span>
&nbsp;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%local function to parse arguments and fill in the gsData structure</span>
<span class="co1">%  .psFile - postscript file to convert</span>
<span class="co1">%  .pdfFile - pdf file to create</span>
<span class="co1">%  .cmd     - path/name of Ghostscript command to run or handle to gscript</span>
<span class="co1">%             builtin</span>
<span class="co1">%  .useBuiltin - 1 if using builtin gs command </span>
<span class="co1">%  .fontPath - path to the Ghostscript fonts, if any</span>
<span class="co1">%  .libPath - path to the Ghostscript libs (Ghostscript .ps files), if any) </span>
<span class="co1">%  .paperSize - paper size to set for resulting .pdf file </span>
<span class="co1">%  .deletePSFile - 0 to keep (not delete) the input ps file if pdf created ok</span>
<span class="co1">%  .verbose - if non-zero, display some status/progress info to command window</span>
<span class="kw1">function</span> gsData = LocalParseArgs<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span> 
    gsData.<span class="me1">paperSizes</span> = <span class="br0">{</span><span class="co2">'letter'</span>, <span class="co2">'ledger'</span>, <span class="co2">'legal'</span>, <span class="co2">'11x17'</span>, <span class="co2">'archA'</span>, <span class="co2">'archB'</span>, <span class="sy0">...</span> 
                   <span class="co2">'archC'</span>, <span class="co2">'archD'</span>, <span class="co2">'archE'</span>, <span class="co2">'a0'</span>, <span class="co2">'a1'</span>, <span class="co2">'a2'</span>, <span class="co2">'a3'</span>,<span class="co2">'a4'</span>, <span class="co2">'a5'</span>, <span class="sy0">...</span>
                   <span class="co2">'a6'</span>, <span class="co2">'a7'</span>, <span class="co2">'a8'</span>, <span class="co2">'a9'</span>, <span class="co2">'a10'</span><span class="br0">}</span>;
&nbsp;
    <span class="co1">%default values for some settings</span>
    gsData.<span class="me1">verbose</span>      = <span class="nu0">0</span>; 
    gsData.<span class="me1">useBuiltin</span>   = <span class="nu0">0</span>;
    gsData.<span class="me1">deletePSFile</span> = <span class="nu0">0</span>; 
&nbsp;
    <span class="kw1">for</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a> = 1 : 2 : <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/length.html"><span class="kw2">length</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">)</span>-1 
        param_arg = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a><span class="br0">}</span>;
        param_value = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/varargin.html"><span class="kw2">varargin</span></a><span class="br0">{</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/%3Cspan%20class=" re0"="">i.html"&gt;<span class="kw2"><span class="re0">i</span></span></a>+1<span class="br0">}</span>;        
        <span class="kw1">switch</span><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span>param_arg<span class="br0">)</span><span class="br0">)</span> 
            <span class="co1">% path to ps file to conver</span>
            <span class="kw1">case</span> <span class="co2">'psfile'</span>
               <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>param_value, <span class="co2">'file'</span><span class="br0">)</span>
                  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'print:ghostscript'</span>, <span class="sy0">...</span>
                      <span class="co2">'Can not find postscript file &lt;%s&gt; to convert'</span>, <span class="sy0">...</span>
                      <span class="me1">param_value</span><span class="br0">)</span>
               <span class="kw1">end</span>
               gsData.<span class="me1">psFile</span> = param_value;
&nbsp;
            <span class="co1">% path to pdf file to create</span>
            <span class="kw1">case</span> <span class="co2">'pdffile'</span>
                <span class="co1">%verify we can create file at that location</span>
                pdf_fid = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a><span class="br0">(</span>param_value,<span class="co2">'w'</span><span class="br0">)</span>;
                <span class="kw1">if</span> pdf_fid &lt; 0 
                    <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:invalidPDFFIle'</span>, <span class="sy0">...</span> 
                        <span class="co2">'Can not open &lt;%s&gt; for writing'</span>, <span class="sy0">...</span>
                        <span class="me1">param_value</span><span class="br0">)</span>;
                <span class="kw1">end</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>pdf_fid<span class="br0">)</span>; 
                <span class="co1">%delete temp file we created</span>
                <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/delete.html"><span class="kw2">delete</span></a><span class="br0">(</span>param_value<span class="br0">)</span>; 
                gsData.<span class="me1">pdfFile</span> = param_value;
&nbsp;
            <span class="co1">% full path to gs executable</span>
            <span class="kw1">case</span> <span class="co2">'gscommand'</span> 
               <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>param_value, <span class="co2">'file'</span><span class="br0">)</span>
                  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptCommand'</span>, <span class="sy0">...</span>
                      <span class="co2">'Can not find Ghostscript executable ('</span><span class="co2">'gscommand'</span><span class="co2">') &lt;%s&gt;'</span>,<span class="sy0">...</span>
                      <span class="me1">param_value</span><span class="br0">)</span>
               <span class="kw1">end</span>
               <span class="kw1">if</span> ispc &amp;&amp; ~isempty<span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/findstr.html"><span class="kw2">findstr</span></a><span class="br0">(</span>param_value, <span class="co2">' '</span><span class="br0">)</span><span class="br0">)</span>
                   param_value = <span class="br0">[</span><span class="co2">'"'</span> param_value <span class="co2">'"'</span><span class="br0">]</span>; <span class="co1">%#ok&lt;AGROW&gt;</span>
               <span class="kw1">end</span>
               gsData.<span class="me1">cmd</span> = param_value; 
&nbsp;
            <span class="co1">% full path to gs font dir</span>
            <span class="kw1">case</span> <span class="co2">'gsfontpath'</span> 
               <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>param_value, <span class="co2">'dir'</span><span class="br0">)</span>
                   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptFontPath'</span>, <span class="sy0">...</span>
                         <span class="co2">'Can not find the directory &lt;%s&gt; for Ghostscript fonts ('</span><span class="co2">'gsfontpath'</span><span class="co2">')'</span>, <span class="sy0">...</span>
                         <span class="me1">param_value</span><span class="br0">)</span>
               <span class="kw1">end</span>
               gsData.<span class="me1">fontPath</span> = param_value;
&nbsp;
            <span class="co1">% full path to gs lib dir</span>
            <span class="kw1">case</span> <span class="co2">'gslibpath'</span> 
               <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>param_value, <span class="co2">'dir'</span><span class="br0">)</span>
                   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptLibPath'</span>, <span class="sy0">...</span>
                         <span class="co2">'Can not find the directory &lt;%s&gt; for Ghostscript library files ('</span><span class="co2">'gslibpath'</span><span class="co2">')'</span>, <span class="sy0">...</span>
                         <span class="me1">param_value</span><span class="br0">)</span>
               <span class="kw1">end</span>
               gsData.<span class="me1">libPath</span> = param_value;
&nbsp;
            <span class="co1">% paper size </span>
            <span class="kw1">case</span> <span class="co2">'gspapersize'</span>
               idx = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/strcmpi.html"><span class="kw2">strcmpi</span></a><span class="br0">(</span>param_value, gsData.<span class="me1">paperSizes</span><span class="br0">)</span>;
               <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/any.html"><span class="kw2">any</span></a><span class="br0">(</span>idx<span class="br0">)</span>
                  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:papersize'</span>, <span class="sy0">...</span>
                        <span class="co2">''</span><span class="co2">'gspapersize'</span><span class="co2">' value &lt;%s&gt; not found in the list of known sizes, ignoring it.'</span>, param_value<span class="br0">)</span>;
               <span class="kw1">else</span>
                  gsData.<span class="me1">paperSize</span> = gsData.<span class="me1">paperSizes</span><span class="br0">{</span>idx<span class="br0">}</span>;
               <span class="kw1">end</span>
&nbsp;
            <span class="co1">% deletePSFile</span>
            <span class="kw1">case</span> <span class="co2">'deletepsfile'</span>
               <span class="kw1">if</span> isnumeric<span class="br0">(</span>param_value<span class="br0">)</span> 
                  gsData.<span class="me1">deletePSFile</span> = param_value; 
               <span class="kw1">else</span>
                   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:deletepsfile'</span>, <span class="sy0">...</span>
                         <span class="co2">''</span><span class="co2">'deletepsfile'</span><span class="co2">' value &lt;%s&gt; class &lt;%s&gt; should be numeric, defaulting to 0'</span>, <span class="sy0">...</span>
                         <span class="me1">param_value</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/class.html"><span class="kw2">class</span></a><span class="br0">(</span>param_value<span class="br0">)</span><span class="br0">)</span>;
               <span class="kw1">end</span>
&nbsp;
            <span class="co1">% verbose</span>
            <span class="kw1">case</span> <span class="co2">'verbose'</span>
               <span class="kw1">if</span> isnumeric<span class="br0">(</span>param_value<span class="br0">)</span> 
                  gsData.<span class="me1">verbose</span> = param_value; 
               <span class="kw1">else</span>
                   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:verbose'</span>, <span class="sy0">...</span>
                         <span class="co2">''</span><span class="co2">'verbose'</span><span class="co2">' value &lt;%s&gt; class &lt;%s&gt; should be numeric, defaulting to 0'</span>, <span class="sy0">...</span>
                         <span class="me1">param_value</span>, <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/class.html"><span class="kw2">class</span></a><span class="br0">(</span>param_value<span class="br0">)</span><span class="br0">)</span>;
               <span class="kw1">end</span>
&nbsp;
            <span class="kw1">otherwise</span>
               <span class="kw1">if</span> isnumeric<span class="br0">(</span>param_value<span class="br0">)</span>
                   param_value = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/num2str.html"><span class="kw2">num2str</span></a><span class="br0">(</span>param_value<span class="br0">)</span>;
               <span class="kw1">end</span>
                  <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:unknown'</span>, <span class="sy0">...</span>
                     <span class="co2">'ignoring unknown parameter &lt;%s&gt; with value &lt;%s&gt;.'</span>, param_arg, param_value<span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">end</span>    
&nbsp;
    <span class="kw1">if</span> ~isfield<span class="br0">(</span>gsData, <span class="co2">'psFile'</span><span class="br0">)</span> 
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:noInputFile'</span>, <span class="sy0">...</span>
               <span class="co2">'No input (psfile) file specified'</span><span class="br0">)</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="kw1">if</span> ~isfield<span class="br0">(</span>gsData, <span class="co2">'pdfFile'</span><span class="br0">)</span> 
        <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:noOutputFile'</span>, <span class="sy0">...</span>
               <span class="co2">'No output (pdffile) file specified'</span><span class="br0">)</span>;
    <span class="kw1">end</span>
&nbsp;
    <span class="kw1">if</span> ~isfield<span class="br0">(</span>gsData, <span class="co2">'cmd'</span><span class="br0">)</span> 
&nbsp;
        v = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/ver.html"><span class="kw2">ver</span></a><span class="br0">(</span><span class="co2">'MATLAB'</span><span class="br0">)</span>;
        <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/str2double.html"><span class="kw2">str2double</span></a><span class="br0">(</span>v.<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/version.html"><span class="kw2">Version</span></a><span class="br0">)</span> &lt; 7.4
            <span class="br0">[</span>gsCmd, ghostDir<span class="br0">]</span> = Local_GetOldGhostscript<span class="br0">(</span><span class="br0">)</span>;
            gsData.<span class="me1">cmd</span> = gsCmd;
        <span class="kw1">else</span> 
            <span class="co1">% version 7.4 or later</span>
           <span class="co1">% the path to Ghostscript changed in 7a</span>
           ghostDir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/matlabroot.html"><span class="kw2">matlabroot</span></a>, <span class="co2">'sys'</span>, <span class="co2">'gs8x'</span> <span class="br0">)</span>;
           <span class="kw1">if</span> ~<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span>ghostDir, <span class="co2">'dir'</span><span class="br0">)</span>
              <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptCommand'</span>, <span class="sy0">...</span>
                    <span class="co2">'Can not find Ghostscript installed with MATLAB in &lt;%s&gt;'</span>,<span class="sy0">...</span>
                    <span class="me1">ghostDir</span><span class="br0">)</span>;
           <span class="kw1">end</span>
           gsData.<span class="me1">cmd</span> = Local_GetGscriptFcnHandle;
           <span class="kw1">if</span> ~isempty<span class="br0">(</span>gsData.<span class="me1">cmd</span><span class="br0">)</span>
              gsData.<span class="me1">useBuiltin</span> = <span class="nu0">1</span>; <span class="co1">% use builtin Ghostscript</span>
           <span class="kw1">end</span>
        <span class="kw1">end</span>
&nbsp;
        <span class="kw1">if</span> ~isempty<span class="br0">(</span>gsData.<span class="me1">cmd</span><span class="br0">)</span>
           <span class="co1">% if using MATLAB's version of GhostScript, use same set of fonts and library files</span>
           <span class="kw1">if</span> isfield<span class="br0">(</span>gsData, <span class="co2">'fontPath'</span><span class="br0">)</span> || isfield<span class="br0">(</span>gsData, <span class="co2">'libPath'</span><span class="br0">)</span>
              <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptPathOverride'</span>, <span class="sy0">...</span>
                    <span class="co2">'Using MATLAB'</span><span class="co2">'s version of Ghostscript; overriding '</span><span class="co2">'gsfontpath'</span><span class="co2">' and '</span><span class="co2">'gslibpath'</span><span class="co2">' to use builtin MATLAB version'</span><span class="br0">)</span>;
           <span class="kw1">end</span>
           gsData.<span class="me1">fontPath</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span> ghostDir, <span class="co2">'fonts'</span>, <span class="co2">''</span><span class="br0">)</span>;
           gsData.<span class="me1">libPath</span> = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span> ghostDir, <span class="co2">'ps_files'</span>, <span class="co2">''</span><span class="br0">)</span>;
        <span class="kw1">else</span> 
            <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:noGhostscriptCommand'</span>, <span class="sy0">...</span>
                  <span class="co2">'Can not find Ghostscript program in MATLAB'</span><span class="br0">)</span>;
        <span class="kw1">end</span>
    <span class="kw1">else</span>
        <span class="co1">% if gscommandpath was specified, </span>
        <span class="kw1">if</span> ~isfield<span class="br0">(</span>gsData, <span class="co2">'fontPath'</span><span class="br0">)</span> || ~isfield<span class="br0">(</span>gsData, <span class="co2">'libPath'</span><span class="br0">)</span>
           <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/warning.html"><span class="kw2">warning</span></a><span class="br0">(</span><span class="co2">'ps2pdf:ghostscriptCommandSuggestion'</span>, <span class="sy0">...</span>
                 <span class="br0">[</span><span class="co2">'When specifying a Ghostscript executable ('</span><span class="co2">'gscommand'</span><span class="co2">') you should also '</span><span class="sy0">...</span>
                 <span class="co2">'specify both the '</span><span class="co2">'gsfontpath'</span><span class="co2">' and '</span><span class="co2">'gslibpath'</span><span class="co2">' locations'</span><span class="br0">]</span><span class="br0">)</span>;
&nbsp;
        <span class="kw1">end</span>
    <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">%local function to create the input file needed for Ghostscript</span>
<span class="kw1">function</span> gsData = LocalCreateResponseFile<span class="br0">(</span>gsData<span class="br0">)</span> 
   <span class="co1">% open a response file to write out Ghostscript commands</span>
   rsp_file = <span class="br0">[</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/tempname.html"><span class="kw2">tempname</span></a> <span class="co2">'.rsp'</span><span class="br0">]</span>;
   rsp_fid = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fopen.html"><span class="kw2">fopen</span></a> <span class="br0">(</span>rsp_file, <span class="co2">'w'</span><span class="br0">)</span>;
&nbsp;
   <span class="kw1">if</span> <span class="br0">(</span>rsp_fid &lt; 0<span class="br0">)</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/error.html"><span class="kw2">error</span></a><span class="br0">(</span><span class="co2">'ps2pdf:responseFileCreate'</span>, <span class="co2">'Unable to create response file'</span><span class="br0">)</span>
   <span class="kw1">end</span>
&nbsp;
   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-dBATCH -dNOPAUSE\n'</span><span class="br0">)</span>;
   <span class="kw1">if</span> ~gsData.<span class="me1">verbose</span>
       <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-q\n'</span><span class="br0">)</span>;
   <span class="kw1">end</span>
   <span class="kw1">if</span> isfield<span class="br0">(</span>gsData, <span class="co2">'libPath'</span><span class="br0">)</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-I"%s"\n'</span>, gsData.<span class="me1">libPath</span><span class="br0">)</span>;
   <span class="kw1">end</span>
   <span class="kw1">if</span> isfield<span class="br0">(</span>gsData, <span class="co2">'fontPath'</span><span class="br0">)</span>
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-I"%s"\n'</span>, gsData.<span class="me1">fontPath</span><span class="br0">)</span>;
   <span class="kw1">end</span>
   <span class="kw1">if</span> isfield<span class="br0">(</span>gsData, <span class="co2">'paperSize'</span><span class="br0">)</span> 
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span> rsp_fid, <span class="co2">'-sPAPERSIZE=%s\n'</span>, gsData.<span class="me1">paperSize</span> <span class="br0">)</span>;
   <span class="kw1">end</span>
   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-sOutputFile="%s"\n'</span>, gsData.<span class="me1">pdfFile</span><span class="br0">)</span>;
   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fprintf.html"><span class="kw2">fprintf</span></a><span class="br0">(</span>rsp_fid, <span class="co2">'-sDEVICE=%s\n'</span>, <span class="co2">'pdfwrite'</span><span class="br0">)</span>;
   <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fclose.html"><span class="kw2">fclose</span></a><span class="br0">(</span>rsp_fid<span class="br0">)</span>;
   gsData.<span class="me1">responseFile</span> = rsp_file;
<span class="kw1">end</span>
&nbsp;
<span class="co1">%local function to get a handle to MATLAB's Ghostscript implementation</span>
<span class="co1">%NOTE: this may change or be removed in future releases</span>
<span class="kw1">function</span> gs = Local_GetGscriptFcnHandle<span class="br0">(</span><span class="br0">)</span>
  gs = <span class="co2">''</span>;
  p = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/which.html"><span class="kw2">which</span></a><span class="br0">(</span><span class="co2">'-all'</span>, <span class="co2">'gscript'</span><span class="br0">)</span>;
  <span class="kw1">if</span> ~isempty<span class="br0">(</span>p<span class="br0">)</span> 
      p = p<span class="br0">{</span>1<span class="br0">}</span>;
      fpath = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fileparts.html"><span class="kw2">fileparts</span></a><span class="br0">(</span>p<span class="br0">)</span>;
      olddir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>fpath<span class="br0">)</span>;
      gs = @gscript;
      <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/cd.html"><span class="kw2">cd</span></a><span class="br0">(</span>olddir<span class="br0">)</span>;
  <span class="kw1">end</span>
<span class="kw1">end</span>
&nbsp;
<span class="co1">% local function to try and get location of Ghostscript in older MATLAB</span>
<span class="kw1">function</span> <span class="br0">[</span>gsCmd, ghostDir<span class="br0">]</span> = Local_GetOldGhostscript
   ghostDir = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/matlabroot.html"><span class="kw2">matlabroot</span></a>, <span class="co2">'sys'</span>, <span class="co2">'ghostscript'</span> <span class="br0">)</span>;
   gsCmd = <span class="co2">''</span>;
   <span class="kw1">if</span> ispc
      <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>ghostDir,<span class="co2">'bin'</span>,<span class="co2">'win32'</span>,<span class="co2">'gs.exe'</span><span class="br0">)</span>, <span class="co2">'file'</span><span class="br0">)</span>
         gsCmd = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>ghostDir,<span class="co2">'bin'</span>,<span class="co2">'win32'</span>,<span class="co2">'gs.exe'</span><span class="br0">)</span>;
      <span class="kw1">end</span>
   <span class="kw1">else</span> 
      <span class="kw1">if</span> <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/exist.html"><span class="kw2">exist</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>ghostDir,<span class="co2">'bin'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/computer.html"><span class="kw2">computer</span></a><span class="br0">)</span>,<span class="co2">'gs'</span><span class="br0">)</span>, <span class="co2">'file'</span><span class="br0">)</span>
         gsCmd = <a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/fullfile.html"><span class="kw2">fullfile</span></a><span class="br0">(</span>ghostDir,<span class="co2">'bin'</span>,<a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/lower.html"><span class="kw2">lower</span></a><span class="br0">(</span><a href="http://www.mathworks.com/access/helpdesk/help/techdoc/ref/computer.html"><span class="kw2">computer</span></a><span class="br0">)</span>, <span class="co2">'gs'</span><span class="br0">)</span>;
      <span class="kw1">end</span>
   <span class="kw1">end</span>
   gsCmd = <span class="br0">[</span><span class="co2">'"'</span> gsCmd <span class="co2">'"'</span><span class="br0">]</span>;
<span class="kw1">end</span></pre>
</dd></dl>
</div>
</div>
<span id="folded_reveal" style="display:none;"><!-- reveal --></span><span id="folded_hide" style="display:none;"><!-- hide --></span><div class="secedit editbutton_section editbutton_10"><form class="button btn_secedit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="1336142573" type="hidden"><input name="summary" value="[Code Snippets] " type="hidden"><input name="target" value="section" type="hidden"><input name="range" value="188545-" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit" class="button" title="Code Snippets" type="submit"></div></form></div><div class="comment_wrapper">
  <h2><a name="discussion__section" id="discussion__section">
    Discussion
  </a></h2>
  <div class="level2 hfeed">

        <div class="comment_form">
          <form id="discussion__comment_form" method="post" action="/wiki/doku.php" accept-charset="utf-8" onsubmit="return validate(this);">
            <div class="no">
              <input name="id" value="references:batches_spm8" type="hidden">
              <input name="do" value="show" type="hidden">
              <input name="comment" value="add" type="hidden">

                      <input name="reply" value="" type="hidden">
                      <input name="user" value="ndiayek" type="hidden">
              <input name="name" value="Karim N'Diaye" type="hidden">
              <input name="mail" value="karim.ndiaye@cisa.unige.ch" type="hidden">
                      <div class="comment_text">
        Enter your comment (wiki syntax is allowed):<br>
                <textarea class="edit" name="text" cols="80" rows="10" id="discussion__comment_text" tabindex="5"></textarea>
              </div>
                      <input class="button comment_submit" name="submit" accesskey="s" value="Save" title="Save [ALt+S]" tabindex="7" type="submit">

        
              <div class="clearer"></div>

            </div>
          </form>
        </div>
          </div>
</div>

    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
        Logged in as: Karim N'Diaye (ndiayek)      </div>
      <div class="doc">
        references/batches_spm8.txt · Last modified: 2012/05/04 16:42 by fabi1007      </div>
    </div>

   
    <div class="bar" id="bar__bottom">
      <div class="bar-left" id="bar__bottomleft">
        <form class="button btn_edit" method="post" action="/wiki/doku.php"><div class="no"><input name="do" value="edit" type="hidden"><input name="rev" value="" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Edit this page" class="button" accesskey="e" title="Edit this page [E]" type="submit"></div></form>        <form class="button btn_revs" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="revisions" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Old revisions" class="button" accesskey="o" title="Old revisions [O]" type="submit"></div></form>              </div>
      <div class="bar-right" id="bar__bottomright">
                        <form class="button btn_profile" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="profile" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Update Profile" class="button" title="Update Profile" type="submit"></div></form>        <form class="button btn_logout" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="logout" type="hidden"><input name="sectok" value="a9e2e7e83b144ce5395914da51a58a90" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Logout" class="button" title="Logout" type="submit"></div></form>        <form class="button btn_index" method="get" action="/wiki/doku.php"><div class="no"><input name="do" value="index" type="hidden"><input name="id" value="references:batches_spm8" type="hidden"><input value="Sitemap" class="button" accesskey="x" title="Sitemap [X]" type="submit"></div></form>        <a class="nolink" href="#dokuwiki__top"><input class="button" value="Back to top" onclick="window.scrollTo(0, 0)" title="Back to top" type="button"></a>&nbsp;
      </div>
      <div class="clearer"></div>
    </div>

  </div>

  <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license:<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></div>
</div>

<div class="footerinc">

  <a href="http://labnic.unige.ch/wiki/feed.php" title="Recent changes RSS feed"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-rss.png" alt="Recent changes RSS feed" height="15" width="80"></a>

        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" title="CC Attribution-Noncommercial-Share Alike 3.0 Unported"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/cc-by-nc-sa.png" alt="" height="15" width="80"></a>
  
  <a href="http://www.dokuwiki.org/donate" title="Donate"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-donate.gif" alt="Donate" height="15" width="80"></a>

  <a href="http://www.php.net/" title="Powered by PHP"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-php.gif" alt="Powered by PHP" height="15" width="80"></a>

  <a href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-xhtml.png" alt="Valid XHTML 1.0" height="15" width="80"></a>

  <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-css.png" alt="Valid CSS" height="15" width="80"></a>

  <a href="http://dokuwiki.org/" title="Driven by DokuWiki"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/button-dw.png" alt="Driven by DokuWiki" height="15" width="80"></a>



</div>

<div class="no"><img src="references_batches_spm8%20%5BWikiNIC%5D_fichiers/indexer.gif" alt="" height="1" width="1"></div>


</body></html>